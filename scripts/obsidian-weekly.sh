#!/usr/bin/env bash
# obsidian-weekly â€” Generate a weekly summary note for Obsidian

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"
VAULT_DIR="${OBSIDIAN_VAULT:-$HOME/obsidian-vault}"
WEEKLY_DIR="$VAULT_DIR/Weekly"
mkdir -p "$WEEKLY_DIR"

# Determine current week (ISO week number) and date range
YEAR=$(date +%Y)
WEEK=$(date +%V)
MONDAY=$(date -d "monday this week" +%Y-%m-%d)
SUNDAY=$(date -d "sunday this week" +%Y-%m-%d)
NOTE_NAME="${YEAR}-W${WEEK} (${MONDAY} to ${SUNDAY})"
NOTE_FILE="$WEEKLY_DIR/${NOTE_NAME}.md"

# Count research and content this week
RESEARCH_COUNT=$(find research -name "*.md" -newermt "$MONDAY" ! -newermt "$(date -d "$SUNDAY +1 day" +%Y-%m-%d)" 2>/dev/null | wc -l)
CONTENT_COUNT=$(find content -name "*.md" -newermt "$MONDAY" ! -newermt "$(date -d "$SUNDAY +1 day" +%Y-%m-%d)" 2>/dev/null | wc -l)

# Top research (by filename, assuming sorted by date in name)
TOP_RESEARCH=$(ls research/*.md 2>/dev/null | tail -5 | xargs -I{} basename {} .md | sed 's/^/- [[&]]/')

# Upcoming holidays (next 14 days)
HOLIDAYS=$(./quick holidays 2>/dev/null | head -10 | sed 's/^/ - /')

cat > "$NOTE_FILE" <<EOF
# Week ${YEAR}-W${WEEK} Summary

**Period:** ${MONDAY} â€” ${SUNDAY}  
**Generated:** $(date -u '+%Y-%m-%d %H:%M UTC')

## ðŸ“Š Stats

- Research reports this week: **${RESEARCH_COUNT}**
- Content digests this week: **${CONTENT_COUNT}**
- Total disk usage: $(df -h "$VAULT_DIR" | awk 'NR==2 {print $5 " used"}')

## ðŸ“ˆ Top Recent Research

$( [ -n "$TOP_RESEARCH" ] && echo "$TOP_RESEARCH" || echo "*No research files yet*" )

## ðŸ–ï¸ Upcoming Holidays

$( [ -n "$HOLIDAYS" ] && echo "$HOLIDAYS" || echo "*No upcoming holidays*" )

## ðŸ” Quick Links

- [[Dashboard]] â€” live stats
- [[Research Index]] â€” browse all research
- [[Research Gaps]] â€” what's next

## ðŸ’­ Notes

*Add your reflections here...*

---

*Autoâ€‘generated by OpenClaw obsidianâ€‘weekly script*
EOF

echo "âœ“ Weekly summary created: $NOTE_FILE"
