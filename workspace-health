#!/usr/bin/env python3
"""
Workspace health check - one-line summary for alerts/cron
"""

import subprocess
from pathlib import Path

WORKSPACE = Path("/home/ubuntu/.openclaw/workspace")

def run_cmd(cmd):
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
        return result.stdout.strip(), result.stderr.strip(), result.returncode
    except Exception as e:
        return "", str(e), 1

def main():
    # Disk usage
    out, _, rc = run_cmd("df -h / | awk 'NR==2 {print $5}'")
    out_clean = out.rstrip('%')
    disk_pct = int(out_clean) if out_clean.isdigit() else 0
    if disk_pct >= 90:
        disk_status = f"Disk CRITICAL {disk_pct}%"
    elif disk_pct >= 80:
        disk_status = f"Disk warning {disk_pct}%"
    else:
        disk_status = f"Disk OK {disk_pct}%"

    # Updates
    out, _, rc = run_cmd("apt list --upgradable 2>/dev/null | tail -n +2 | wc -l")
    updates = int(out.strip()) if out.strip().isdigit() else 0
    updates_status = f"Updates: {updates}" if updates > 0 else "Updates: none"

    # Git status
    out, _, rc = run_cmd("git status --short")
    git_changed = len([l for l in out.splitlines() if l.strip()])
    git_status = f"Git {'dirty' if git_changed else 'clean'} ({git_changed} changed)"

    # Combine
    summary = " | ".join([disk_status, updates_status, git_status])
    print(summary)

if __name__ == "__main__":
    main()
