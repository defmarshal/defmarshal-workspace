#!/usr/bin/env python3
"""
Workspace health check - one-line summary for alerts/cron
"""

import subprocess
import json
from pathlib import Path

WORKSPACE = Path("/home/ubuntu/.openclaw/workspace")

def run_cmd(cmd):
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
        return result.stdout.strip(), result.stderr.strip(), result.returncode
    except Exception as e:
        return "", str(e), 1

def get_memory_system_status():
    """Get a concise memory system health string."""
    try:
        cmd = "openclaw memory status --json"
        out, err, rc = run_cmd(cmd)
        if rc != 0 or not out:
            return "Memory: unavailable"
        data = json.loads(out)
        if not isinstance(data, list) or len(data) == 0:
            return "Memory: unexpected status format"
        entry = data[0]
        s = entry.get("status", {})
        files = s.get("files", 0)
        chunks = s.get("chunks", 0)
        dirty = "dirty" if s.get("dirty") else "clean"
        provider = s.get("provider", "unknown")
        fts = "FTS+" if s.get("fts", {}).get("enabled") else ""
        vec = "vec+" if s.get("vector", {}).get("enabled") else ""
        features = " ".join([p for p in [fts, vec] if p])
        if features:
            return f"Memory: {files}f/{chunks}c ({dirty}) {provider} {features}"
        else:
            return f"Memory: {files}f/{chunks}c ({dirty}) {provider}"
    except Exception as e:
        return f"Memory: error"

def get_reindex_age():
    """Return age in days since last memory reindex, or None if never."""
    import time
    log_path = WORKSPACE / "memory" / "memory-reindex.log"
    if not log_path.exists():
        return None
    try:
        mtime = log_path.stat().st_mtime
        age_days = (time.time() - mtime) / 86400
        return age_days
    except Exception:
        return None

def main():
    # Disk usage
    out, _, rc = run_cmd("df -h / | awk 'NR==2 {print $5}'")
    out_clean = out.rstrip('%')
    disk_pct = int(out_clean) if out_clean.isdigit() else 0
    if disk_pct >= 90:
        disk_status = f"Disk CRITICAL {disk_pct}%"
    elif disk_pct >= 80:
        disk_status = f"Disk warning {disk_pct}%"
    else:
        disk_status = f"Disk OK {disk_pct}%"

    # Updates
    out, _, rc = run_cmd("apt list --upgradable 2>/dev/null | tail -n +2 | wc -l")
    updates = int(out.strip()) if out.strip().isdigit() else 0
    updates_status = f"Updates: {updates}" if updates > 0 else "Updates: none"

    # Git status
    out, _, rc = run_cmd("git status --short")
    git_changed = len([l for l in out.splitlines() if l.strip()])
    git_status = f"Git {'dirty' if git_changed else 'clean'} ({git_changed} changed)"

    # Memory system
    mem_status = get_memory_system_status()

    # Memory reindex age
    reindex_age = get_reindex_age()
    if reindex_age is not None:
        if reindex_age < 1:
            reindex_status = "Reindex: today"
        elif reindex_age < 7:
            reindex_status = f"Reindex: {reindex_age:.1f}d ago"
        else:
            reindex_status = f"Reindex: {reindex_age:.0f}d ago (stale)"
    else:
        reindex_status = "Reindex: never"

    # Combine (include reindex status)
    summary = " | ".join([disk_status, updates_status, git_status, mem_status, reindex_status])
    print(summary)

if __name__ == "__main__":
    main()
