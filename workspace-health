#!/usr/bin/env python3
"""
Workspace health check - one-line summary for alerts/cron
"""

import subprocess
import json
import socket
from pathlib import Path

WORKSPACE = Path("/home/ubuntu/.openclaw/workspace")

def run_cmd(cmd):
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=5)
        return result.stdout.strip(), result.stderr.strip(), result.returncode
    except Exception as e:
        return "", str(e), 1

def get_memory_system_status():
    """Get a concise memory system health string."""
    try:
        cmd = "openclaw memory status --json"
        out, err, rc = run_cmd(cmd)
        if rc != 0 or not out:
            return "Memory: unavailable"
        data = json.loads(out)
        if not isinstance(data, list) or len(data) == 0:
            return "Memory: unexpected status format"
        entry = data[0]
        s = entry.get("status", {})
        files = s.get("files", 0)
        chunks = s.get("chunks", 0)
        dirty = "dirty" if s.get("dirty") else "clean"
        provider = s.get("provider", "unknown")
        fts = "FTS+" if s.get("fts", {}).get("enabled") else ""
        vec = "vec+" if s.get("vector", {}).get("enabled") else ""
        features = " ".join([p for p in [fts, vec] if p])
        if features:
            return f"Memory: {files}f/{chunks}c ({dirty}) {provider} {features}"
        else:
            return f"Memory: {files}f/{chunks}c ({dirty}) {provider}"
    except Exception:
        return "Memory: error"

def get_reindex_age():
    """Return age in days since last memory reindex, or None if never."""
    import time
    log_path = WORKSPACE / "memory" / "memory-reindex.log"
    if not log_path.exists():
        return None
    try:
        mtime = log_path.stat().st_mtime
        age_days = (time.time() - mtime) / 86400
        return age_days
    except Exception:
        return None

def get_gateway_status():
    """Check gateway service and RPC status."""
    # Check systemd service with retry for activating state
    max_tries = 3
    service_status = "inactive"
    for attempt in range(max_tries):
        out, _, rc = run_cmd("systemctl --user is-active openclaw-gateway.service")
        out = out.strip()
        if rc == 0 and out == "active":
            service_status = "active"
            break
        elif out == "activating":
            # Transient startup state â€” retry after brief wait
            import time
            time.sleep(0.5)
            continue
        else:
            service_status = "inactive"
            break

    # Check if port is listening
    out, _, rc = run_cmd("ss -tuln | grep ':18789' | wc -l")
    port_listening = int(out.strip()) > 0 if out.strip().isdigit() else 0

    # Determine overall status
    if service_status == "active" and port_listening:
        return "Gateway: healthy"
    elif port_listening:
        return "Gateway: running (service orphaned)"
    elif service_status == "active":
        return "Gateway: service active but port not listening"
    else:
        return "Gateway: down"

def main():
    # Disk usage
    out, _, rc = run_cmd("df -h / | awk 'NR==2 {print $5}'")
    out_clean = out.rstrip('%')
    disk_pct = int(out_clean) if out_clean.isdigit() else 0
    if disk_pct >= 90:
        disk_status = f"Disk CRITICAL {disk_pct}%"
    elif disk_pct >= 80:
        disk_status = f"Disk warning {disk_pct}%"
    else:
        disk_status = f"Disk OK {disk_pct}%"

    # Updates
    out, _, rc = run_cmd("apt list --upgradable 2>/dev/null | tail -n +2 | wc -l")
    updates = int(out.strip()) if out.strip().isdigit() else 0
    updates_status = f"Updates: {updates}" if updates > 0 else "Updates: none"

    # Git status
    out, _, rc = run_cmd("git status --short")
    git_changed = len([l for l in out.splitlines() if l.strip()])
    git_status = f"Git {'dirty' if git_changed else 'clean'} ({git_changed} changed)"

    # Memory system
    mem_status = get_memory_system_status()

    # Memory reindex age
    reindex_age = get_reindex_age()
    if reindex_age is not None:
        if reindex_age < 1:
            reindex_status = "Reindex: today"
        elif reindex_age < 7:
            reindex_status = f"Reindex: {reindex_age:.1f}d ago"
        else:
            reindex_status = f"Reindex: {reindex_age:.0f}d ago (stale)"
    else:
        reindex_status = "Reindex: never"

    # Gateway status (new)
    gw_status = get_gateway_status()

    # Downloads directory size and file count
    downloads_path = WORKSPACE / "downloads"
    if downloads_path.exists():
        # Count files and total size
        try:
            import subprocess
            du_out = subprocess.run(["du", "-sh", str(downloads_path)], capture_output=True, text=True).stdout.strip()
            count_out = subprocess.run(["find", str(downloads_path), "-type", "f"], capture_output=True, text=True).stdout
            file_count = len(count_out.splitlines()) if count_out else 0
            downloads_status = f"Downloads: {file_count} files, {du_out.split()[0] if du_out else '0'}"
        except Exception:
            downloads_status = "Downloads: error"
    else:
        downloads_status = "Downloads: missing"

    # Combine (now includes gateway and downloads)
    summary = " | ".join([disk_status, updates_status, git_status, mem_status, reindex_status, gw_status, downloads_status])
    print(summary)

if __name__ == "__main__":
    main()
