#!/usr/bin/env python3
"""
Automated daily memory summarization.

Generates a concise summary of the day's memory entries by categorizing bullet points.
Appends the summary to the daily memory file.
"""

import os
import sys
import re
import argparse
from datetime import datetime
import pytz

WORKSPACE = "/home/ubuntu/.openclaw/workspace"
MEMORY_DIR = os.path.join(WORKSPACE, "memory")

# Category keyword definitions
CATEGORIES = {
    'decisions': ['decided', 'choose', 'chose', 'selected', 'opted', 'instead', 'rather', 'go with', 'abandon', 'cancel', 'reject', 'scrap', 'scrapped', 'paused', 'stopped', 'killed', 'deferred', 'postponed', 'dropped'],
    'learnings': ['learned', 'discovered', 'found', 'note', 'remember', 'fact', 'realized', 'understanding', 'insight', 'key', 'important', 'don\'t forget', 'must remember', 'should remember', 'figuring', 'figured out'],
    'tools': ['installed', 'added', 'configured', 'set up', 'skill', 'tool', 'library', 'package', 'npm', 'pip', 'apt', 'brew', 'yum', 'download', 'clone', 'git clone', 'enabled', 'disabled', 'updated', 'upgraded', 'removed', 'uninstalled'],
    'projects': ['built', 'created', 'implemented', 'developed', 'started', 'initiated', 'finished', 'completed', 'shipped', 'deployed', 'released', 'designed', 'architected', 'prototyped', 'made', 'wrote', 'coded', 'refactored', 'restructured', 'organized', 'documented', 'tested', 'fixed', 'debugged'],
    'events': ['meeting', 'call', 'appointment', 'event', 'holiday', 'birthday', 'anniversary', 'conference', 'webinar', 'session', 'run', 'test', 'demo', 'presentation', 'interview', 'deadline', 'schedule', 'planned'],
}

def get_date_str(date=None, tz_name='Asia/Bangkok'):
    """Return YYYY-MM-DD string for given datetime or today in specified timezone."""
    tz = pytz.timezone(tz_name)
    if date is None:
        date = datetime.now(tz)
    else:
        if date.tzinfo is None:
            date = tz.localize(date)
        else:
            date = date.astimezone(tz)
    return date.strftime("%Y-%m-%d")

def read_memory_file(date_str):
    path = os.path.join(MEMORY_DIR, f"{date_str}.md")
    if not os.path.exists(path):
        print(f"Error: Memory file for {date_str} not found at {path}", file=sys.stderr)
        sys.exit(1)
    with open(path, 'r') as f:
        return f.read()

def extract_bullets(content):
    """Extract bullet points from markdown content. Returns list of text (without the dash)."""
    bullets = []
    for line in content.split('\n'):
        stripped = line.strip()
        if stripped.startswith('- ') or stripped.startswith('* '):
            # Remove the leading dash/asterisk and space
            bullet_text = stripped[2:].strip()
            bullets.append(bullet_text)
    return bullets

def categorize_bullet(text):
    """Categorize a bullet text into one of the category keys."""
    text_lower = text.lower()
    for cat, keywords in CATEGORIES.items():
        if any(kw in text_lower for kw in keywords):
            return cat
    return 'other'

def generate_summary(date_str, bullets):
    """Generate markdown summary from categorized bullets."""
    # Categorize all bullets
    categorized = {cat: [] for cat in CATEGORIES.keys()}
    categorized['other'] = []
    for bullet in bullets:
        cat = categorize_bullet(bullet)
        categorized[cat].append(bullet)
    
    # Build summary markdown
    lines = []
    lines.append(f"## Daily Summary {date_str}")
    lines.append("")
    lines.append("### Overview")
    lines.append(f"- Total entries: {len(bullets)}")
    for cat in ['decisions', 'learnings', 'tools', 'projects', 'events']:
        count = len(categorized[cat])
        if count:
            lines.append(f"- {cat.capitalize()}: {count}")
    other_count = len(categorized['other'])
    if other_count:
        lines.append(f"- Other: {other_count}")
    lines.append("")
    
    # Section titles mapping
    section_titles = {
        'decisions': 'Key Decisions',
        'learnings': 'Learnings',
        'tools': 'Tools & Skills Added/Updated',
        'projects': 'Projects Progress',
        'events': 'Events & Milestones',
        'other': 'Other Notable Items'
    }
    
    for cat in ['decisions', 'learnings', 'tools', 'projects', 'events', 'other']:
        items = categorized[cat]
        if items:
            lines.append(f"### {section_titles[cat]}")
            for item in items:
                lines.append(f"- {item}")
            lines.append("")
    
    return "\n".join(lines)

def append_summary_to_file(date_str, summary):
    path = os.path.join(MEMORY_DIR, f"{date_str}.md")
    with open(path, 'a') as f:
        f.write("\n" + summary + "\n")
    return path

def main():
    parser = argparse.ArgumentParser(description='Generate daily memory summary')
    parser.add_argument('date', nargs='?', help='Date to summarize (YYYY-MM-DD). Default: today (Asia/Bangkok).')
    args = parser.parse_args()
    
    if args.date:
        try:
            date_str = args.date
            # Validate format roughly
            datetime.strptime(date_str, '%Y-%m-%d')
        except ValueError:
            print(f"Error: Invalid date format: {args.date}. Use YYYY-MM-DD.", file=sys.stderr)
            sys.exit(1)
    else:
        date_str = get_date_str()
    
    content = read_memory_file(date_str)
    bullets = extract_bullets(content)
    if not bullets:
        print(f"No bullet points found in {date_str} memory file. Nothing to summarize.", file=sys.stderr)
        # Still create a placeholder summary? No, exit.
        sys.exit(0)
    
    summary = generate_summary(date_str, bullets)
    path = append_summary_to_file(date_str, summary)
    print(f"Summary appended to {path}")
    # Also output summary to stdout
    print("\n--- Summary Preview ---\n")
    print(summary)

if __name__ == '__main__':
    main()
