#!/usr/bin/env bash
# Check if memory reindex is needed based on dirty flag and age
# Exit codes: 0 = clean/recent, 1 = dirty or stale, 2 = error

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"
cd "$WORKSPACE"

# Get memory status via openclaw
MEM_JSON=$(openclaw memory status --json 2>/dev/null || echo '[]')

if ! echo "$MEM_JSON" | python3 -c "import sys, json; json.load(sys.stdin)" >/dev/null 2>&1; then
  echo "ERROR: Unable to parse memory status"
  exit 2
fi

# Extract status
FILES=$(echo "$MEM_JSON" | python3 -c "import sys, json; data=json.load(sys.stdin); entry=data[0] if isinstance(data, list) and data else data; print(entry.get('status',{}).get('files',0))" 2>/dev/null || echo "0")
CHUNKS=$(echo "$MEM_JSON" | python3 -c "import sys, json; data=json.load(sys.stdin); entry=data[0] if isinstance(data, list) and data else data; print(entry.get('status',{}).get('chunks',0))" 2>/dev/null || echo "0")
DIRTY=$(echo "$MEM_JSON" | python3 -c "import sys, json; data=json.load(sys.stdin); entry=data[0] if isinstance(data, list) and data else data; print(str(entry.get('status',{}).get('dirty',False)).lower())" 2>/dev/null || echo "false")
PROVIDER=$(echo "$MEM_JSON" | python3 -c "import sys, json; data=json.load(sys.stdin); entry=data[0] if isinstance(data, list) and data else data; print(entry.get('status',{}).get('provider','unknown'))" 2>/dev/null || echo "unknown")

# Check reindex log age
REINDEX_AGE_DAYS=""
if [[ -f "$WORKSPACE/memory/memory-reindex.log" ]]; then
  REINDEX_AGE_DAYS=$(( ( $(date +%s) - $(stat -c %Y "$WORKSPACE/memory/memory-reindex.log") ) / 86400 ))
fi

# Check Voyage AI rate limit health (brief)
VOYAGE_WARNING=""
if [[ -f "$WORKSPACE/memory/agent-manager.log" ]]; then
  if grep -qiE '429|rate limited' "$WORKSPACE/memory/agent-manager.log" >/dev/null; then
    VOYAGE_WARNING="Recent Voyage AI rate limits detected (see voyage-status for details)"
  fi
elif [[ -f "$WORKSPACE/memory/memory-reindex.log" ]]; then
  if grep -qiE '429|rate limited' "$WORKSPACE/memory/memory-reindex.log" >/dev/null; then
    VOYAGE_WARNING="Recent Voyage AI rate limits detected (see voyage-status for details)"
  fi
fi

# Determine if recent rate limit (within last hour) to avoid hammering
RATE_LIMIT_RECENT=0
# Check logs for rate limit in last 3600 seconds
now=$(date +%s)
for logfile in "$WORKSPACE/memory/agent-manager.log" "$WORKSPACE/memory/memory-reindex.log" "$WORKSPACE/memory/meta-agent.log"; do
  if [ -f "$logfile" ]; then
    # Get lines with 429 or rate limited in last hour
    if grep -qiE '429|rate limited' "$logfile" 2>/dev/null | while IFS= read -r line; do
      # Extract timestamp from log line if possible (assuming ISO-like format at start)
      # Try to parse common log timestamp patterns
      # Our logs often start with "YYYY-MM-DD HH:MM:SS" or "YYYY-MM-DDTHH:MM:SS"
      ts=$(echo "$line" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}[-T ][0-9]{2}:[0-9]{2}:[0-9]{2}' | head -1)
      if [ -n "$ts" ]; then
        # Convert to timestamp
        ts_epoch=$(date -d "$ts" +%s 2>/dev/null || echo 0)
        if [ $((now - ts_epoch)) -lt 3600 ]; then
          RATE_LIMIT_RECENT=1
          break 2
        fi
      else
        # Fallback: if log file modified within last hour and contains rate limit, consider recent
        mtime=$(stat -c %Y "$logfile" 2>/dev/null || echo 0)
        if [ $((now - mtime)) -lt 3600 ]; then
          # If the log itself is recent and contains rate limit, likely recent
          RATE_LIMIT_RECENT=1
          break
        fi
      fi
    done; then
      true # found
    fi
  fi
done

# Determine if action needed
NEEDS_REINDEX=0
REASON=""

if [[ "$DIRTY" == "true" ]]; then
  NEEDS_REINDEX=1
  REASON="Memory index is dirty (changes pending)"
elif [[ -n "$REINDEX_AGE_DAYS" && $REINDEX_AGE_DAYS -ge 7 ]]; then
  NEEDS_REINDEX=1
  REASON="Last reindex was $REINDEX_AGE_DAYS days ago (stale)"
fi

# If recent rate limit, defer reindex even if needed
if [[ $RATE_LIMIT_RECENT -eq 1 && $NEEDS_REINDEX -eq 1 ]]; then
  NEEDS_REINDEX=0
  REASON="Rate limited recently; reindex deferred"
fi

# Output
echo "Memory System Check"
echo "-------------------"
echo "Provider: $PROVIDER"
echo "Files: $FILES | Chunks: $CHUNKS"
echo "Dirty: $DIRTY"
if [[ -n "$REINDEX_AGE_DAYS" ]]; then
  echo "Last reindex: $REINDEX_AGE_DAYS day(s) ago"
else
  echo "Last reindex: never"
fi
if [[ -n "$VOYAGE_WARNING" ]]; then
  echo "Voyage: ⚠️ $VOYAGE_WARNING"
fi
echo ""

if [[ $NEEDS_REINDEX -eq 1 ]]; then
  echo "Status: REINDEX RECOMMENDED"
  echo "Reason: $REASON"
  echo ""
  echo "Run: quick memory-reindex"
  exit 1
else
  echo "Status: OK (no reindex needed)"
  if [[ $RATE_LIMIT_RECENT -eq 1 ]]; then
    echo "Note: Reindex deferred due to recent rate limits."
  fi
  exit 0
fi
