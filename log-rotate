#!/usr/bin/env bash
# Log rotation for important workspace logs
# Rotates logs when size exceeds threshold, keeps up to 4 compressed archives.
# Configurable per-log via environment variables or defaults.

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"
cd "$WORKSPACE"

# Log definitions: name: (pattern, max_size_bytes)
LOGS=(
  "aria2.log:100000000"          # 100 MB
  "memory-reindex.log:50000000"  # 50 MB
  "dev-agent.log:50000000"       # 50 MB
  "content-agent.log:50000000"   # 50 MB
  "research-agent.log:50000000"  # 50 MB
  "workspace-builder.log:50000000"  # 50 MB
  "email-cleaner-cron.log:20000000" # 20 MB
  "auto-torrent.log:30000000"    # 30 MB
  "content-index-cron.log:20000000" # 20 MB
)

rotate_log() {
  local logfile="$1"
  local max_size="$2"

  if [[ ! -f "$logfile" ]]; then
    echo "Skipping $logfile (not found)"
    return 0
  fi

  local size
  size=$(stat -c%s "$logfile" 2>/dev/null || echo 0)

  if (( size <= max_size )); then
    # echo "OK: $logfile size ($size bytes) below threshold ($max_size bytes)"
    return 0
  fi

  echo "Rotating $logfile (size: $size bytes, threshold: $max_size bytes)..."

  # Remove oldest archive
  if [[ -f "${logfile}.4.gz" ]]; then
    rm -f "${logfile}.4.gz"
  fi

  # Shift archives
  if [[ -f "${logfile}.3.gz" ]]; then
    mv "${logfile}.3.gz" "${logfile}.4.gz"
  fi
  if [[ -f "${logfile}.2.gz" ]]; then
    mv "${logfile}.2.gz" "${logfile}.3.gz"
  fi
  if [[ -f "${logfile}.1.gz" ]]; then
    mv "${logfile}.1.gz" "${logfile}.2.gz"
  fi

  # Compress current log to .1.gz
  gzip -c "$logfile" > "${logfile}.1.gz"

  # Truncate original log
  : > "$logfile"

  echo "  â†’ Rotated $logfile"
}

echo "== Log Rotation $(date -Iseconds) =="
for entry in "${LOGS[@]}"; do
  IFS=':' read -r logfile max_size <<< "$entry"
  rotate_log "$logfile" "$max_size"
done

echo "Rotation complete."
echo "Archives present:"
ls -1h *.gz 2>/dev/null | sed 's/^/  /' || echo "  (none)"