#!/usr/bin/env bash
# Quick launcher for common workspace utilities
# Usage: quick <command> [args...]

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"

show_help() {
  cat <<EOF
Quick workspace utility launcher

Commands:
  dash            Run the CLI dashboard (dashboard.py)
  web             Run the web dashboard (web-dashboard.py)
  mem             Show recent memories (claw memory list)
  search <query>  Search memories (claw memory search)
  memory-status  Show memory index status (openclaw memory status)
  memory-index  Reindex memory files (openclaw memory index)
  memory-stats  Show detailed memory system statistics (files, chunks, cache, FTS, etc.)
  health          Show workspace health summary (workspace-health)
  holidays        Show upcoming Indonesian holidays (show-holidays)
  git-status      Show brief git status
  git-today       Show git commits from today (since midnight)
  anime <cmd>     Anime companion: search, info, top, season, upcoming
                  Example: quick anime search "frieren" [--tts]
  selfie [caption] [rating]  Send a random anime image via Nekos API.
                  rating: safe (default) or explicit. Caption optional.
  selfie-batch <count> [rating] [caption]  Fetch multiple anime images (1-20) and
                  send as a single zip file. Default count=5, rating=safe.
  torrent-add <magnet_or_file> [rpc_secret]  Add a magnet link or .torrent file to
                  the aria2 downloader. RPC secret defaults to 'openclaw_secret_123'.
                  Example: quick torrent-add "magnet:?xt=urn:btih:..."
                  Example: quick torrent-add "/path/to/file.torrent" "my_secret"
  nyaa-search <query> [--limit N] [--category cat]  Search Sukebei.Nyaa.si for
                  torrents. Categories: all, anime (default), anime_raw, anime_non_translated,
                  audio, lit, pics, software. Outputs JSON to stdout.
  nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]  Show top torrents sorted
                  by seed count. Options:
                  --max-size SIZE: filter by max size (e.g., 1G, 500M)
                  --pick N: non-interactive pick of Nth torrent (1-indexed)
                  --select: interactive pick by number (terminal only)
                  --add: after pick, send magnet to aria2 automatically.
  log <category> "<message>"  Log an event to openclaw-memory (category: decision, learning, event, note, etc.)
  email-clean [options]      Auto-clean Gmail: archive promotional emails and apply labels.
                              Options: --execute (apply changes), --max N, --query "gmail query"
                              Rules: archives CATEGORY_PROMOTIONS/UPDATES, spammy keywords/senders,
                                    and labels messages containing keywords like "welcome" with configurable labels.
  agents [flags]               List running sessions/agents; flags passed to `openclaw sessions` (e.g., --json, --help)
  downloads [--json] [--watch SECS]  Show aria2 download progress (active downloads). Use --watch to auto-refresh.
  content-latest              Show the latest content digest/note from content/ directory.
  content-index-update        Regenerate content/INDEX.md to reflect current content files.
  research-watchlist          Show the latest research planning watchlist (research/watchlist-*.md)
  sudo-check                  Check if passwordless sudo is configured (runs 'sudo -n true')
  agent-logs [name]           Show recent logs for an agent (dev, content, research, builder). Default: all.
  cron-status                 Show status of important cron jobs (email-cleaner, torrent auto-download, etc.)
  setup-all                   Run all setup scripts (sudo, torrent cron) in order. Use with care.
  help                       Show this help message

Examples:
  quick dash
  quick search "project"
  quick health
  quick anime info 52991 --tts
EOF
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  dash|dashboard)
    python3 "$WORKSPACE/dashboard.py"
    ;;
  web)
    python3 "$WORKSPACE/web-dashboard.py"
    ;;
  mem|memory)
    # Human-friendly output when in terminal, JSON when piped
    if [ -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json | \
        jq -r '.results[:20] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    else
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json
    fi
    ;;
  search)
    # Combine all arguments into a single query string
    query="$*"
    if [ -z "$query" ]; then
      echo "Error: search requires a query string" >&2
      echo "Usage: quick search <query> [--json]" >&2
      exit 1
    fi
    shift || true
    # Detect optional --json flag (must be last)
    RAW_JSON=0
    for arg in "$@"; do
      if [ "$arg" = "--json" ]; then
        RAW_JSON=1
      fi
    done
    if [ $RAW_JSON -eq 1 ] || [ ! -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json
    else
      /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json | jq -r '.results[:10] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    fi
    ;;
  memory-status)
    # Show memory search index status
    /home/ubuntu/.npm-global/bin/openclaw memory status
    ;;
  memory-index)
    # Reindex memory files
    echo "Reindexing memory..."
    /home/ubuntu/.npm-global/bin/openclaw memory index
    ;;
  memory-stats)
    # Show memory system statistics (wrapper around memory-stats script)
    "$WORKSPACE/memory-stats" "$@"
    ;;
  health)
    python3 "$WORKSPACE/workspace-health.py" 2>/dev/null || "$WORKSPACE/workspace-health"
    ;;
  holidays)
    python3 "$WORKSPACE/show-holidays" 2>/dev/null || "$WORKSPACE/show-holidays"
    ;;
  git-status)
    git -C "$WORKSPACE" status --short
    ;;
  git-today)
    git -C "$WORKSPACE" log --since="midnight" --oneline || echo "No commits today"
    ;;
  anime)
    "$WORKSPACE/anime-companion" "$@"
    ;;
  selfie)
    # Send a random anime image via Nekos API
    # Usage: quick selfie [caption] [rating]
    # Rating: safe (default) or explicit
    caption="${1:-}"
    rating="${2:-safe}"
    if [ "$rating" != "safe" ] && [ "$rating" != "explicit" ]; then
      echo "Error: rating must be 'safe' or 'explicit'" >&2
      exit 1
    fi
    # Use credentials from environment or openclaw.json (already set by gateway)
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie.sh" "$caption" "$rating"
    ;;
  selfie-batch)
    # Send multiple anime images as a zip via Nekos API
    # Usage: quick selfie-batch <count> [rating] [caption]
    # count: 1-20 (default: 5)
    # rating: safe (default) or explicit
    count="${1:-5}"
    rating="${2:-safe}"
    shift 2 || true
    caption="${*:-}"
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie-batch.sh" "$count" "$rating" "$caption"
    ;;
  torrent-add)
    # Add magnet or torrent file to aria2
    # Usage: quick torrent-add <magnet_or_file> [rpc_secret]
    "$WORKSPACE/torrent-add" "$@"
    ;;
  nyaa-search)
    # Search Sukebei.Nyaa.si for torrents
    # Usage: quick nyaa-search <query> [--limit N] [--category anime|all|...]
    # Example: quick nyaa-search "ubuntu 24.04" --limit 5
    python3 "$WORKSPACE/nyaa-search" "$@"
    ;;
  nyaa-top)
    # Show top torrents sorted by seeds (Sukebei.Nyaa.si)
    # Usage: quick nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]
    python3 "$WORKSPACE/nyaa-top" "$@"
    ;;
  log)
    "$WORKSPACE/log-event" "$@"
    ;;
  email-clean)
    python3 "$WORKSPACE/email-cleaner.py" "$@"
    ;;
  agents)
    # List running sessions/agents; pass through flags
    if [ $# -eq 0 ] && [ ! -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw sessions --json
    else
      /home/ubuntu/.npm-global/bin/openclaw sessions "$@"
    fi
    ;;
  downloads)
    # Show aria2 download progress (uses RPC)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  content-latest)
    # Show the latest content digest/note (excluding INDEX.md)
    latest=$(ls -t content/*.md 2>/dev/null | grep -v 'INDEX.md' | head -1)
    if [ -z "$latest" ]; then
      echo "No content files found in content/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  content-index-update)
    # Regenerate content/INDEX.md to reflect current content files
    "$WORKSPACE/update-content-index.sh"
    ;;
  research-watchlist)
    # Show the latest research watchlist file
    latest=$(ls -t research/watchlist-*.md 2>/dev/null | head -1)
    if [ -z "$latest" ]; then
      echo "No research watchlist files found in research/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  sudo-check)
    # Check if passwordless sudo is configured
    if sudo -n true 2>/dev/null; then
      echo "✓ Passwordless sudo is working! You can use elevated: true in exec commands."
      echo "Privileges:"
      sudo -l | head -5
    else
      echo "✗ Passwordless sudo NOT configured."
      echo "Run './setup-sudo.sh' (with sudo) to set it up."
      exit 1
    fi
    ;;
  agent-logs)
    # Show recent logs for background agents
    agent_name="${1:-all}"
    case "$agent_name" in
      dev|dev-agent)
        tail -n 20 "$WORKSPACE/dev-agent.log" || echo "No dev-agent.log found"
        ;;
      content|content-agent)
        tail -n 20 "$WORKSPACE/content-agent.log" || echo "No content-agent.log found"
        ;;
      research|research-agent)
        tail -n 20 "$WORKSPACE/research-agent.log" || echo "No research-agent.log found"
        ;;
      builder|workspace-builder)
        tail -n 20 "$WORKSPACE/workspace-builder.log" 2>/dev/null || echo "No workspace-builder.log found"
        ;;
      all)
        echo "== DEV-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/dev-agent.log" 2>/dev/null || echo "No dev-agent.log"
        echo -e "\n== CONTENT-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/content-agent.log" 2>/dev/null || echo "No content-agent.log"
        echo -e "\n== RESEARCH-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/research-agent.log" 2>/dev/null || echo "No research-agent.log"
        ;;
      *)
        echo "Usage: quick agent-logs [dev|content|research|builder|all]" >&2
        exit 1
        ;;
    esac
    ;;
  cron-status)
    # Show status of important cron jobs
    echo "== System Cron (user crontab) =="
    crontab -l 2>/dev/null | grep -E 'email-clean|nyaa-top|traffic' || echo "No matching cron entries found"
    echo ""
    echo "== OpenClaw Cron (via openclaw cron) =="
    /home/ubuntu/.npm-global/bin/openclaw cron list --json 2>/dev/null | python3 -m json.tool 2>/dev/null || echo "Unable to list OpenClaw cron jobs"
    ;;
  setup-all)
    # Run non-interactive setup scripts
    echo "== Running setup scripts (non-interactive) =="
    # List of scripts that can be run without manual intervention or sudo
    scripts=(
      "setup-torrent-cron.sh"
    )
    for script in "${scripts[@]}"; do
      if [ -f "$WORKSPACE/$script" ]; then
        echo "→ Running $script..."
        bash "$WORKSPACE/$script" || echo "  ⚠ $script failed with exit $?"
      else
        echo "  ⊘ $script not found"
      fi
    done
    echo "== Setup complete =="
    echo "Note: For sudo setup, run: sudo ./setup-sudo.sh"
    echo "Remember to commit any changes and push to GitHub."
    ;;
  help)
    show_help
    ;;
  *)
    echo "Error: Unknown command '$cmd'" >&2
    echo "Run 'quick help' for available commands." >&2
    exit 1
    ;;
esac
