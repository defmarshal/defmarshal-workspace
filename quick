#!/usr/bin/env bash
# Quick launcher for common workspace utilities
# Usage: quick <command> [args...]

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"

show_help() {
  cat <<EOF
Quick workspace utility launcher

Commands:
  dash            Run the CLI dashboard (dashboard.py)
  web             Run the web dashboard (web-dashboard.py)
  gateway-info    Show gateway status and remote access setup instructions
  gateway-watchdog		Show gateway watchdog log (last 20 lines)
  hygiene         Run workspace hygiene check (CRLF, exec bits, large files, caches)
  mem             Show recent memories (claw memory list)
  search <query>  Search memories (claw memory search)
  memory-status  Show memory index status (openclaw memory status)
  memory-index  Reindex memory files (openclaw memory index)
  memory-stats  Show detailed memory system statistics (files, chunks, cache, FTS, etc.)
  memory-reindex-check  Check if memory reindex is needed based on dirty flag and age. Exit 0 if ok, 1 if reindex recommended
  memory-reindex Force reindex of memory files (openclaw memory index)
  daemons        Show status of persistent background agents (dev, content, research, torrent-bot)
  quiet-hours    Show current quiet hours status (Asia/Bangkok 23:00–08:00) and whether system is in quiet mode
  health          Show workspace health summary (workspace-health)
  holidays        Show upcoming Indonesian holidays (show-holidays)
  time            Show current time in UTC and Bangkok (Asia/Bangkok)
  weather [loc]   Get current weather (default: Bangkok) via wttr.in
  git-status      Show brief git status
  git-today       Show git commits from today (since midnight)
  git-summary     Show recent commit summary by prefix (dev:, research:, content:, infra:, chore:)
  anime <cmd>     Anime companion: search, info, top, season, upcoming
                  Example: quick anime search "frieren" [--tts]
  selfie [caption] [rating]  Send a random anime image via Nekos API.
                  rating: safe (default) or explicit. Caption optional.
  selfie-batch <count> [rating] [caption]  Fetch multiple anime images (1-20) and
                  send as a single zip file. Default count=5, rating=safe.
  torrent-add <magnet_or_file> [rpc_secret]  Add a magnet link or .torrent file to
                  the aria2 downloader. RPC secret defaults to 'openclaw_secret_123'.
                  Example: quick torrent-add "magnet:?xt=urn:btih:..."
                  Example: quick torrent-add "/path/to/file.torrent" "my_secret"
  torrent-status [--json] [--watch SECS]  Show aria2 download progress (alias for downloads). Use --watch to auto-refresh.
  nyaa-search <query> [--limit N] [--category cat]  Search Sukebei.Nyaa.si for
                  torrents. Categories: all, anime (default), anime_raw, anime_non_translated,
                  audio, lit, pics, software. Outputs JSON to stdout.
  nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]  Show top torrents sorted
                  by seed count. Options:
                  --max-size SIZE: filter by max size (e.g., 1G, 500M)
                  --pick N: non-interactive pick of Nth torrent (1-indexed)
                  --select: interactive pick by number (terminal only)
                  --add: after pick, send magnet to aria2 automatically.
  log <category> "<message>"  Log an event to openclaw-memory (category: decision, learning, event, note, etc.)
  email-clean [options]      Auto-clean Gmail: archive promotional emails and apply labels.
                              Options: --execute (apply changes), --max N, --query "gmail query"
                              Rules: archives CATEGORY_PROMOTIONS/UPDATES, spammy keywords/senders,
                                    and labels messages containing keywords like "welcome" with configurable labels.
  agents [flags]               List running sessions/agents; flags passed to `openclaw sessions` (e.g., --json, --help)
  downloads [--json] [--watch SECS]  Show aria2 download progress (active downloads). Use --watch to auto-refresh.
  content-latest              Show the latest content digest/note from content/ directory.
  content-index-update        Regenerate content/INDEX.md to reflect current content files.
  research-watchlist          Show the latest research planning watchlist (research/watchlist-*.md)
  social-monitor                  Run the social monitor agent (Twitter trending digest)
  sudo-check                  Check if passwordless sudo is configured (runs 'sudo -n true')
  log-rotate                  Rotate aria2.log if >100MB, keep up to 4 compressed archives
  updates-check                Check for pending system updates (APT)
  updates-apply [--dry-run|--execute] Apply system updates (dry-run by default; use --execute to actually upgrade)
  cleanup-downloads [options] Clean up old downloads (default: dry-run, retains 30 days)
                             Options: --days N, --execute, --verbose
                              Example: quick cleanup-downloads --days 60 --execute
  cleanup-backups [options]   Clean up old openclaw-backup tarballs in /home/ubuntu (default: dry-run, keep 1)
                             Options: --keep N, --execute, --verbose
                              Example: quick cleanup-backups --keep 3 --execute
  agent-logs [name]           Show recent logs for an agent (dev, content, research, builder). Default: all.
  cleanup-agent-artifacts [options]  Clean up stale agent artifacts (lock files, empty plans). Respects quiet hours.
                                  Options: --execute (actually delete), --force (run during quiet hours)
  cron              List OpenClaw cron jobs (concise summary)
  cron-status                 Show status of important cron jobs (email-cleaner, torrent auto-download, etc.)
  restart-gateway             Restart the OpenClaw gateway (use after config changes or to restore approval buttons)
  gateway-status              Show detailed gateway status (service, port, RPC)
  gateway-fix                 Fix gateway issues (stop stray processes, restart cleanly)
  validate                    Run comprehensive validation (health, memory, agents, git, cron, logs)
  status                      Show concise one‑line system summary (local only, no approvals)
  verify                      Run comprehensive workspace verification (health, memory, agents, git, cron)
  setup-all                   Run all setup scripts (sudo, torrent cron) in order. Use with care.
  help                       Show this help message

Examples:
  quick dash
  quick search "project"
  quick health
  quick anime info 52991 --tts
EOF
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  dash|dashboard)
    python3 "$WORKSPACE/dashboard.py"
    ;;
  web)
    python3 "$WORKSPACE/web-dashboard.py"
    ;;
  mem|memory)
    # Human-friendly output when in terminal, JSON when piped
    if [ -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json | \
        jq -r '.results[:20] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    else
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json
    fi
    ;;
  search)
    # Combine all arguments into a single query string
    query="$*"
    if [ -z "$query" ]; then
      echo "Error: search requires a query string" >&2
      echo "Usage: quick search <query> [--json]" >&2
      exit 1
    fi
    shift || true
    # Detect optional --json flag (must be last)
    RAW_JSON=0
    for arg in "$@"; do
      if [ "$arg" = "--json" ]; then
        RAW_JSON=1
      fi
    done
    if [ $RAW_JSON -eq 1 ] || [ ! -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json
    else
      /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json | jq -r '.results[:10] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    fi
    ;;
  memory-status)
    # Show memory search index status
    /home/ubuntu/.npm-global/bin/openclaw memory status
    ;;
  memory-index)
    # Reindex memory files
    echo "Reindexing memory..."
    /home/ubuntu/.npm-global/bin/openclaw memory index
    ;;
  memory-reindex)
    # Alias for memory-index (consistency)
    echo "Reindexing memory..."
    /home/ubuntu/.npm-global/bin/openclaw memory index
    ;;
  memory-reindex-check)
    # Check if memory reindex is needed
    "$WORKSPACE/memory-reindex-check"
    ;;
  memory-stats)
    # Show memory system statistics (wrapper around memory-stats script)
    "$WORKSPACE/memory-stats" "$@"
    ;;
  daemons)
    # Show status of persistent background agents
    echo "Persistent Daemons:"
    echo "-------------------"
    for name in dev-agent content-agent research-agent torrent-bot; do
      pid=$(pgrep -f "$name" || true)
      if [ -n "$pid" ]; then
        uptime=$(ps -o etime= -p "$pid" 2>/dev/null | tr -d ' ')
        echo "  ✓ $name  PID:$pid  uptime:$uptime"
      else
        echo "  ✗ $name  NOT RUNNING"
      fi
    done
    ;;
  quiet-hours)
    # Show current quiet hours status and next transitions
    echo "Quiet Hours (Asia/Bangkok): 23:00–08:00"
    echo "Current time (Bangkok): $(TZ='Asia/Bangkok' date '+%H:%M')"
    H=$(TZ='Asia/Bangkok' date +%H)
    if (( 23 <= H || H < 8 )); then
      echo "Status: QUIET (night window active)"
    else
      echo "Status: ACTIVE (daytime)"
    fi
    ;;
  health)
    "$WORKSPACE/workspace-health"
    ;;
  holidays)
    python3 "$WORKSPACE/show-holidays" 2>/dev/null || "$WORKSPACE/show-holidays"
    ;;
  time)
    # Show current time in UTC and Asia/Bangkok
    echo "UTC:       $(TZ='UTC' date '+%Y-%m-%d %H:%M:%S %Z')"
    echo "Bangkok:  $(TZ='Asia/Bangkok' date '+%Y-%m-%d %H:%M:%S %Z')"
    ;;
  weather)
    # Get current weather for a location (default: Bangkok)
    # Uses wttr.in (no API key required); 5s timeout to avoid hangs
    loc="${1:-Bangkok}"
    if timeout 5 curl -s "wttr.in/${loc}?format=3"; then
      true
    else
      echo "Weather fetch failed or timed out" >&2
      exit 1
    fi
    ;;
  git-status)
    git -C "$WORKSPACE" status --short
    ;;
  git-today)
    git -C "$WORKSPACE" log --since="midnight" --oneline || echo "No commits today"
    ;;
  git-summary)
    # Show recent commit summary by prefix (dev:, research:, content:, infra:, chore:)
    git -C "$WORKSPACE" log --oneline | head -20 | sed -E 's/^([a-f0-9]+) ([^:]+):?/\2/' | sort | uniq -c | sort -nr || echo "No commits"
    ;;
  anime)
    "$WORKSPACE/anime-companion" "$@"
    ;;
  selfie)
    # Send a random anime image via Nekos API
    # Usage: quick selfie [caption] [rating]
    # Rating: safe (default) or explicit
    caption="${1:-}"
    rating="${2:-safe}"
    if [ "$rating" != "safe" ] && [ "$rating" != "explicit" ]; then
      echo "Error: rating must be 'safe' or 'explicit'" >&2
      exit 1
    fi
    # Use credentials from environment or openclaw.json (already set by gateway)
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie.sh" "$caption" "$rating"
    ;;
  selfie-batch)
    # Send multiple anime images as a zip via Nekos API
    # Usage: quick selfie-batch <count> [rating] [caption]
    # count: 1-20 (default: 5)
    # rating: safe (default) or explicit
    count="${1:-5}"
    rating="${2:-safe}"
    shift 2 || true
    caption="${*:-}"
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie-batch.sh" "$count" "$rating" "$caption"
    ;;
  torrent-add)
    # Add magnet or torrent file to aria2
    # Usage: quick torrent-add <magnet_or_file> [rpc_secret]
    "$WORKSPACE/torrent-add" "$@"
    ;;
  torrent-status)
    # Show current torrent download status (alias for downloads)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  nyaa-search)
    # Search Sukebei.Nyaa.si for torrents
    # Usage: quick nyaa-search <query> [--limit N] [--category anime|all|...]
    # Example: quick nyaa-search "ubuntu 24.04" --limit 5
    python3 "$WORKSPACE/nyaa-search" "$@"
    ;;
  nyaa-top)
    # Show top torrents sorted by seeds (Sukebei.Nyaa.si)
    # Usage: quick nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]
    python3 "$WORKSPACE/nyaa-top" "$@"
    ;;
  log)
    "$WORKSPACE/log-event" "$@"
    ;;
  log-rotate)
    "$WORKSPACE/log-rotate"
    ;;

  updates-check)
    "$WORKSPACE/scripts/updates-check.sh" "$@"
    ;;

  updates-apply)
    "$WORKSPACE/scripts/updates-apply.sh" "$@"
    ;;
  cleanup-downloads)
    # Clean up old downloads with retention policy
    "$WORKSPACE/scripts/cleanup-downloads.sh" "$@"
    ;;
  cleanup-backups)
    # Clean up old backup tarballs in /home/ubuntu
    "$WORKSPACE/scripts/cleanup-backups.sh" "$@"
    ;;
  email-clean)
    python3 "$WORKSPACE/email-cleaner.py" "$@"
    ;;
  agents)
    # List running sessions/agents; pass through flags
    if [ $# -eq 0 ] && [ ! -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw sessions --json
    else
      /home/ubuntu/.npm-global/bin/openclaw sessions "$@"
    fi
    ;;
  downloads)
    # Show aria2 download progress (uses RPC)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  torrent-status)
    # Alias for downloads (local, no approval needed)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  content-latest)
    # Show the latest content digest/note (excluding INDEX.md)
    latest=$(ls -t content/*.md 2>/dev/null | grep -v 'INDEX.md' | head -1)
    if [ -z "$latest" ]; then
      echo "No content files found in content/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  content-index-update)
    # Regenerate content/INDEX.md to reflect current content files
    "$WORKSPACE/update-content-index.sh"
    ;;
  research-watchlist)
    # Show the latest research watchlist file
    latest=$(ls -t research/watchlist-*.md 2>/dev/null | head -1)
    if [ -z "$latest" ]; then
      echo "No research watchlist files found in research/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  social-monitor)
    # Run the social monitor agent (Twitter trending digest)
    bash "$WORKSPACE/social-monitor-agent.sh"
    ;;
  sudo-check)
    # Check if passwordless sudo is configured
    if sudo -n true 2>/dev/null; then
      echo "✓ Passwordless sudo is working! You can use elevated: true in exec commands."
      echo "Privileges:"
      sudo -l | head -5
    else
      echo "✗ Passwordless sudo NOT configured."
      echo "Run './setup-sudo.sh' (with sudo) to set it up."
      exit 1
    fi
    ;;
  agent-logs)
    # Show recent logs for background agents
    agent_name="${1:-all}"
    case "$agent_name" in
      dev|dev-agent)
        tail -n 20 "$WORKSPACE/dev-agent.log" || echo "No dev-agent.log found"
        ;;
      content|content-agent)
        tail -n 20 "$WORKSPACE/content-agent.log" || echo "No content-agent.log found"
        ;;
      research|research-agent)
        tail -n 20 "$WORKSPACE/research-agent.log" || echo "No research-agent.log found"
        ;;
      builder|workspace-builder)
        tail -n 20 "$WORKSPACE/workspace-builder.log" 2>/dev/null || echo "No workspace-builder.log found"
        ;;
      all)
        echo "== DEV-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/dev-agent.log" 2>/dev/null || echo "No dev-agent.log"
        echo -e "\n== CONTENT-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/content-agent.log" 2>/dev/null || echo "No content-agent.log"
        echo -e "\n== RESEARCH-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/research-agent.log" 2>/dev/null || echo "No research-agent.log"
        ;;
      *)
        echo "Usage: quick agent-logs [dev|content|research|builder|all]" >&2
        exit 1
        ;;
    esac
    ;;
  cleanup-agent-artifacts)
    "$WORKSPACE/cleanup-agent-artifacts.sh" "$@"
    ;;
  gateway-info)
    "$WORKSPACE/gateway-info.sh"
    ;;
  gateway-watchdog)
    tail -n 20 "$WORKSPACE/gateway-watchdog.log" 2>/dev/null || echo "No watchdog log yet."
    ;;
  hygiene)
    "$WORKSPACE/workspace-hygiene-check.sh"
    ;;
  cron)
    openclaw cron list --json | jq -r '.jobs[] | "\(.schedule.kind) \(.schedule.expr // "\(.schedule.everyMs)ms") \(.payload.kind) \(.sessionTarget)"' 2>/dev/null || openclaw cron list
    ;;
  cron-status)
    # Show status of important cron jobs
    echo "== System Cron (user crontab) =="
    crontab -l 2>/dev/null | grep -E 'email-clean|nyaa-top|traffic' || echo "No matching cron entries found"
    echo ""
    echo "== OpenClaw Cron (via openclaw cron) =="
    /home/ubuntu/.npm-global/bin/openclaw cron list --json 2>/dev/null | python3 -m json.tool 2>/dev/null || echo "Unable to list OpenClaw cron jobs"
    ;;
  setup-all)
    # Run non-interactive setup scripts
    echo "== Running setup scripts (non-interactive) =="
    # List of scripts that can be run without manual intervention or sudo
    scripts=(
      "setup-torrent-cron.sh"
    )
    for script in "${scripts[@]}"; do
      if [ -f "$WORKSPACE/$script" ]; then
        echo "→ Running $script..."
        bash "$WORKSPACE/$script" || echo "  ⚠ $script failed with exit $?"
      else
        echo "  ⊘ $script not found"
      fi
    done
    echo "== Setup complete =="
    echo "Note: For sudo setup, run: sudo ./setup-sudo.sh"
    echo "Remember to commit any changes and push to GitHub."
    ;;
  restart-gateway)
    echo "Restarting OpenClaw gateway..."
    openclaw gateway restart
    ;;
  gateway-status)
    # Detailed gateway status: systemd service, port listening, RPC probe
    echo "=== Gateway Status ==="
    # Service
    if systemctl --user is-active openclaw-gateway.service >/dev/null 2>&1; then
      echo "  Service: active"
    else
      echo "  Service: inactive"
    fi
    # Port
    if ss -tuln | grep -q ':18789 '; then
      echo "  Port 18789: listening"
    else
      echo "  Port 18789: not listening"
    fi
    # RPC probe
    echo -n "  RPC: "
    if timeout 3 openclaw gateway probe >/dev/null 2>&1; then
      echo "reachable"
    else
      echo "unreachable"
    fi
    ;;
  gateway-fix)
    # Run the gateway fix script
    bash "$WORKSPACE/gateway-fix.sh"
    ;;
  status)
    # Concise one‑line system summary (local only)
    disk=$(df -h / | awk 'NR==2 {print $5}')
    load=$(uptime | awk -F"load average: " '{print $2}')
    mem=$(free -h | awk '/^Mem:/ {print $7 "/" $2}')
    gw=$(systemctl --user is-active openclaw-gateway.service 2>/dev/null || echo "inactive")
    agents=$(pgrep -f "agent-loop.sh" | wc -l)
    echo "Disk: ${disk} used | Load: ${load} | Mem: ${mem} | Gateway: ${gw} | Agents: ${agents}"
    ;;
  verify)
    # Comprehensive workspace verification
    echo "=== Workspace Verification ==="
    echo ""
    echo "Health:"
    "$WORKSPACE/workspace-health" || echo "  ⚠ health check failed"
    echo ""
    echo "Memory:"
    /home/ubuntu/.npm-global/bin/openclaw memory status --json 2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); e=data[0] if isinstance(data, list) and data else data; s=e.get('status',{}); print(f\"  main: {s.get('files',0)}f/{s.get('chunks',0)}c (dirty={s.get('dirty')}) {s.get('provider','?')}\")" || echo "  ⚠ memory status failed"
    echo ""
    echo "Agents (running daemons):"
    pids=$(pgrep -f "agent-loop.sh" 2>/dev/null | wc -l) || true; echo "  $pids daemon(s) running (dev, content, research)"
    echo ""
    echo "Gateway:"
    gateway_running=$(systemctl --user is-active openclaw-gateway.service 2>/dev/null || echo "inactive")
    echo "  $gateway_running"
    if [ "$gateway_running" != "active" ]; then
      echo "  → Run: openclaw gateway start (or restart if config changed)"
    fi
    echo ""
    echo "Git:"
    changes=$(git -C "$WORKSPACE" status --short | wc -l); echo "  $changes changed file(s)" $([ "$changes" -eq 0 ] && echo "(clean)" || echo "(dirty)")
    echo ""
    echo "Cron (user crontab):"
    cron_count=$(crontab -l 2>/dev/null | (grep -E 'email-clean|nyaa-top|torrent' || true) | wc -l); echo "  $cron_count entry(ies) relevant"
    echo ""
    echo "OpenClaw Cron:"
    oc_cron_json=$(openclaw cron list --json 2>/dev/null) || oc_cron_json=""
    if echo "$oc_cron_json" | python3 -c "import sys, json; json.load(sys.stdin)" >/dev/null 2>&1; then
      oc_cron_count=$(echo "$oc_cron_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(len([j for j in data.get('jobs',[]) if j.get('enabled')]))" 2>/dev/null || echo "?")
    else
      oc_cron_count="?"
    fi
    echo "  $oc_cron_count enabled job(s) in OpenClaw cron"
    echo "=== End Verification ==="
    ;;
  validate)
    # Run the workspace-validate script
    bash "$WORKSPACE/workspace-validate.sh"
    ;;
  help)
    show_help
    ;;
  *)
    echo "Error: Unknown command '$cmd'" >&2
    echo "Run 'quick help' for available commands." >&2
    exit 1
    ;;
esac
