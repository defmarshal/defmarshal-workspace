#!/usr/bin/env bash
# Quick launcher for common workspace utilities
# Usage: quick <command> [args...]

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"

show_help() {
  cat <<EOF
Quick workspace utility launcher

Commands:
  dash            Run the CLI dashboard (dashboard.py)
  web             Run the web dashboard (web-dashboard.py)
  mem             Show recent memories (claw memory list)
  search <query>  Search memories (claw memory search)
  health          Show workspace health summary (workspace-health)
  holidays        Show upcoming Indonesian holidays (show-holidays)
  git-status      Show brief git status
  anime <cmd>     Anime companion: search, info, top, season, upcoming
                  Example: quick anime search "frieren" [--tts]
  selfie [caption] [rating]  Send a random anime image via Nekos API.
                  rating: safe (default) or explicit. Caption optional.
  selfie-batch <count> [rating] [caption]  Fetch multiple anime images (1-20) and
                  send as a single zip file. Default count=5, rating=safe.
  torrent-add <magnet_or_file> [rpc_secret]  Add a magnet link or .torrent file to
                  the aria2 downloader. RPC secret defaults to 'openclaw_secret_123'.
                  Example: quick torrent-add "magnet:?xt=urn:btih:..."
                  Example: quick torrent-add "/path/to/file.torrent" "my_secret"
  nyaa-search <query> [--limit N] [--category cat]  Search Sukebei.Nyaa.si for
                  torrents. Categories: all, anime (default), anime_raw, anime_non_translated,
                  audio, lit, pics, software. Outputs JSON to stdout.
  nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]  Show top torrents sorted
                  by seed count. Options:
                  --max-size SIZE: filter by max size (e.g., 1G, 500M)
                  --pick N: non-interactive pick of Nth torrent (1-indexed)
                  --select: interactive pick by number (terminal only)
                  --add: after pick, send magnet to aria2 automatically.
  log <category> "<message>"  Log an event to openclaw-memory (category: decision, learning, event, note, etc.)
  email-clean [options]      Auto-clean Gmail: archive promotional emails and apply labels.
                              Options: --execute (apply changes), --max N, --query "gmail query"
                              Rules: archives CATEGORY_PROMOTIONS/UPDATES, spammy keywords/senders,
                                    and labels messages containing keywords like "welcome" with configurable labels.
  agents [flags]               List running sessions/agents; flags passed to `openclaw sessions` (e.g., --json, --help)
  downloads [--json] [--watch SECS]  Show aria2 download progress (active downloads). Use --watch to auto-refresh.
  help                       Show this help message

Examples:
  quick dash
  quick search "project"
  quick health
  quick anime info 52991 --tts
EOF
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  dash|dashboard)
    python3 "$WORKSPACE/dashboard.py"
    ;;
  web)
    python3 "$WORKSPACE/web-dashboard.py"
    ;;
  mem|memory)
    # Human-friendly output when in terminal, JSON when piped
    if [ -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json | \
        jq -r '.results[:20] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    else
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json
    fi
    ;;
  search)
    # Combine all arguments into a single query string
    query="$*"
    if [ -z "$query" ]; then
      echo "Error: search requires a query string" >&2
      echo "Usage: quick search <query> [--json]" >&2
      exit 1
    fi
    shift || true
    # Detect optional --json flag (must be last)
    RAW_JSON=0
    for arg in "$@"; do
      if [ "$arg" = "--json" ]; then
        RAW_JSON=1
      fi
    done
    CMD="/home/ubuntu/.npm-global/bin/openclaw memory search $(printf "%q" "$query") --max-results 10 --json"
    if [ $RAW_JSON -eq 1 ] || [ ! -t 1 ]; then
      $CMD
    else
      $CMD | jq -r '.results[:10] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    fi
    ;;
  health)
    python3 "$WORKSPACE/workspace-health.py" 2>/dev/null || "$WORKSPACE/workspace-health"
    ;;
  holidays)
    python3 "$WORKSPACE/show-holidays" 2>/dev/null || "$WORKSPACE/show-holidays"
    ;;
  git-status)
    git -C "$WORKSPACE" status --short
    ;;
  anime)
    "$WORKSPACE/anime-companion" "$@"
    ;;
  selfie)
    # Send a random anime image via Nekos API
    # Usage: quick selfie [caption] [rating]
    # Rating: safe (default) or explicit
    caption="${1:-}"
    rating="${2:-safe}"
    if [ "$rating" != "safe" ] && [ "$rating" != "explicit" ]; then
      echo "Error: rating must be 'safe' or 'explicit'" >&2
      exit 1
    fi
    # Use credentials from environment or openclaw.json (already set by gateway)
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie.sh" "$caption" "$rating"
    ;;
  selfie-batch)
    # Send multiple anime images as a zip via Nekos API
    # Usage: quick selfie-batch <count> [rating] [caption]
    # count: 1-20 (default: 5)
    # rating: safe (default) or explicit
    count="${1:-5}"
    rating="${2:-safe}"
    shift 2 || true
    caption="${*:-}"
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie-batch.sh" "$count" "$rating" "$caption"
    ;;
  torrent-add)
    # Add magnet or torrent file to aria2
    # Usage: quick torrent-add <magnet_or_file> [rpc_secret]
    "$WORKSPACE/torrent-add" "$@"
    ;;
  nyaa-search)
    # Search Sukebei.Nyaa.si for torrents
    # Usage: quick nyaa-search <query> [--limit N] [--category anime|all|...]
    # Example: quick nyaa-search "ubuntu 24.04" --limit 5
    python3 "$WORKSPACE/nyaa-search" "$@"
    ;;
  nyaa-top)
    # Show top torrents sorted by seeds (Sukebei.Nyaa.si)
    # Usage: quick nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]
    python3 "$WORKSPACE/nyaa-top" "$@"
    ;;
  log)
    "$WORKSPACE/log-event" "$@"
    ;;
  email-clean)
    python3 "$WORKSPACE/email-cleaner.py" "$@"
    ;;
  agents)
    # List running sessions/agents; pass through flags
    if [ $# -eq 0 ] && [ ! -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw sessions --json
    else
      /home/ubuntu/.npm-global/bin/openclaw sessions "$@"
    fi
    ;;
  downloads)
    # Show aria2 download progress (uses RPC)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  help|--help|-h)
    show_help
    ;;
  *)
    echo "Error: Unknown command '$cmd'" >&2
    echo "Run 'quick help' for available commands." >&2
    exit 1
    ;;
esac
