#!/usr/bin/env bash
# Quick launcher for common workspace utilities
# Usage: quick <command> [args...]

set -euo pipefail

WORKSPACE="/home/ubuntu/.openclaw/workspace"

show_help() {
  cat <<EOF
Quick workspace utility launcher

Commands:
  dash            Run the CLI dashboard (dashboard.py)
  web             Run the web dashboard (web-dashboard.py)
  gateway-info    Show gateway status and remote access setup instructions
  gateway-watchdog		Show gateway watchdog log (last 20 lines)
  hygiene         Run workspace hygiene check (CRLF, exec bits, large files, caches)
  mem             Show recent memories (claw memory list)
  search <query>  Search memories (claw memory search)
  memory-status  Show memory index status (openclaw memory status)
  memory-index  Reindex memory files (openclaw memory index)
  memory-stats  Show detailed memory system statistics (files, chunks, cache, FTS, etc.)
  voyage-status  Check recent Voyage AI rate limit status from memory reindex logs; shows warnings if rate-limited recently
  memory-reindex-check  Check if memory reindex is needed based on dirty flag and age. Exit 0 if ok, 1 if reindex recommended
  memory-reindex Force reindex of memory files (openclaw memory index)
  daemons        Show status of persistent background agents (dev, content, research, torrent-bot)
  agent-status   Show OpenClaw cron jobs overview (next run, last status, schedule)
  archive-sizes  Show human-readable sizes of content, research, and memory directories
  quiet-hours    Show current quiet hours status (Asia/Bangkok 23:00-08:00) and whether system is in quiet mode
  health          Show workspace health summary (workspace-health)
  summary         Show one-line system summary (status, disk, updates, git)
  holidays        Show upcoming Indonesian holidays (show-holidays)
  time            Show current time in UTC and Bangkok (Asia/Bangkok)
  weather [loc]   Get current weather (default: Bangkok) via wttr.in
  git-status      Show brief git status
  git-today       Show git commits from today (since midnight)
  git-summary     Show recent commit summary by prefix (dev:, research:, content:, infra:, chore:)
  git-last        Show last commit details (files changed, stats, message)
  git-recent [N]  Show recent commits one-line (default 5)
  anime <cmd>     Anime companion: search, info, top, season, upcoming
                  Example: quick anime search "frieren" [--tts]
  selfie [caption] [rating]  Send a random anime image via Nekos API.
                  rating: safe (default) or explicit. Caption optional.
  selfie-batch <count> [rating] [caption]  Fetch multiple anime images (1-20) and
                  send as a single zip file. Default count=5, rating=safe.
  torrent-add <magnet_or_file> [rpc_secret]  Add a magnet link or .torrent file to
                  the aria2 downloader. RPC secret defaults to 'openclaw_secret_123'.
                  Example: quick torrent-add "magnet:?xt=urn:btih:..."
                  Example: quick torrent-add "/path/to/file.torrent" "my_secret"
  torrent-status [--json] [--watch SECS]  Show aria2 download progress (alias for downloads). Use --watch to auto-refresh.
  nyaa-search <query> [--limit N] [--category cat]  Search Sukebei.Nyaa.si for
                  torrents. Categories: all, anime (default), anime_raw, anime_non_translated,
                  audio, lit, pics, software. Outputs JSON to stdout.
  nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]  Show top torrents sorted
                  by seed count. Options:
                  --max-size SIZE: filter by max size (e.g., 1G, 500M)
                  --pick N: non-interactive pick of Nth torrent (1-indexed)
                  --select: interactive pick by number (terminal only)
                  --add: after pick, send magnet to aria2 automatically.
  log <category> "<message>"  Log an event to openclaw-memory (category: decision, learning, event, note, etc.)
  email-clean [options]      Auto-clean Gmail: archive promotional emails and apply labels.
                              Options: --execute (apply changes), --max N, --query "gmail query"
                              Rules: archives CATEGORY_PROMOTIONS/UPDATES, spammy keywords/senders,
                                    and labels messages containing keywords like "welcome" with configurable labels.
  agents [flags]               List running sessions/agents; flags passed to `openclaw sessions` (e.g., --json, --help)
  downloads [--json] [--watch SECS]  Show aria2 download progress (active downloads). Use --watch to auto-refresh.
  content-latest              Show the latest content digest/note from content/ directory.
  content-index-update        Regenerate content/INDEX.md to reflect current content files.
  research-watchlist          Show the latest research planning watchlist (research/watchlist-*.md)
  reports                     List daily digest reports in reports/ (most recent first)
  digest                     Show the latest daily digest report from reports/ (cat the most recent)
  social-monitor                  Run the social monitor agent (Twitter trending digest)
  daily-digest [YYYY-MM-DD]       Generate daily digest report (default: today UTC). Saves to reports/ and prints.
  sudo-check                  Check if passwordless sudo is configured (runs 'sudo -n true')
  today                     Show files modified today across the workspace (since midnight UTC)
  log-rotate                  Rotate aria2.log if >100MB, keep up to 4 compressed archives
  updates-check                Check for pending system updates (APT)
  updates-apply [--dry-run|--execute] Apply system updates (dry-run by default; use --execute to actually upgrade)
  cleanup-downloads [options] Clean up old downloads (default: dry-run, retains 30 days)
                             Options: --days N, --execute, --verbose
                              Example: quick cleanup-downloads --days 60 --execute
  cleanup-backups [options]   Clean up old openclaw-backup tarballs in /home/ubuntu (default: dry-run, keep 1)
                             Options: --keep N, --execute, --verbose
                              Example: quick cleanup-backups --keep 3 --execute
  agent-logs [name]           Show recent logs for an agent (dev, content, research, builder, manager). Default: all.
  agent-manager              Run agent-manager maintenance checks (used by cron)
  supervisor                 Run supervisor health check (cron monitoring, gateway, disk, memory)
  supervisor-logs            Show supervisor log (memory/supervisor.log)
  supervisor-status          Run supervisor health check and show concise summary
  gateway-info               Show detailed OpenClaw gateway status and troubleshooting info
  gateway-logs               Show recent OpenClaw gateway logs (tail -n 20 /tmp/openclaw/openclaw-*.log)
  openclaw-version           Show installed OpenClaw version (global npm)
  openclaw-status            Show OpenClaw system status (sessions, channels, recipients)
  uptime                     Show system and OpenClaw gateway uptime
  apt-check                  Show APT update count and short status
  gateway-token              Show gateway device token info and rotate if needed (use --force to auto-rotate)
  tailscale-status           Show Tailscale IP and connectivity status
  meta                       Run meta-agent once (autonomous planner)
  meta-report                Show latest meta-agent report
  meta-logs                  Show meta-agent log (memory/meta-agent.log)
  checkpoints                Show autonomous system checkpoints (autonomous-checkpoints.json)
  phase                      Show current autonomous phase status (from checkpoints)
  meta-commit                Auto‑commit meta‑agent planning files (findings.md, progress.md, task_plan.md) if changed
  agni-status                Show Agni agent status (running? lock? last log)
  cleanup-untracked [--execute]  List or delete untracked files (default: list; --execute to delete)
  cleanup-agent-artifacts [options]  Clean up stale agent artifacts (lock files, empty plans). Runs 24/7.
                                  Options: --execute (actually delete), --force (run during quiet hours)
  agent-spawn <agent-id> <task>      Spawn an agent (dev, content, research, or custom). Uses sessions_spawn.
  cron              List OpenClaw cron jobs (concise summary)
  cron-status                 Show status of important cron jobs (email-cleaner, torrent auto-download, etc.)
  supervisor-schedule         Show supervisor-cron schedule (cron expression)
  restart-gateway             Restart the OpenClaw gateway (use after config changes or to restore approval buttons)
  gateway-status              Show detailed gateway status (service, port, RPC)
  gateway-fix                 Fix gateway issues (stop stray processes, restart cleanly)
  validate                    Run comprehensive validation (health, memory, agents, git, cron, logs)
  status                      Show concise one-line system summary (local only, no approvals)
  verify                      Run comprehensive workspace verification (health, memory, agents, git, cron)
  session-locks [--clear]     List stale session locks (default) or clear them (--clear)
  setup-all                   Run all setup scripts (sudo, torrent cron) in order. Use with care.
  cron-failures  Show cron jobs with recent errors (consecutiveErrors > 0 or lastStatus != "ok")
  help                       Show this help message

Examples:
  quick dash
  quick search "project"
  quick health
  quick anime info 52991 --tts
EOF
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  dash|dashboard)
    python3 "$WORKSPACE/dashboard.py"
    ;;
  web)
    python3 "$WORKSPACE/web-dashboard.py"
    ;;
  mem|memory)
    # Human-friendly output when in terminal, JSON when piped
    if [ -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json | \
        jq -r '.results[:20] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
    else
      /home/ubuntu/.npm-global/bin/openclaw memory search "recent" --max-results 20 --json
    fi
    ;;
  search)
    # Combine all arguments into a single query string
    query="$*"
    if [ -z "$query" ]; then
      echo "Error: search requires a query string" >&2
      echo "Usage: quick search <query> [--json]" >&2
      exit 1
    fi
    shift || true
    # Detect optional --json flag (must be last)
    RAW_JSON=0
    for arg in "$@"; do
      if [ "$arg" = "--json" ]; then
        RAW_JSON=1
      fi
    done

    # Fallback: grep-based search when Voyage is unavailable/rate-limited
    fallback_search() {
      ./msearch "$query" | head -n 10
    }

    if [ $RAW_JSON -eq 1 ] || [ ! -t 1 ]; then
      # JSON/pipe mode: try Voyage JSON, fallback to plain text if fails
      if ! /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json 2>/dev/null; then
        echo "Warning: Voyage search failed, using fallback grep." >&2
        fallback_search
      else
        /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json
      fi
    else
      # Interactive human-friendly mode
      if ! /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json 2>/dev/null | jq -r '.results[:10] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"' 2>/dev/null; then
        echo "Warning: Voyage search failed, using fallback grep." >&2
        fallback_search
      else
        /home/ubuntu/.npm-global/bin/openclaw memory search "$query" --max-results 10 --json | jq -r '.results[:10] | .[] | "\(.path | split("/")[-1]): \(.snippet | split("\n")[0] | if length>100 then .[0:100] + "..." else . end)"'
      fi
    fi
    ;;
  memory-status)
    # Show memory search index status
    /home/ubuntu/.npm-global/bin/openclaw memory status
    ;;
  memory-index|memory-reindex)
    # Reindex memory files (gentle sequential mode to avoid API rate limits)
    echo "Reindexing memory (gentle sequential mode)..."
    # Get agent IDs from OpenClaw config
    CONFIG_PATH="${HOME}/.openclaw/openclaw.json"
    if [ -f "$CONFIG_PATH" ]; then
      agents=$(grep -E '"id"\s*:' "$CONFIG_PATH" 2>/dev/null | sed -E 's/.*"id"\s*:\s*"([^"]+)".*/\1/')
    else
      agents="main"
    fi
    # Default to 'main' if no agents found
    if [ -z "$agents" ]; then
      agents="main"
    fi
    for agent in $agents; do
      echo "  Reindexing agent: $agent"
      if /home/ubuntu/.npm-global/bin/openclaw memory index --agent "$agent"; then
        echo "    ✓ $agent reindexed"
      else
        echo "    ✗ $agent reindex failed (perhaps rate limited; will retry later)"
      fi
      # Wait between agents to respect Voyage AI rate limits (3 RPM free tier)
      echo "    Waiting 60s before next agent..."
      sleep 60
    done
    echo "Memory reindex sequence completed."
    ;;

  memory-reindex-check)
    # Check if memory reindex is needed
    "$WORKSPACE/memory-reindex-check"
    ;;
  memory-stats)
    # Show memory system statistics (wrapper around memory-stats script)
    "$WORKSPACE/memory-stats" "$@"
    ;;
  voyage-status)
    # Check recent Voyage AI rate limit health based on memory reindex activity logs
    LOG1="$WORKSPACE/memory/agent-manager.log"
    LOG2="$WORKSPACE/memory/memory-reindex.log"
    # Prefer agent-manager.log if it exists and recent
    if [ -f "$LOG1" ]; then
      LOG="$LOG1"
    elif [ -f "$LOG2" ]; then
      LOG="$LOG2"
    else
      echo "No Voyage rate limit history available (no logs found)."
      exit 0
    fi
    # Determine if log was modified in the last 24 hours
    now=$(date +%s)
    log_mtime=$(stat -c %Y "$LOG" 2>/dev/null || echo 0)
    if [ $((now - log_mtime)) -gt 86400 ]; then
      echo "✅ No recent memory reindex activity (log older than 24h)."
      exit 0
    fi
    # Check if log contains indications of rate limiting (429 or "rate limited")
    if grep -qiE '429|rate limited' "$LOG" >/dev/null; then
      echo "⚠️ Voyage Rate Limit Alert"
      echo "Recent memory reindex attempts encountered rate limiting."
      echo ""
      echo "Relevant log lines (last 5):"
      grep -iE '429|rate limited' "$LOG" | tail -5 | sed 's/^/  /'
      echo ""
      echo "Recommendations:"
      echo "  - quick memory-reindex now uses gentle sequential mode (spaced by 60s)"
      echo "  - Add a payment method to Voyage AI to increase rate limits"
      echo "  - Reduce reindex frequency or skip non-critical agents (e.g., torrent-bot)"
      exit 1
    else
      echo "✅ No Voyage rate limit indicators in recent log."
      exit 0
    fi
    ;;
  daemons)
    # Show status of persistent background agents
    echo "Persistent Daemons:"
    echo "-------------------"
    for name in dev-agent content-agent research-agent torrent-bot; do
      pid=$(pgrep -f "$name" || true)
      if [ -n "$pid" ]; then
        uptime=$(ps -o etime= -p "$pid" 2>/dev/null | tr -d ' ')
        echo "  ✓ $name  PID:$pid  uptime:$uptime"
      else
        echo "  ✗ $name  NOT RUNNING"
      fi
    done
    ;;
  archive-sizes)
    # Show human-readable sizes of content, research, and memory directories
    echo "Archive sizes:"
    echo "-------------"
    du -sh /home/ubuntu/.openclaw/workspace/content 2>/dev/null || echo "content: missing"
    du -sh /home/ubuntu/.openclaw/workspace/research 2>/dev/null || echo "research: missing"
    du -sh /home/ubuntu/.openclaw/workspace/memory 2>/dev/null || echo "memory: missing"
    ;;
  agent-status)
    # Show OpenClaw cron jobs overview (next run, last status, schedule)
    echo "OpenClaw Cron Jobs Overview:"
    echo "----------------------------"
    openclaw cron list --json 2>/dev/null | jq -r '.jobs[] | "\(.name)|\(.schedule.expr)|\(.schedule.tz // "UTC")|\(.state.nextRunAtMs // 0)|\(.state.lastStatus // "never")|\(.state.lastDurationMs // 0 / 1000|floor)"' | while IFS='|' read -r name expr tz nextMs status duration; do
      if [ "$nextMs" -gt 0 ]; then
        nextdt=$(date -u -d "@$((nextMs/1000))" '+%Y-%m-%d %H:%M' 2>/dev/null || echo "?")
      else
        nextdt="-"
      fi
      printf "%-25s %-15s %-8s %-16s %-10s %6ss\n" "$name" "$expr" "${tz:0:3}" "$nextdt" "$status" "$duration"
    done || echo "Error: jq not available or openclaw CLI issue"
    ;;
  cron-failures)
    # Show cron jobs with errors (consecutiveErrors > 0 or lastStatus != "ok")
    echo "Failed/Error Cron Jobs:"
    echo "----------------------"
    openclaw cron list --json 2>/dev/null | jq -r '.jobs[] | select(.state.consecutiveErrors > 0 or .state.lastStatus != "ok") | "\(.name)|\(.state.lastStatus)|\(.state.consecutiveErrors)|\(.state.nextRunAtMs // 0)"' | while IFS='|' read -r name status errors nextMs; do
      if [ "$nextMs" -gt 0 ]; then
        nextdt=$(date -u -d "@$((nextMs/1000))" '+%Y-%m-%d %H:%M' 2>/dev/null || echo "?")
      else
        nextdt="-"
      fi
      printf "%-25s %-10s %-6s %-16s\n" "$name" "$status" "$errors" "$nextdt"
    done
    ;;
  summary)
    # One-line system summary
    health=$(./quick health)
    git=$(git status --short | wc -l | tr -d ' ')
    echo "Status: ${health} | Git: ${git} changed | $(TZ=Asia/Bangkok date '+%H:%M ICT')"
    ;;
  quiet-hours)
    # Show current quiet hours status — NOTE: quiet hours removed system-wide on 2026-02-17
    echo "Quiet Hours (Asia/Bangkok): 23:00-08:00 (REMOVED)"
    echo "Current time (Bangkok): $(TZ='Asia/Bangkok' date '+%H:%M')"
    echo "Status: ALL AGENTS RUN 24/7 (quiet hours no longer enforced)"
    echo ""
    echo "HEARTBEAT.md remains the source of truth for scheduling."
    ;;
  health)
    "$WORKSPACE/workspace-health"
    ;;
  holidays)
    python3 "$WORKSPACE/show-holidays" 2>/dev/null || "$WORKSPACE/show-holidays"
    ;;
  time)
    # Show current time in UTC and Asia/Bangkok
    echo "UTC:       $(TZ='UTC' date '+%Y-%m-%d %H:%M:%S %Z')"
    echo "Bangkok:  $(TZ='Asia/Bangkok' date '+%Y-%m-%d %H:%M:%S %Z')"
    ;;
  weather)
    # Get current weather for a location (default: Bangkok)
    # Uses wttr.in (no API key required); 15s timeout to avoid hangs
    loc="${1:-Bangkok}"
    if timeout 15 curl -s "wttr.in/${loc}?format=3"; then
      true
    else
      echo "Weather fetch failed or timed out" >&2
      exit 1
    fi
    ;;
  git-status)
    git -C "$WORKSPACE" status --short
    ;;
  git-today)
    git -C "$WORKSPACE" log --since="midnight" --oneline || echo "No commits today"
    ;;
  git-summary)
    # Show recent commit summary by prefix (dev:, research:, content:, infra:, chore:)
    git -C "$WORKSPACE" log --oneline | head -20 | sed -E 's/^([a-f0-9]+) ([^:]+):?/\2/' | sort | uniq -c | sort -nr || echo "No commits"
    ;;
  git-last)
    # Show last commit details: files changed, stats, and message
    git -C "$WORKSPACE" log -1 --stat --name-only || echo "No commits"
    ;;
  git-recent)
    # Show recent commits one-lines (default 5)
    count="${1:-5}"
    git -C "$WORKSPACE" log --oneline -"$count" || echo "No commits"
    ;;
  anime)
    "$WORKSPACE/anime-companion" "$@"
    ;;
  selfie)
    # Send a random anime image via Nekos API
    # Usage: quick selfie [caption] [rating]
    # Rating: safe (default) or explicit
    caption="${1:-}"
    rating="${2:-safe}"
    if [ "$rating" != "safe" ] && [ "$rating" != "explicit" ]; then
      echo "Error: rating must be 'safe' or 'explicit'" >&2
      exit 1
    fi
    # Use credentials from environment or openclaw.json (already set by gateway)
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie.sh" "$caption" "$rating"
    ;;
  selfie-batch)
    # Send multiple anime images as a zip via Nekos API
    # Usage: quick selfie-batch <count> [rating] [caption]
    # count: 1-20 (default: 5)
    # rating: safe (default) or explicit
    count="${1:-5}"
    rating="${2:-safe}"
    shift 2 || true
    caption="${*:-}"
    "$WORKSPACE/skills/clawaifu-selfie/grok-selfie-batch.sh" "$count" "$rating" "$caption"
    ;;
  torrent-add)
    # Add magnet or torrent file to aria2
    # Usage: quick torrent-add <magnet_or_file> [rpc_secret]
    "$WORKSPACE/torrent-add" "$@"
    ;;
  torrent-status)
    # Show current torrent download status (alias for downloads)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  nyaa-search)
    # Search Sukebei.Nyaa.si for torrents
    # Usage: quick nyaa-search <query> [--limit N] [--category anime|all|...]
    # Example: quick nyaa-search "ubuntu 24.04" --limit 5
    python3 "$WORKSPACE/nyaa-search" "$@"
    ;;
  nyaa-top)
    # Show top torrents sorted by seeds (Sukebei.Nyaa.si)
    # Usage: quick nyaa-top [--limit N] [--category cat] [--max-size SIZE] [--pick N] [--select] [--add]
    python3 "$WORKSPACE/nyaa-top" "$@"
    ;;
  log)
    "$WORKSPACE/log-event" "$@"
    ;;
  log-rotate)
    "$WORKSPACE/log-rotate"
    ;;

  updates-check)
    "$WORKSPACE/scripts/updates-check.sh" "$@"
    ;;

  updates-apply)
    "$WORKSPACE/scripts/updates-apply.sh" "$@"
    ;;
  cleanup-downloads)
    # Clean up old downloads with retention policy
    "$WORKSPACE/scripts/cleanup-downloads.sh" "$@"
    ;;
  cleanup-backups)
    # Clean up old backup tarballs in /home/ubuntu
    "$WORKSPACE/scripts/cleanup-backups.sh" "$@"
    ;;
  email-clean)
    python3 "$WORKSPACE/email-cleaner.py" "$@"
    ;;
  agents)
    # List running sessions/agents; pass through flags
    if [ $# -eq 0 ] && [ ! -t 1 ]; then
      /home/ubuntu/.npm-global/bin/openclaw sessions --json
    else
      /home/ubuntu/.npm-global/bin/openclaw sessions "$@"
    fi
    ;;
  downloads)
    # Show aria2 download progress (uses RPC)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  torrent-status)
    # Alias for downloads (local, no approval needed)
    python3 "$WORKSPACE/downloads-status" "$@"
    ;;
  content-latest)
    # Show the latest content digest/note (excluding INDEX.md)
    latest=$(ls -t content/*.md 2>/dev/null | grep -v 'INDEX.md' | head -1)
    if [ -z "$latest" ]; then
      echo "No content files found in content/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  content-index-update)
    # Regenerate content/INDEX.md to reflect current content files
    "$WORKSPACE/update-content-index.sh"
    ;;
  research-watchlist)
    # Show the latest research watchlist file
    latest=$(ls -t research/watchlist-*.md 2>/dev/null | head -1)
    if [ -z "$latest" ]; then
      echo "No research watchlist files found in research/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  reports)
    # List daily digest reports in reports/ (most recent first)
    if [ ! -d "$WORKSPACE/reports" ]; then
      echo "No reports directory found" >&2
      exit 1
    fi
    ls -t "$WORKSPACE/reports"/*.md 2>/dev/null | xargs -r basename -a | sed 's/\.md$//'
    ;;
  digest)
    # Show the latest daily digest report from reports/
    latest=$(ls -t "$WORKSPACE/reports"/*-daily-digest.md 2>/dev/null | head -1)
    if [ -z "$latest" ]; then
      echo "No daily digest reports found in reports/" >&2
      exit 1
    fi
    cat "$latest"
    ;;
  social-monitor)
    # Run the social monitor agent (Twitter trending digest)
    bash "$WORKSPACE/social-monitor-agent.sh"
    ;;
  daily-digest)
    # Generate daily digest report (default: today UTC)
    bash "$WORKSPACE/agents/daily-digest.sh" "${1:-}"
    ;;
  sudo-check)
    # Check if passwordless sudo is configured
    if sudo -n true 2>/dev/null; then
      echo "✓ Passwordless sudo is working! You can use elevated: true in exec commands."
      echo "Privileges:"
      sudo -l | head -5
    else
      echo "✗ Passwordless sudo NOT configured."
      echo "Run './setup-sudo.sh' (with sudo) to set it up."
      exit 1
    fi
    ;;
  agent-manager)
    # Run agent-manager maintenance once (used by cron)
    "$WORKSPACE/agents/agent-manager.sh" --once
    ;;
  supervisor)
    # Run supervisor health check (used by cron)
    "$WORKSPACE/agents/supervisor.sh"
    ;;
  supervisor-logs)
    # Show supervisor log
    tail -n 20 "$WORKSPACE/memory/supervisor.log" 2>/dev/null || echo "No supervisor.log yet"
    ;;
  supervisor-status)
    # Run supervisor health check and show concise summary
    echo "=== Supervisor Health Check ==="
    if [ -x "$WORKSPACE/agents/supervisor.sh" ]; then
      # Run supervisor; it prints SUPERISOR ALERT on issues, otherwise silent
      if OUTPUT=$("$WORKSPACE/agents/supervisor.sh" 2>&1); then
        # Check if any alerts were added (ALERTS array printed)
        if echo "$OUTPUT" | grep -q "SUPERVISOR ALERT:"; then
          echo "Status: ALERT"
          echo "$OUTPUT" | sed -n '/SUPERVISOR ALERT:/,/^$/p'
        else
          echo "Status: OK"
          echo "All checks passed."
        fi
      else
        echo "Status: ERROR"
        echo "Supervisor script failed to run."
      fi
    else
      echo "Supervisor script not found or not executable: $WORKSPACE/agents/supervisor.sh"
    fi
    ;;
  gateway-info)
    # Show detailed OpenClaw gateway status and troubleshooting info
    echo "=== OpenClaw Gateway Status ==="
    if command -v openclaw &>/dev/null; then
      openclaw gateway status
      echo ""
      echo "Dashboard: http://127.0.0.1:18789/"
      echo "Service file: ~/.config/systemd/user/openclaw-gateway.service"
      echo "Logs: /tmp/openclaw/openclaw-*.log"
    else
      echo "openclaw CLI not found"
    fi
    ;;
  gateway-logs)
    # Show recent OpenClaw gateway logs
    LOGFILE=$(ls -t /tmp/openclaw/openclaw-*.log 2>/dev/null | head -n1)
    if [ -n "$LOGFILE" ]; then
      echo "=== Last 20 lines of $LOGFILE ==="
      tail -n 20 "$LOGFILE"
    else
      echo "No OpenClaw gateway logs found in /tmp/openclaw/"
    fi
    ;;
  openclaw-version)
    # Show installed OpenClaw version
    if command -v openclaw &>/dev/null; then
      npm list -g openclaw | head -5
    else
      echo "openclaw CLI not found"
    fi
    ;;
  openclaw-status)
    # Show OpenClaw system status (sessions, channels, recipients)
    if command -v openclaw &>/dev/null; then
      openclaw status
    else
      echo "openclaw CLI not found"
    fi
    ;;
  uptime)
    # Show system and OpenClaw gateway uptime
    echo "=== System Uptime ==="
    uptime -p 2>/dev/null || uptime
    if command -v systemctl &>/dev/null; then
      echo -n "Gateway service: "
      systemctl --user show openclaw-gateway.service --property=ActiveState,ActiveEnterTimestamp --value 2>/dev/null | tr '\n' ' ' || echo "unavailable"
      echo
    else
      PID=$(pgrep -f "openclaw.*gateway" | head -n1)
      if [ -n "$PID" ]; then
        echo "Gateway PID: $PID (start time: $(ps -p $PID -o lstart=))"
      else
        echo "Gateway process not found"
      fi
    fi
    ;;
  apt-check)
    # Show APT update count and status
    if command -v apt-get &>/dev/null; then
      COUNT=$(apt-get -s upgrade 2>/dev/null | grep '^Inst ' | wc -l) || COUNT=0
      if [ "$COUNT" -eq 0 ]; then
        echo "APT updates: none pending"
      else
        echo "APT updates pending: $COUNT"
      fi
    else
      echo "apt-get not available"
    fi
    ;;
  gateway-token)
    # Show gateway device token info and rotate if needed
    # Usage: quick gateway-token [--force]
    echo "=== OpenClaw Gateway Token ==="
    if ! command -v openclaw &>/dev/null; then
      echo "openclaw CLI not found"
      exit 1
    fi
    FORCE=0
    if [ "${1:-}" = "--force" ]; then
      FORCE=1
    fi
    # Check current token status by parsing gateway status output
    if STATUS=$(openclaw gateway status 2>&1); then
      if echo "$STATUS" | grep -q "RPC probe: ok"; then
        echo "RPC probe: OK (device token valid)"
      else
        echo "RPC probe: FAILED (device token mismatch or other issue)"
        if [ "$FORCE" -eq 1 ]; then
          echo "Rotating device token..."
          if openclaw gateway rotate-device-token; then
            echo "Token rotated successfully. Gateway should restart."
            echo "Run 'openclaw gateway status' to verify."
          else
            echo "Rotation failed; check logs."
            exit 1
          fi
        else
          echo ""
          read -p "Rotate gateway device token now? (y/N) " -r REPLY
          if [[ "$REPLY" =~ ^[Yy]$ ]]; then
            echo "Rotating device token..."
            if openclaw gateway rotate-device-token; then
              echo "Token rotated successfully. Gateway should restart."
              echo "Run 'openclaw gateway status' to verify."
            else
              echo "Rotation failed; check logs."
              exit 1
            fi
          else
            echo "Skipping rotation. Fix with: openclaw gateway rotate-device-token"
          fi
        fi
      fi
    else
      echo "Failed to run openclaw gateway status"
      exit 1
    fi
    ;;
  tailscale-status)
    # Show Tailscale IP and connectivity status
    echo "=== Tailscale Status ==="
    if ! command -v tailscale &>/dev/null; then
      echo "Tailscale not installed"
      exit 1
    fi
    # Show local Tailscale IP
    MY_IP=$(tailscale ip 2>/dev/null || echo "?")
    echo "My Tailscale IP: $MY_IP"
    # Show status (connected/off)
    if tailscale status &>/dev/null; then
      echo "Tailscale: connected"
      # List a few peers to show connectivity
      echo "Peers (sample):"
      tailscale status --json 2>/dev/null | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    peers = list(data.get('Peer', {}).keys())[:5]
    for p in peers:
        print(f'  {p}')
except Exception:
    pass" 2>/dev/null || tailscale status | head -n 5 | sed 's/^/  /' || true
    echo ""
    else
      echo "Tailscale: not connected"
    fi
    ;;
  meta)
    # Run meta-agent once (autonomous planner)
    "$WORKSPACE/agents/meta-agent.sh" --once
    ;;
  meta-report)
    # Show latest meta-agent report
    if [ -f "$WORKSPACE/meta-report-latest.md" ]; then
      cat "$WORKSPACE/meta-report-latest.md"
    else
      echo "No meta-report yet. Run 'quick meta' first."
    fi
    ;;
  meta-logs)
    # Show meta-agent log
    tail -n 20 "$WORKSPACE/memory/meta-agent.log" 2>/dev/null || echo "No meta-agent.log yet"
    ;;
  checkpoints)
    # Show autonomous system checkpoints
    if [ -f "$WORKSPACE/autonomous-checkpoints.json" ]; then
      cat "$WORKSPACE/autonomous-checkpoints.json"
    else
      echo "No checkpoints file yet."
    fi
    ;;
  phase)
    # Show current phase status
    if [ -f "$WORKSPACE/autonomous-checkpoints.json" ]; then
      echo "Autonomous System Phase Status:"
      jq -r '. | "Current phase: \(.current_phase // "unset")\nMeta cycles: \(.meta_cycle_count // 0)\nLast report: \(.last_meta_report // "none")"' "$WORKSPACE/autonomous-checkpoints.json" 2>/dev/null || cat "$WORKSPACE/autonomous-checkpoints.json"
    else
      echo "No phase info yet."
    fi
    ;;
  meta-commit)
    # Auto-commit meta-agent planning files if changed
    PLANS=("findings.md" "progress.md" "task_plan.md")
    CHANGED=()
    for f in "${PLANS[@]}"; do
      if [ -f "$WORKSPACE/$f" ] && git -C "$WORKSPACE" status --porcelain | grep -q "^?? $f$"; then
        CHANGED+=("$f")
      fi
    done
    if [ ${#CHANGED[@]} -eq 0 ]; then
      echo "No untracked meta planning files to commit."
      exit 0
    fi
    git -C "$WORKSPACE" add "${CHANGED[@]}"
    git -C "$WORKSPACE" commit -m "meta: update planning artifacts (auto-commit)" || {
      echo "Commit failed; maybe nothing to commit?"
      exit 1
    }
    git -C "$WORKSPACE" push origin master || {
      echo "Push failed; commit made locally."
      exit 1
    }
    echo "Committed and pushed: ${CHANGED[*]}"
    ;;
  session-locks)
    # List or clear stale session locks
    LOCK_DIR="$WORKSPACE/agents/main/sessions"
    if [ ! -d "$LOCK_DIR" ]; then
      echo "Session directory not found: $LOCK_DIR"
      exit 0
    fi
    if [ "$1" = "--clear" ]; then
      find "$LOCK_DIR" -name "*.lock" -type f -delete
      echo "Cleared all session lock files."
    else
      echo "Stale session locks (older than 10 minutes):"
      find "$LOCK_DIR" -name "*.lock" -type f -mmin +10 -printf "%T+ %p\n" 2>/dev/null | sort || echo "No stale locks found."
    fi
    ;;
  cleanup-untracked)
    # List or delete untracked files (dry-run by default)
    if [ "$1" = "--execute" ]; then
      git -C "$WORKSPACE" status --porcelain | awk '/^\?\? /{print $2}' | xargs -r rm -v
      echo "Untracked files removed."
    else
      echo "Untracked files (dry-run):"
      git -C "$WORKSPACE" status --porcelain | awk '/^\?\? /{print "  "$2}' || echo "  None"
    fi
    ;;
  agent-logs)
    # Show recent logs for background agents
    agent_name="${1:-all}"
    case "$agent_name" in
      dev|dev-agent)
        tail -n 20 "$WORKSPACE/dev-agent.log" || echo "No dev-agent.log found"
        ;;
      content|content-agent)
        tail -n 20 "$WORKSPACE/content-agent.log" || echo "No content-agent.log found"
        ;;
      research|research-agent)
        tail -n 20 "$WORKSPACE/research-agent.log" || echo "No research-agent.log found"
        ;;
      builder|workspace-builder)
        tail -n 20 "$WORKSPACE/workspace-builder.log" 2>/dev/null || echo "No workspace-builder.log found"
        ;;
      manager|agent-manager)
        tail -n 20 "$WORKSPACE/memory/agent-manager.log" 2>/dev/null || echo "No agent-manager.log found"
        ;;
      all)
        echo "== DEV-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/dev-agent.log" 2>/dev/null || echo "No dev-agent.log"
        echo -e "\n== CONTENT-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/content-agent.log" 2>/dev/null || echo "No content-agent.log"
        echo -e "\n== RESEARCH-AGENT (last 10 lines) =="
        tail -n 10 "$WORKSPACE/research-agent.log" 2>/dev/null || echo "No research-agent.log"
        echo -e "\n== AGENT-MANAGER (last 10 lines) =="
        tail -n 10 "$WORKSPACE/memory/agent-manager.log" 2>/dev/null || echo "No agent-manager.log"
        ;;
      *)
        echo "Usage: quick agent-logs [dev|content|research|builder|manager|all]" >&2
        exit 1
        ;;
    esac
    ;;
  agent-spawn)
    # Spawn an agent (one-shot or daemon)
    # Usage: quick agent-spawn <agent-id> <task> [--daemon]
    bash "$WORKSPACE/agents/spawner-agent.sh" "$@"
    ;;
  cleanup-agent-artifacts)
    "$WORKSPACE/cleanup-agent-artifacts.sh" "$@"
    ;;
  gateway-info)
    "$WORKSPACE/gateway-info.sh"
    ;;
  gateway-watchdog)
    tail -n 20 "$WORKSPACE/gateway-watchdog.log" 2>/dev/null || echo "No watchdog log yet."
    ;;
  hygiene)
    "$WORKSPACE/workspace-hygiene-check.sh"
    ;;
  cron)
    openclaw cron list --json | jq -r '.jobs[] | "\(.schedule.kind) \(.schedule.expr // "\(.schedule.everyMs)ms") \(.payload.kind) \(.sessionTarget)"' 2>/dev/null || openclaw cron list
    ;;
  cron-status)
    # Show status of important cron jobs
    echo "== System Cron (user crontab) =="
    crontab -l 2>/dev/null | grep -E 'email-clean|nyaa-top|traffic' || echo "No matching cron entries found"
    echo ""
    echo "== OpenClaw Cron (via openclaw cron) =="
    /home/ubuntu/.npm-global/bin/openclaw cron list --json 2>/dev/null | python3 -m json.tool 2>/dev/null || echo "Unable to list OpenClaw cron jobs"
    ;;
  supervisor-schedule)
    # Show supervisor-cron schedule (cron expression)
    CRON_JSON="/home/ubuntu/.openclaw/cron/jobs.json"
    if [ -f "$CRON_JSON" ]; then
      EXPR=$(jq -r '.jobs[] | select(.name=="supervisor-cron") | .schedule.expr' "$CRON_JSON" 2>/dev/null)
      if [ -n "$EXPR" ] && [ "$EXPR" != "null" ]; then
        echo "Supervisor-cron schedule: $EXPR"
      else
        echo "Supervisor-cron schedule not found in $CRON_JSON"
      fi
    else
      echo "Cron jobs file not found: $CRON_JSON"
    fi
    ;;
  agni-status)
    # Show Agni agent status (running? lock? last log)
    LOG="agents/agni/agni.log"
    if [ -f "$LOG" ]; then
      echo "=== Agni Status ==="
      echo "Last log entries:"
      tail -n 5 "$LOG" || echo "  (empty)"
      echo ""
      echo "Running processes:"
      if pgrep -f "agni-cycle.sh" >/dev/null; then
        echo "  agni-cycle.sh: RUNNING (PID $(pgrep -f "agni-cycle.sh"))"
      else
        echo "  agni-cycle.sh: NOT running"
      fi
      echo ""
      echo "To clear stale lock: kill any agni-cycle.sh process or wait for cycle to finish."
    else
      echo "Agni log not found: $LOG"
    fi
    ;;
  setup-all)
    # Run non-interactive setup scripts
    echo "== Running setup scripts (non-interactive) =="
    # List of scripts that can be run without manual intervention or sudo
    scripts=(
      "setup-torrent-cron.sh"
    )
    for script in "${scripts[@]}"; do
      if [ -f "$WORKSPACE/$script" ]; then
        echo "→ Running $script..."
        bash "$WORKSPACE/$script" || echo "  ⚠ $script failed with exit $?"
      else
        echo "  ⊘ $script not found"
      fi
    done
    echo "== Setup complete =="
    echo "Note: For sudo setup, run: sudo ./setup-sudo.sh"
    echo "Remember to commit any changes and push to GitHub."
    ;;
  restart-gateway)
    echo "Restarting OpenClaw gateway..."
    openclaw gateway restart
    ;;
  gateway-status)
    # Detailed gateway status: systemd service, port listening, RPC probe
    echo "=== Gateway Status ==="
    # Service
    if systemctl --user is-active openclaw-gateway.service >/dev/null 2>&1; then
      echo "  Service: active"
    else
      echo "  Service: inactive"
    fi
    # Port
    if ss -tuln | grep -q ':18789 '; then
      echo "  Port 18789: listening"
    else
      echo "  Port 18789: not listening"
    fi
    # RPC probe
    echo -n "  RPC: "
    if timeout 3 openclaw gateway probe >/dev/null 2>&1; then
      echo "reachable"
    else
      echo "unreachable"
    fi
    ;;
  gateway-fix)
    # Run the gateway fix script
    bash "$WORKSPACE/gateway-fix.sh"
    ;;
  status)
    # Concise one-line system summary (local only)
    disk=$(df -h / | awk 'NR==2 {print $5}')
    load=$(uptime | awk -F"load average: " '{print $2}')
    mem=$(free -h | awk '/^Mem:/ {print $7 "/" $2}')
    gw=$(systemctl --user is-active openclaw-gateway.service 2>/dev/null || echo "inactive")
    agents=$(pgrep -f "agent-loop.sh" | wc -l)
    echo "Disk: ${disk} used | Load: ${load} | Mem: ${mem} | Gateway: ${gw} | Agents: ${agents}"
    ;;
  verify)
    # Comprehensive workspace verification
    echo "=== Workspace Verification ==="
    echo ""
    echo "Health:"
    "$WORKSPACE/workspace-health" || echo "  ⚠ health check failed"
    echo ""
    echo "Memory:"
    /home/ubuntu/.npm-global/bin/openclaw memory status --json 2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); e=data[0] if isinstance(data, list) and data else data; s=e.get('status',{}); print(f\"  main: {s.get('files',0)}f/{s.get('chunks',0)}c (dirty={s.get('dirty')}) {s.get('provider','?')}\")" || echo "  ⚠ memory status failed"
    echo ""
    echo "Agents (running daemons):"
    pids=$(pgrep -f "agent-loop.sh" 2>/dev/null | wc -l) || true; echo "  $pids daemon(s) running (dev, content, research)"
    echo ""
    echo "Gateway:"
    gateway_running=$(systemctl --user is-active openclaw-gateway.service 2>/dev/null || echo "inactive")
    echo "  $gateway_running"
    if [ "$gateway_running" != "active" ]; then
      echo "  → Run: openclaw gateway start (or restart if config changed)"
    fi
    echo ""
    echo "Git:"
    changes=$(git -C "$WORKSPACE" status --short | wc -l); echo "  $changes changed file(s)" $([ "$changes" -eq 0 ] && echo "(clean)" || echo "(dirty)")
    echo ""
    echo "Cron (user crontab):"
    cron_count=$(crontab -l 2>/dev/null | (grep -E 'email-clean|nyaa-top|torrent' || true) | wc -l); echo "  $cron_count entry(ies) relevant"
    echo ""
    echo "OpenClaw Cron:"
    oc_cron_json=$(openclaw cron list --json 2>/dev/null) || oc_cron_json=""
    if echo "$oc_cron_json" | python3 -c "import sys, json; json.load(sys.stdin)" >/dev/null 2>&1; then
      oc_cron_count=$(echo "$oc_cron_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(len([j for j in data.get('jobs',[]) if j.get('enabled')]))" 2>/dev/null || echo "?")
    else
      oc_cron_count="?"
    fi
    echo "  $oc_cron_count enabled job(s) in OpenClaw cron"
    echo "=== End Verification ==="
    ;;
  validate)
    # Run the workspace-validate script
    bash "$WORKSPACE/workspace-validate.sh"
    ;;
  today)
    # Show files modified today (since midnight UTC)
    find "$WORKSPACE" -type f ! -path '*/\.git/*' -mtime -1 -printf '%T+ %p\n' 2>/dev/null | sort || echo "No files modified today"
    ;;
  help)
    show_help
    ;;
  *)
    echo "Error: Unknown command '$cmd'" >&2
    echo "Run 'quick help' for available commands." >&2
    exit 1
    ;;
esac
