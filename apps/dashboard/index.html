<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawDash</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#58a6ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --blue: #58a6ff;
      --green: #7ee787;
      --yellow: #d29922;
      --red: #ff7b72;
      --purple: #bc8cff;
      --cyan: #79c0ff;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* â”€â”€ Header â”€â”€ */
    header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 18px; color: var(--blue); display: flex; align-items: center; gap: 8px; }
    header h1 span.logo { font-size: 22px; }
    #last-updated { font-size: 12px; color: var(--muted); }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 20px; overflow-x: auto; }
    .tab-btn { padding: 12px 18px; font-size: 14px; color: var(--muted); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: color 0.15s, border-color 0.15s; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
    .tab-btn .badge { display: inline-block; background: var(--border); color: var(--muted); border-radius: 10px; padding: 1px 7px; font-size: 11px; margin-left: 6px; }
    .tab-btn.active .badge { background: #1f3a5a; color: var(--blue); }

    /* â”€â”€ Tab panels â”€â”€ */
    .tab-panel { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Grid â”€â”€ */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }

    /* â”€â”€ Card â”€â”€ */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
    .card h2 { font-size: 14px; color: var(--cyan); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }

    /* â”€â”€ Table â”€â”€ */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { text-align: left; padding: 6px 4px; border-bottom: 1px solid #21262d; }
    th { color: var(--muted); font-weight: 500; font-size: 12px; }
    tr:last-child td { border-bottom: none; }

    /* â”€â”€ Status chips â”€â”€ */
    .ok    { color: var(--green); }
    .warn  { color: var(--yellow); }
    .bad   { color: var(--red); }
    .muted { color: var(--muted); font-size: 12px; }
    .chip  { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .chip.ok   { background: #1a3a2a; color: var(--green); }
    .chip.warn { background: #3a2a0a; color: var(--yellow); }
    .chip.bad  { background: #3a1a1a; color: var(--red); }
    .chip.muted { background: var(--border); color: var(--muted); }

    /* â”€â”€ Chat â”€â”€ */
    #chat-container { display: flex; flex-direction: column; gap: 12px; max-height: 70vh; overflow-y: auto; padding: 4px 2px; }
    .msg { display: flex; flex-direction: column; max-width: 80%; }
    .msg.user { align-self: flex-end; align-items: flex-end; }
    .msg.assistant { align-self: flex-start; align-items: flex-start; }
    .msg-bubble { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .msg.user .msg-bubble { background: #1f3a5a; color: var(--text); border-bottom-right-radius: 3px; }
    .msg.assistant .msg-bubble { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-bottom-left-radius: 3px; }
    .msg-meta { font-size: 11px; color: var(--muted); margin-top: 3px; }

    /* â”€â”€ Agent output list â”€â”€ */
    .output-list { display: flex; flex-direction: column; gap: 8px; }
    .output-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; cursor: pointer; transition: border-color 0.15s; }
    .output-item:hover { border-color: var(--blue); }
    .output-item .out-title { font-size: 13px; color: var(--text); margin-bottom: 4px; }
    .output-item .out-meta { font-size: 11px; color: var(--muted); display: flex; gap: 10px; }

    /* â”€â”€ Heartbeat â”€â”€ */
    .hb-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .hb-item { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; }
    .hb-key { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .hb-val { font-size: 13px; color: var(--text); word-break: break-word; }

    .log-box { background: #0a0d11; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: "SF Mono", Menlo, monospace; font-size: 11px; color: #8b949e; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }

    /* â”€â”€ Error banner â”€â”€ */
    #error-banner { display: none; background: #3a1a1a; border: 1px solid var(--red); color: var(--red); border-radius: 6px; padding: 8px 12px; margin: 12px 20px; font-size: 13px; }

    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    footer { text-align: center; color: var(--muted); font-size: 12px; padding: 20px; }

    @media (max-width: 600px) {
      .tab-btn { padding: 10px 12px; font-size: 13px; }
      .msg { max-width: 95%; }
    }
  </style>
</head>
<body>

<header>
  <h1><span class="logo">ğŸ¦¾</span> ClawDash</h1>
  <span id="last-updated" class="muted">Loadingâ€¦</span>
</header>

<div id="error-banner"></div>

<nav class="tabs">
  <button class="tab-btn active" data-tab="overview">ğŸ“Š Overview</button>
  <button class="tab-btn" data-tab="heartbeat">ğŸ’“ Heartbeat</button>
  <button class="tab-btn" data-tab="agents">ğŸ¤– Agents <span class="badge" id="badge-agents">â€¦</span></button>
  <button class="tab-btn" data-tab="chat">ğŸ’¬ Chat <span class="badge" id="badge-chat">â€¦</span></button>
</nav>

<!-- â”€â”€ Overview â”€â”€ -->
<div id="tab-overview" class="tab-panel active">
  <div class="grid">
    <div class="card">
      <h2>ğŸ–¥ï¸ System</h2>
      <table id="sys-table"></table>
    </div>
    <div class="card">
      <h2>ğŸ¤– Agent Status</h2>
      <table id="agent-table"></table>
    </div>
    <div class="card">
      <h2>ğŸ“š Research Library</h2>
      <table id="research-table"></table>
    </div>
    <div class="card">
      <h2>ğŸ“ Recent Commits</h2>
      <table id="commit-table"></table>
    </div>
  </div>
</div>

<!-- â”€â”€ Heartbeat â”€â”€ -->
<div id="tab-heartbeat" class="tab-panel">
  <div class="grid">
    <div class="card" style="grid-column: 1/-1">
      <h2>ğŸ’“ Last Heartbeat</h2>
      <div id="hb-grid" class="hb-grid" style="margin-bottom:16px"></div>
      <h2 style="margin-top:4px">ğŸ“‹ Supervisor Log</h2>
      <div id="supervisor-log" class="log-box"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ Agents â”€â”€ -->
<div id="tab-agents" class="tab-panel">
  <div class="grid" style="margin-bottom:20px">
    <div class="card" style="grid-column: 1/-1">
      <h2>ğŸ¤– Agent Details</h2>
      <table id="agent-detail-table" style="margin-bottom:0"></table>
    </div>
  </div>
  <div class="card">
    <h2>ğŸ“„ Recent Agent Outputs</h2>
    <div id="output-list" class="output-list"></div>
  </div>
</div>

<!-- â”€â”€ Chat â”€â”€ -->
<div id="tab-chat" class="tab-panel">
  <div class="card" style="padding:16px">
    <h2>ğŸ’¬ Conversation with mewmew</h2>
    <div id="chat-container" style="margin-top:12px"></div>
  </div>
</div>

<footer>ClawDash â€” auto-refresh every 60s</footer>

<script>
  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'chat') scrollChatToBottom();
    });
  });

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function chip(label, cls) {
    return `<span class="chip ${cls}">${label}</span>`;
  }
  function fmtTs(ts) {
    if (!ts) return '';
    try {
      const d = new Date(ts);
      return d.toISOString().replace('T',' ').slice(0,16) + ' UTC';
    } catch { return ts; }
  }

  // â”€â”€ Overview renders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSystem(data) {
    const t = document.getElementById('sys-table');
    const s = data.system || {};
    const gw = s.gateway === 'up' ? chip('up','ok') : chip('down','bad');
    const disk = s.disk_percent >= 90 ? chip(s.disk_percent+'%','bad')
               : s.disk_percent >= 80 ? chip(s.disk_percent+'%','warn')
               : chip(s.disk_percent+'%','ok');
    const upd = s.updates > 0 ? chip(s.updates+' pending','warn') : chip('0','ok');
    const git = s.git_clean ? chip('clean','ok') : chip('dirty','warn');
    const mem = s.memory_age_days <= 7 ? chip(s.memory_age_days+'d','ok') : chip(s.memory_age_days+'d','warn');
    t.innerHTML = `
      <tr><th>Gateway</th><td>${gw}</td></tr>
      <tr><th>Disk</th><td>${disk} <span class="muted">(${esc(s.disk_free)} free)</span></td></tr>
      <tr><th>Updates</th><td>${upd}</td></tr>
      <tr><th>Git</th><td>${git}</td></tr>
      <tr><th>Memory Index</th><td>${mem}</td></tr>
      <tr><th>Downloads</th><td>${esc(s.downloads_count)} files <span class="muted">(${esc(s.downloads_gb)})</span></td></tr>
    `;
  }

  function renderAgents(agents) {
    const t = document.getElementById('agent-table');
    t.innerHTML = (agents || []).map(a => `
      <tr>
        <td>${esc(a.name)}</td>
        <td>${a.active ? chip('active','ok') : chip('idle','muted')}</td>
        <td class="muted">${esc(a.last_run)}</td>
      </tr>
    `).join('');
    document.getElementById('badge-agents').textContent = (agents||[]).filter(a=>a.active).length + '/' + (agents||[]).length;
  }

  function renderResearch(r) {
    const t = document.getElementById('research-table');
    t.innerHTML = `
      <tr><td>Total Reports</td><td><strong>${esc(r.total)}</strong></td></tr>
      <tr><td>TTS Coverage</td><td><span class="${r.tts_coverage==='100%'?'ok':'warn'}">${esc(r.tts_coverage)}</span></td></tr>
      <tr><td>Latest</td><td class="muted">${esc(r.latest||'none')}</td></tr>
      <tr><td>Hub Deployed</td><td>${r.hub_deployed ? chip('yes','ok') : chip('no','warn')}</td></tr>
    `;
  }

  function renderCommits(commits) {
    const t = document.getElementById('commit-table');
    t.innerHTML = (commits||[]).map(c => `
      <tr>
        <td><span class="chip muted">${esc(c.agent)}</span></td>
        <td style="font-size:12px">${esc(c.message)}</td>
      </tr>
    `).join('');
  }

  // â”€â”€ Heartbeat render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderHeartbeat(hb, supervisorLog) {
    const checks = hb?.lastChecks || {};
    const grid = document.getElementById('hb-grid');
    const items = Object.entries(checks).map(([k, v]) => `
      <div class="hb-item">
        <div class="hb-key">${esc(k)}</div>
        <div class="hb-val">${esc(String(v))}</div>
      </div>
    `).join('') || '<span class="muted">No heartbeat data yet.</span>';
    grid.innerHTML = items;

    const logBox = document.getElementById('supervisor-log');
    logBox.textContent = (supervisorLog || []).join('\n') || 'No supervisor log.';
    logBox.scrollTop = logBox.scrollHeight;
  }

  // â”€â”€ Agent detail + outputs render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderAgentDetail(agents) {
    const t = document.getElementById('agent-detail-table');
    t.innerHTML = `<tr><th>Agent</th><th>Status</th><th>Last Run</th><th>Last Log</th></tr>` +
      (agents||[]).map(a => `
        <tr>
          <td><strong>${esc(a.name)}</strong></td>
          <td>${a.active ? chip('active','ok') : chip('idle','muted')}</td>
          <td class="muted">${esc(a.last_run)}</td>
          <td class="muted" style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(a.last_line)}">${esc((a.last_line||'').slice(0,80))}</td>
        </tr>
      `).join('');
  }

  function renderOutputs(outputs) {
    const el = document.getElementById('output-list');
    if (!outputs || outputs.length === 0) {
      el.innerHTML = '<span class="muted">No agent outputs found.</span>';
      return;
    }
    el.innerHTML = outputs.map(o => `
      <div class="output-item">
        <div class="out-title">${esc(o.title || o.file)}</div>
        <div class="out-meta">
          <span>ğŸ“… ${esc(o.ts || 'â€”')}</span>
          <span>ğŸ“„ ${esc(o.file)}</span>
          <span class="muted">${esc(Math.round((o.size||0)/1024*10)/10)} KB</span>
        </div>
      </div>
    `).join('');
  }

  // â”€â”€ Chat render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderChat(messages) {
    const container = document.getElementById('chat-container');
    document.getElementById('badge-chat').textContent = (messages||[]).length;
    if (!messages || messages.length === 0) {
      container.innerHTML = '<span class="muted">No chat history available.</span>';
      return;
    }
    container.innerHTML = messages.map(m => {
      const role = m.role === 'user' ? 'user' : 'assistant';
      const label = role === 'user' ? 'ğŸ‘¤ def' : 'ğŸ¾ mewmew';
      const time = fmtTs(m.ts);
      // simple markdown: bold, code
      let text = esc(m.text || '');
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/`([^`]+)`/g, '<code style="background:#0d1117;padding:1px 4px;border-radius:3px;font-family:monospace;font-size:12px">$1</code>');
      return `
        <div class="msg ${role}">
          <div class="msg-bubble">${text}</div>
          <div class="msg-meta">${label} Â· ${time}</div>
        </div>
      `;
    }).join('');
    scrollChatToBottom();
  }

  function scrollChatToBottom() {
    const c = document.getElementById('chat-container');
    c.scrollTop = c.scrollHeight;
  }

  // â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function load() {
    try {
      const res = await fetch('/data.json?bust=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      renderSystem(data);
      renderAgents(data.agents);
      renderResearch(data.research);
      renderCommits(data.recent_commits);
      renderHeartbeat(data.heartbeat, data.supervisor_log);
      renderAgentDetail(data.agents);
      renderOutputs(data.agent_outputs);
      renderChat(data.chat);

      document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      document.getElementById('error-banner').style.display = 'none';
    } catch (e) {
      console.error(e);
      const b = document.getElementById('error-banner');
      b.textContent = 'âš ï¸ Load failed: ' + e.message;
      b.style.display = 'block';
      document.getElementById('last-updated').textContent = 'Error';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    load();
    setInterval(load, 60000);
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  });
</script>
</body>
</html>
