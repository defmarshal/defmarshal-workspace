<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawDash</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#58a6ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117; --surface: #161b22; --border: #30363d;
      --text: #e6edf3; --muted: #8b949e;
      --blue: #58a6ff; --green: #7ee787; --yellow: #d29922;
      --red: #ff7b72; --purple: #bc8cff; --cyan: #79c0ff;
    }
    html, body { height: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; min-height: 100vh; }

    header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    header h1 { font-size: 17px; color: var(--blue); display: flex; align-items: center; gap: 8px; }
    #last-updated { font-size: 11px; color: var(--muted); }
    #backend-status { font-size: 11px; padding: 2px 8px; border-radius: 10px; }
    #backend-status.ok  { background: #1a3a2a; color: var(--green); }
    #backend-status.bad { background: #3a1a1a; color: var(--red); }

    .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 16px; overflow-x: auto; flex-shrink: 0; }
    .tab-btn { padding: 11px 16px; font-size: 13px; color: var(--muted); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: color .15s, border-color .15s; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
    .badge { display: inline-block; background: var(--border); color: var(--muted); border-radius: 10px; padding: 1px 6px; font-size: 10px; margin-left: 4px; }
    .tab-btn.active .badge { background: #1f3a5a; color: var(--blue); }

    .tab-panel { display: none; padding: 16px 20px; max-width: 1200px; margin: 0 auto; width: 100%; flex: 1; }
    .tab-panel.active { display: flex; flex-direction: column; }

    /* â”€â”€ Chat tab â€” full height â”€â”€ */
    #tab-chat { padding: 0; max-width: 100%; height: 0; flex: 1; }
    #tab-chat.active { display: flex; flex-direction: row; height: 100%; }
    .chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .chat-sidebar { width: 260px; flex-shrink: 0; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }

    #chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .msg { display: flex; flex-direction: column; max-width: 75%; }
    .msg.user { align-self: flex-end; align-items: flex-end; }
    .msg.assistant { align-self: flex-start; align-items: flex-start; }
    .msg-bubble { padding: 9px 13px; border-radius: 12px; font-size: 13px; line-height: 1.55; white-space: pre-wrap; word-break: break-word; }
    .msg.user .msg-bubble { background: #1f3a5a; color: var(--text); border-bottom-right-radius: 3px; }
    .msg.assistant .msg-bubble { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-bottom-left-radius: 3px; }
    .msg-meta { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .msg.sending .msg-bubble { opacity: 0.6; }

    /* â”€â”€ Chat input â”€â”€ */
    .chat-input-wrap { border-top: 1px solid var(--border); padding: 12px 16px; display: flex; gap: 8px; background: var(--surface); flex-shrink: 0; }
    #chat-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); padding: 9px 12px; font-size: 13px; resize: none; font-family: inherit; line-height: 1.4; max-height: 120px; outline: none; }
    #chat-input:focus { border-color: var(--blue); }
    #send-btn { background: var(--blue); color: #0d1117; border: none; border-radius: 8px; padding: 9px 16px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: opacity .15s; }
    #send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #send-btn:hover:not(:disabled) { opacity: 0.85; }

    /* â”€â”€ Quick commands sidebar â”€â”€ */
    .sidebar-title { font-size: 12px; color: var(--muted); padding: 12px 14px 6px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .quick-list { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
    .quick-btn { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; padding: 6px 10px; cursor: pointer; text-align: left; transition: background .1s, border-color .1s; }
    .quick-btn:hover { background: #1f2937; border-color: var(--blue); color: var(--blue); }
    .quick-output { flex-shrink: 0; border-top: 1px solid var(--border); }
    .quick-output-header { font-size: 11px; color: var(--muted); padding: 8px 14px; display: flex; align-items: center; justify-content: space-between; }
    .quick-output-header button { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px; }
    #quick-result { font-family: "SF Mono", Menlo, monospace; font-size: 11px; color: #8b949e; padding: 8px 14px; max-height: 180px; overflow-y: auto; white-space: pre-wrap; background: #0a0d11; min-height: 40px; }

    /* â”€â”€ Other tabs â”€â”€ */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
    .card h2 { font-size: 13px; color: var(--cyan); margin-bottom: 10px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { text-align: left; padding: 5px 4px; border-bottom: 1px solid #21262d; }
    th { color: var(--muted); font-weight: 500; font-size: 11px; }
    tr:last-child td { border-bottom: none; }
    .ok   { color: var(--green); }
    .warn { color: var(--yellow); }
    .bad  { color: var(--red); }
    .muted { color: var(--muted); font-size: 11px; }
    .chip { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 600; }
    .chip.ok   { background: #1a3a2a; color: var(--green); }
    .chip.warn { background: #3a2a0a; color: var(--yellow); }
    .chip.bad  { background: #3a1a1a; color: var(--red); }
    .chip.muted { background: var(--border); color: var(--muted); }
    .log-box { background: #0a0d11; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: "SF Mono", Menlo, monospace; font-size: 11px; color: #8b949e; max-height: 260px; overflow-y: auto; white-space: pre-wrap; }
    .output-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 9px 12px; margin-bottom: 6px; }
    .output-item .out-title { font-size: 12px; color: var(--text); margin-bottom: 3px; }
    .output-item .out-meta { font-size: 10px; color: var(--muted); display: flex; gap: 8px; }
    .hb-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-bottom: 14px; }
    .hb-item { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; padding: 9px 12px; }
    .hb-key { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
    .hb-val { font-size: 12px; color: var(--text); word-break: break-word; }
    #error-banner { display: none; background: #3a1a1a; border: 1px solid var(--red); color: var(--red); border-radius: 6px; padding: 7px 12px; margin: 10px 20px; font-size: 12px; }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    @media (max-width: 640px) {
      .chat-sidebar { display: none; }
      .msg { max-width: 92%; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ¦¾ ClawDash</h1>
  <div style="display:flex;align-items:center;gap:10px">
    <span id="backend-status" class="bad">âš¡ local</span>
    <span id="last-updated" class="muted">Loadingâ€¦</span>
  </div>
</header>

<div id="error-banner"></div>

<nav class="tabs">
  <button class="tab-btn active" data-tab="overview">ğŸ“Š Overview</button>
  <button class="tab-btn" data-tab="heartbeat">ğŸ’“ Heartbeat</button>
  <button class="tab-btn" data-tab="agents">ğŸ¤– Agents <span class="badge" id="badge-agents">â€¦</span></button>
  <button class="tab-btn" data-tab="chat">ğŸ’¬ Chat <span class="badge" id="badge-chat">â€¦</span></button>
</nav>

<!-- Overview -->
<div id="tab-overview" class="tab-panel active">
  <div class="grid">
    <div class="card"><h2>ğŸ–¥ï¸ System</h2><table id="sys-table"></table></div>
    <div class="card"><h2>ğŸ¤– Agent Status</h2><table id="agent-table"></table></div>
    <div class="card"><h2>ğŸ“š Research Library</h2><table id="research-table"></table></div>
    <div class="card"><h2>ğŸ“ Recent Commits</h2><table id="commit-table"></table></div>
  </div>
</div>

<!-- Heartbeat -->
<div id="tab-heartbeat" class="tab-panel">
  <div class="grid">
    <div class="card" style="grid-column:1/-1">
      <h2>ğŸ’“ Last Heartbeat</h2>
      <div id="hb-grid" class="hb-grid"></div>
      <h2>ğŸ“‹ Supervisor Log</h2>
      <div id="supervisor-log" class="log-box"></div>
    </div>
  </div>
</div>

<!-- Agents -->
<div id="tab-agents" class="tab-panel">
  <div class="card" style="margin-bottom:14px">
    <h2>ğŸ¤– Agent Details</h2>
    <table id="agent-detail-table"></table>
  </div>
  <div class="card">
    <h2>ğŸ“„ Recent Agent Outputs</h2>
    <div id="output-list"></div>
  </div>
</div>

<!-- Chat -->
<div id="tab-chat" class="tab-panel">
  <div class="chat-main">
    <div id="chat-messages"></div>
    <div class="chat-input-wrap">
      <textarea id="chat-input" rows="1" placeholder="Message mewmewâ€¦"></textarea>
      <button id="send-btn">Send â†‘</button>
    </div>
  </div>
  <div class="chat-sidebar">
    <div class="sidebar-title">âš¡ Quick Commands</div>
    <div class="quick-list" id="quick-list"></div>
    <div class="quick-output">
      <div class="quick-output-header">
        <span id="quick-cmd-label" style="color:var(--muted)">output</span>
        <button onclick="clearQuickResult()">âœ•</button>
      </div>
      <div id="quick-result"></div>
    </div>
  </div>
</div>

<script>
// Backend is available when NOT on Vercel (i.e., served by our Node.js server)
const ON_VERCEL = window.location.hostname.includes('vercel.app');
const BACKEND_BASE = ON_VERCEL ? null : ''; // same-origin when on local server

// Auto-detect if we're on local backend
let backendAvailable = false;

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'chat') scrollChat();
  });
});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function chip(l, c) { return `<span class="chip ${c}">${l}</span>`; }
function fmtTs(ts) {
  if (!ts) return '';
  try { return new Date(ts).toISOString().replace('T',' ').slice(0,16)+' UTC'; } catch { return ts; }
}
function fmtTime(ts) {
  if (!ts) return '';
  try { return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; }
}

// â”€â”€ Renders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSystem(d) {
  const s = d.system || {};
  const gw = s.gateway==='up' ? chip('up','ok') : chip('down','bad');
  const disk = s.disk_percent>=90 ? chip(s.disk_percent+'%','bad') : s.disk_percent>=80 ? chip(s.disk_percent+'%','warn') : chip(s.disk_percent+'%','ok');
  const upd = s.updates>0 ? chip(s.updates+' pending','warn') : chip('0','ok');
  document.getElementById('sys-table').innerHTML = `
    <tr><th>Gateway</th><td>${gw}</td></tr>
    <tr><th>Disk</th><td>${disk} <span class="muted">${esc(s.disk_free)} free</span></td></tr>
    <tr><th>Updates</th><td>${upd}</td></tr>
    <tr><th>Git</th><td>${s.git_clean ? chip('clean','ok') : chip('dirty','warn')}</td></tr>
    <tr><th>Memory Index</th><td>${chip(s.memory_age_days+'d', s.memory_age_days<=7?'ok':'warn')}</td></tr>
    <tr><th>Downloads</th><td>${esc(s.downloads_count)} files <span class="muted">${esc(s.downloads_gb)}</span></td></tr>`;
}
function renderAgentSummary(agents) {
  document.getElementById('agent-table').innerHTML = (agents||[]).map(a=>`
    <tr><td>${esc(a.name)}</td><td>${a.active?chip('active','ok'):chip('idle','muted')}</td><td class="muted">${esc(a.last_run)}</td></tr>`).join('');
  document.getElementById('badge-agents').textContent = (agents||[]).filter(a=>a.active).length+'/'+(agents||[]).length;
}
function renderResearch(r) {
  document.getElementById('research-table').innerHTML = `
    <tr><td>Reports</td><td><strong>${esc(r.total)}</strong></td></tr>
    <tr><td>TTS</td><td><span class="${r.tts_coverage==='100%'?'ok':'warn'}">${esc(r.tts_coverage)}</span></td></tr>
    <tr><td>Latest</td><td class="muted" style="font-size:10px">${esc((r.latest||'none').slice(0,40))}</td></tr>
    <tr><td>Hub</td><td>${r.hub_deployed?chip('live','ok'):chip('offline','warn')}</td></tr>`;
}
function renderCommits(commits) {
  document.getElementById('commit-table').innerHTML = (commits||[]).map(c=>`
    <tr><td>${chip(esc(c.agent),'muted')}</td><td style="font-size:11px">${esc(c.message)}</td></tr>`).join('');
}
function renderHeartbeat(hb, log) {
  const checks = hb?.lastChecks || {};
  document.getElementById('hb-grid').innerHTML = Object.entries(checks).map(([k,v])=>`
    <div class="hb-item"><div class="hb-key">${esc(k)}</div><div class="hb-val">${esc(String(v))}</div></div>`).join('') || '<span class="muted">No data.</span>';
  const lb = document.getElementById('supervisor-log');
  lb.textContent = (log||[]).join('\n') || 'No supervisor log.';
  lb.scrollTop = lb.scrollHeight;
}
function renderAgentDetail(agents) {
  document.getElementById('agent-detail-table').innerHTML = '<tr><th>Agent</th><th>Status</th><th>Last Run</th><th>Last Log</th></tr>' +
    (agents||[]).map(a=>`<tr>
      <td><strong>${esc(a.name)}</strong></td>
      <td>${a.active?chip('active','ok'):chip('idle','muted')}</td>
      <td class="muted">${esc(a.last_run)}</td>
      <td class="muted" style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(a.last_line)}">${esc((a.last_line||'').slice(0,70))}</td>
    </tr>`).join('');
}
function renderOutputs(outputs) {
  const el = document.getElementById('output-list');
  el.innerHTML = (outputs||[]).length === 0 ? '<span class="muted">No outputs.</span>' :
    (outputs||[]).map(o=>`<div class="output-item">
      <div class="out-title">${esc(o.title||o.file)}</div>
      <div class="out-meta"><span>ğŸ“… ${esc(o.ts||'â€”')}</span><span>${esc(o.file)}</span><span class="muted">${Math.round((o.size||0)/1024*10)/10}KB</span></div>
    </div>`).join('');
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatData = [];
function renderChat(messages) {
  chatData = messages || [];
  document.getElementById('badge-chat').textContent = chatData.length;
  const container = document.getElementById('chat-messages');
  if (!chatData.length) { container.innerHTML = '<span class="muted" style="padding:16px;display:block">No chat history.</span>'; return; }
  container.innerHTML = chatData.map(m => {
    const role = m.role === 'user' ? 'user' : 'assistant';
    const label = role === 'user' ? 'ğŸ‘¤ def' : 'ğŸ¾ mewmew';
    let text = esc(m.text || '');
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/`([^`\n]+)`/g, '<code style="background:#0d1117;padding:1px 4px;border-radius:3px;font-family:monospace;font-size:11px">$1</code>');
    return `<div class="msg ${role}">
      <div class="msg-bubble">${text}</div>
      <div class="msg-meta">${label} Â· ${fmtTime(m.ts)}</div>
    </div>`;
  }).join('');
  scrollChat();
}
function scrollChat() {
  const c = document.getElementById('chat-messages');
  c.scrollTop = c.scrollHeight;
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

// auto-resize textarea
chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
});
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
sendBtn.addEventListener('click', sendMessage);

async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  if (ON_VERCEL) {
    showError('Chat send requires the local backend. Open http://100.108.208.45:3001 instead of the Vercel URL.');
    return;
  }

  chatInput.value = '';
  chatInput.style.height = 'auto';
  sendBtn.disabled = true;

  // optimistically add user message
  const container = document.getElementById('chat-messages');
  const tempId = 'msg-' + Date.now();
  const div = document.createElement('div');
  div.className = 'msg user sending';
  div.id = tempId;
  div.innerHTML = `<div class="msg-bubble">${esc(text)}</div><div class="msg-meta">ğŸ‘¤ def Â· sendingâ€¦</div>`;
  container.appendChild(div);
  scrollChat();

  try {
    const res = await fetch('/api/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });
    const data = await res.json();
    const el = document.getElementById(tempId);
    if (el) {
      el.classList.remove('sending');
      el.querySelector('.msg-meta').textContent = 'ğŸ‘¤ def Â· ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }
    // refresh chat after short delay to pick up reply
    setTimeout(() => refreshChat(), 3000);
    setTimeout(() => refreshChat(), 8000);
  } catch (e) {
    const el = document.getElementById(tempId);
    if (el) el.querySelector('.msg-bubble').style.borderColor = 'var(--red)';
    showError('Send failed: ' + e.message);
  }
  sendBtn.disabled = false;
}

async function refreshChat() {
  try {
    const res = await fetch('/api/chat');
    if (!res.ok) return;
    const data = await res.json();
    renderChat(data.chat);
  } catch {}
}

// â”€â”€ Quick commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const QUICK_CMDS = [
  { label: 'ğŸ¥ health',        cmd: 'health' },
  { label: 'ğŸ“Š status',        cmd: 'status' },
  { label: 'ğŸ¤– agents',        cmd: 'agents-summary' },
  { label: 'ğŸ’¾ memory status', cmd: 'memory-status' },
  { label: 'ğŸ“ git today',     cmd: 'git-today' },
  { label: 'ğŸ“ git last',      cmd: 'git-last' },
  { label: 'ğŸ• today',         cmd: 'today' },
  { label: 'ğŸ“‹ digest',        cmd: 'digest' },
  { label: 'ğŸ“¥ downloads',     cmd: 'downloads' },
  { label: 'ğŸ” cron status',   cmd: 'cron-status' },
  { label: 'âš ï¸  cron failures', cmd: 'cron-failures' },
  { label: 'ğŸ›¡ï¸  hygiene',       cmd: 'hygiene' },
  { label: 'ğŸ“Œ checkpoints',   cmd: 'checkpoints' },
  { label: 'ğŸ” orphan check',  cmd: 'orphan-check' },
  { label: 'ğŸ“¡ gateway info',  cmd: 'gateway-info' },
  { label: 'ğŸŒŠ supervisor log','cmd': 'supervisor-logs' },
  { label: 'ğŸ“ˆ meta report',   cmd: 'meta-report' },
  { label: 'ğŸ”„ updates check', cmd: 'updates-check' },
];

function buildQuickList() {
  const el = document.getElementById('quick-list');
  el.innerHTML = QUICK_CMDS.map(q => `
    <button class="quick-btn" data-cmd="${esc(q.cmd)}">${esc(q.label)}</button>`).join('');
  el.querySelectorAll('.quick-btn').forEach(btn => {
    btn.addEventListener('click', () => runQuick(btn.dataset.cmd, btn.textContent));
  });
}

async function runQuick(cmd, label) {
  const resultEl = document.getElementById('quick-result');
  const labelEl = document.getElementById('quick-cmd-label');

  if (ON_VERCEL) {
    labelEl.textContent = 'âš ï¸ ' + cmd;
    resultEl.textContent = 'Quick commands require the local backend.\nOpen http://100.108.208.45:3001 instead of the Vercel URL.';
    return;
  }

  labelEl.textContent = 'â³ ' + cmd;
  resultEl.textContent = 'Runningâ€¦';
  try {
    const res = await fetch('/api/quick', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cmd }),
    });
    const data = await res.json();
    labelEl.textContent = 'âœ… ' + cmd;
    resultEl.textContent = data.output || '(no output)';
    resultEl.scrollTop = 0;
  } catch (e) {
    labelEl.textContent = 'âŒ ' + cmd;
    resultEl.textContent = 'Error: ' + e.message + '\n\n(backend not available â€” run server.js locally)';
  }
}

function clearQuickResult() {
  document.getElementById('quick-result').textContent = '';
  document.getElementById('quick-cmd-label').textContent = 'output';
}

// â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function load() {
  try {
    let data;

    if (!ON_VERCEL) {
      // Local backend â€” live data
      try {
        const res = await fetch('/api/data', { signal: AbortSignal.timeout(8000) });
        if (res.ok) {
          data = await res.json();
          backendAvailable = true;
          const bs = document.getElementById('backend-status');
          bs.textContent = 'âš¡ live';
          bs.className = 'ok';
        }
      } catch {}
    }

    // fallback to static data.json (Vercel / offline)
    if (!data) {
      const res = await fetch('/data.json?bust=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      data = await res.json();
      backendAvailable = false;
      const bs = document.getElementById('backend-status');
      bs.textContent = ON_VERCEL ? 'ğŸ“¦ static (open :3001 for live)' : 'ğŸ“¦ static';
      bs.className = 'bad';
    }

    renderSystem(data);
    renderAgentSummary(data.agents);
    renderResearch(data.research);
    renderCommits(data.recent_commits);
    renderHeartbeat(data.heartbeat, data.supervisor_log);
    renderAgentDetail(data.agents);
    renderOutputs(data.agent_outputs);
    renderChat(data.chat || []);
    document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();
    document.getElementById('error-banner').style.display = 'none';
  } catch (e) {
    showError('Load failed: ' + e.message);
  }
}

function showError(msg) {
  const b = document.getElementById('error-banner');
  b.textContent = 'âš ï¸ ' + msg;
  b.style.display = 'block';
  document.getElementById('last-updated').textContent = 'Error';
}

document.addEventListener('DOMContentLoaded', () => {
  buildQuickList();
  load();
  setInterval(load, 60000);
  if (ON_VERCEL) {
    chatInput.placeholder = 'Chat requires local backend â€” open http://100.108.208.45:3001';
    chatInput.disabled = true;
    sendBtn.disabled = true;
    sendBtn.title = 'Not available on Vercel';
  }
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
});
</script>
</body>
</html>
