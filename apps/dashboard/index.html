<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mewmew's Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ff79c6" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffb86c" media="(prefers-color-scheme: light)">
  <!-- Kawaii theme stylesheet -->
  <link rel="stylesheet" href="kawaii.css">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MewDash">
  <link rel="apple-touch-icon" href="/icon-192.svg">
  <!-- Android / general -->
  <link rel="icon" type="image/svg+xml" href="/icon-192.svg">
  <link rel="icon" type="image/svg+xml" sizes="512x512" href="/icon-512.svg">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="MewDash">
  <meta name="description" content="Kawaii cyberpunk dashboard â€” powered by mewmew">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117; --surface: #161b22; --border: #30363d;
      --text: #e6edf3; --muted: #8b949e;
      --blue: #58a6ff; --green: #7ee787; --yellow: #d29922;
      --red: #ff7b72; --purple: #bc8cff; --cyan: #79c0ff;
    }
    [data-theme="light"] {
      --bg: #f6f8fa; --surface: #ffffff; --border: #d0d7de;
      --text: #1f2328; --muted: #656d76;
      --blue: #0969da; --green: #1a7f37; --yellow: #9a6700;
      --red: #cf222e; --purple: #8250df; --cyan: #0550ae;
    }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100dvh; transition: background .2s, color .2s; overflow: hidden; }

    header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 8px 14px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    header h1 { font-size: 17px; color: var(--blue); display: flex; align-items: center; gap: 8px; }
    .header-right { display: flex; align-items: center; gap: 8px; }
    #last-updated { font-size: 11px; color: var(--muted); }
    #conn-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; transition: background .3s; flex-shrink: 0; }
    #conn-dot.bad { background: var(--red); }
    #conn-dot.warn { background: var(--yellow); }
    #backend-status { font-size: 11px; padding: 2px 8px; border-radius: 10px; cursor: default; }
    #backend-status.ok  { background: #1a3a2a; color: var(--green); }
    #backend-status.bad { background: #3a1a1a; color: var(--red); }
    [data-theme="light"] #backend-status.ok  { background: #d4edda; }
    [data-theme="light"] #backend-status.bad { background: #f8d7da; }
    #theme-btn { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); cursor: pointer; font-size: 14px; padding: 3px 7px; line-height: 1; }
    #theme-btn:hover { color: var(--text); border-color: var(--text); }

    .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 16px; overflow-x: auto; flex-shrink: 0; }
    .tab-btn { padding: 10px 12px; font-size: 12px; color: var(--muted); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: color .15s, border-color .15s; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
    .badge { display: inline-block; background: var(--border); color: var(--muted); border-radius: 10px; padding: 1px 6px; font-size: 10px; margin-left: 4px; }
    .tab-btn.active .badge { background: #1f3a5a; color: var(--blue); }
    [data-theme="light"] .tab-btn.active .badge { background: #dbeafe; color: var(--blue); }

    #tab-panels { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .tab-panel { display: none; }
    .tab-panel.active { display: flex; flex-direction: column; flex: 1; min-height: 0; padding: 16px 20px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; overflow-y: auto; }

    /* â”€â”€ Chat tab â€” full height, no padding â”€â”€ */
    #tab-chat.active { padding: 0; max-width: 100%; flex-direction: row; overflow: hidden; height: 100%; }
    .chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }
    #chat-messages { flex: 1; overflow-y: auto; padding: 12px 14px; display: flex; flex-direction: column; gap: 8px; min-height: 0; }
    .chat-sidebar { width: 260px; flex-shrink: 0; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }

    .msg { display: flex; flex-direction: column; max-width: 75%; }
    .msg.user { align-self: flex-end; align-items: flex-end; }
    .msg.assistant { align-self: flex-start; align-items: flex-start; }
    .msg-bubble { padding: 9px 13px; border-radius: 12px; font-size: 13px; line-height: 1.55; white-space: pre-wrap; word-break: break-word; }
    .msg.user .msg-bubble { background: #1f3a5a; color: var(--text); border-bottom-right-radius: 3px; }
    .msg-avatar { font-size: 22px; line-height: 1; flex-shrink: 0; margin-top: 2px; }
    .msg.user { align-items: flex-end; }
    .msg.assistant { align-items: flex-start; }
    .msg-row { display: flex; gap: 6px; align-items: flex-end; }
    .msg.user .msg-row { flex-direction: row-reverse; }
    .msg.assistant .msg-bubble { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-bottom-left-radius: 3px; }
    [data-theme="light"] .msg.user .msg-bubble { background: #dbeafe; }
    .msg-meta { font-size: 10px; color: var(--muted); margin-top: 3px; }
    .msg.sending .msg-bubble { opacity: 0.6; }
    .msg.typing .msg-bubble { background: var(--surface); border: 1px solid var(--border); }
    .typing-dots span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--muted); margin: 0 2px; animation: bounce 1.2s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: .2s; }
    .typing-dots span:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

    /* â”€â”€ Chat input â”€â”€ */
    .chat-input-wrap { border-top: 1px solid var(--border); padding: 12px 16px; display: flex; gap: 8px; background: var(--surface); flex-shrink: 0; }
    #chat-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); padding: 9px 12px; font-size: 13px; resize: none; font-family: inherit; line-height: 1.4; max-height: 120px; outline: none; transition: border-color .15s; }
    #chat-input:focus { border-color: var(--blue); }
    #send-btn { background: var(--blue); color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-size: 14px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: opacity .15s; min-width: 64px; }
    #send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #send-btn:hover:not(:disabled) { opacity: 0.85; }

    /* â”€â”€ Quick commands sidebar â”€â”€ */
    .sidebar-title { font-size: 12px; color: var(--muted); padding: 12px 14px 6px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .quick-list { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
    .quick-btn { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; padding: 6px 10px; cursor: pointer; text-align: left; transition: background .1s, border-color .1s; }
    .quick-btn:hover { background: #1f2937; border-color: var(--blue); color: var(--blue); }
    [data-theme="light"] .quick-btn:hover { background: #dbeafe; }
    .quick-output { flex-shrink: 0; border-top: 1px solid var(--border); }
    .quick-output-header { font-size: 11px; color: var(--muted); padding: 8px 14px; display: flex; align-items: center; justify-content: space-between; }
    .quick-output-header button { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px; }
    #quick-result { font-family: "SF Mono", Menlo, monospace; font-size: 11px; color: #8b949e; padding: 8px 14px; max-height: 180px; overflow-y: auto; white-space: pre-wrap; background: #0a0d11; min-height: 40px; }
    [data-theme="light"] #quick-result { background: #f6f8fa; color: var(--muted); }

    /* â”€â”€ Command palette â”€â”€ */
    #palette-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 100; align-items: flex-start; justify-content: center; padding-top: 15vh; }
    #palette-overlay.open { display: flex; }
    #palette-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; width: 480px; max-width: 90vw; overflow: hidden; box-shadow: 0 16px 48px rgba(0,0,0,.5); }
    #palette-input { width: 100%; background: none; border: none; border-bottom: 1px solid var(--border); color: var(--text); font-size: 14px; padding: 14px 16px; outline: none; }
    #palette-list { max-height: 320px; overflow-y: auto; }
    .palette-item { padding: 9px 16px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; }
    .palette-item:hover, .palette-item.sel { background: #1f2937; }
    [data-theme="light"] .palette-item:hover, [data-theme="light"] .palette-item.sel { background: #dbeafe; }
    .palette-shortcut { margin-left: auto; font-size: 10px; color: var(--muted); background: var(--border); padding: 1px 5px; border-radius: 4px; }

    /* â”€â”€ Toast notifications â”€â”€ */
    #toast-wrap { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 200; pointer-events: none; }
    .toast { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 9px 14px; font-size: 12px; color: var(--text); box-shadow: 0 4px 12px rgba(0,0,0,.3); animation: slide-in .2s ease; max-width: 280px; }
    .toast.ok   { border-color: var(--green); }
    .toast.bad  { border-color: var(--red); }
    .toast.fade { animation: fade-out .3s ease forwards; }
    @keyframes slide-in { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform: none; } }
    @keyframes fade-out { to { opacity:0; transform: translateY(12px); } }

    /* â”€â”€ Other tabs â”€â”€ */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
    .card h2 { font-size: 13px; color: var(--cyan); margin-bottom: 10px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
    th, td { text-align: left; padding: 5px 4px; border-bottom: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    th { color: var(--muted); font-weight: 500; font-size: 11px; }
    tr:last-child td { border-bottom: none; }
    .ok   { color: var(--green); }
    .warn { color: var(--yellow); }
    .bad  { color: var(--red); }
    .muted { color: var(--muted); font-size: 11px; }
    .chip { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 600; }
    .chip.ok   { background: #1a3a2a; color: var(--green); }
    .chip.warn { background: #3a2a0a; color: var(--yellow); }
    .chip.bad  { background: #3a1a1a; color: var(--red); }
    .chip.muted { background: var(--border); color: var(--muted); }
    [data-theme="light"] .chip.ok   { background: #d4edda; }
    [data-theme="light"] .chip.warn { background: #fff3cd; }
    [data-theme="light"] .chip.bad  { background: #f8d7da; }
    .log-box { background: #0a0d11; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: "SF Mono", Menlo, monospace; font-size: 11px; color: #8b949e; max-height: 260px; overflow-y: auto; white-space: pre-wrap; }
    [data-theme="light"] .log-box { background: #f6f8fa; }
    .log-box .log-err  { color: var(--red); }
    .log-box .log-warn { color: var(--yellow); }
    .output-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 9px 12px; margin-bottom: 6px; }
    .output-item .out-title { font-size: 12px; color: var(--text); margin-bottom: 3px; }
    .output-item .out-meta { font-size: 10px; color: var(--muted); display: flex; gap: 8px; }
    .hb-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-bottom: 14px; }
    .hb-item { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; padding: 9px 12px; }
    [data-theme="light"] .hb-item { background: #f6f8fa; }
    .hb-key { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
    .hb-val { font-size: 12px; color: var(--text); word-break: break-word; }
    #error-banner { display: none; background: #3a1a1a; border: 1px solid var(--red); color: var(--red); border-radius: 6px; padding: 7px 12px; margin: 10px 20px; font-size: 12px; }

    /* â”€â”€ Disk bar â”€â”€ */
    .disk-bar-wrap { margin-top: 4px; }
    .disk-bar-bg { background: var(--border); border-radius: 4px; height: 6px; overflow: hidden; }
    .disk-bar-fill { height: 100%; border-radius: 4px; transition: width .4s; }

    /* â”€â”€ Sparkline â”€â”€ */
    .sparkline { display: block; }

    /* â”€â”€ Timeline â”€â”€ */
    .timeline { display: flex; flex-direction: column; gap: 6px; }
    .tl-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .tl-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .tl-name { min-width: 120px; }
    .tl-bar-wrap { flex: 1; background: var(--border); border-radius: 3px; height: 4px; }
    .tl-bar { height: 4px; border-radius: 3px; background: var(--blue); }
    .tl-age { min-width: 60px; text-align: right; color: var(--muted); font-size: 10px; }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    @media (max-width: 640px) {
      .chat-sidebar { display: none; }
      .msg { max-width: 92%; }
      .header-right #last-updated { display: none; }
      .header-right #backend-status { display: none; }
      header h1 span.subtitle { display: none; }
    }

    /* â”€â”€ Quick commands bottom sheet â”€â”€ */
    @media (max-width: 640px) {
      .cron-schedule, .cron-next, .cron-dur { display: none; }
      .cron-last { display: none; }
    }
    #quick-sheet-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); cursor: pointer; font-size: 18px; padding: 8px 10px; line-height: 1; flex-shrink: 0; transition: color .15s; }
    #quick-sheet-btn:hover { color: var(--text); }
    #quick-sheet-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 300; }
    #quick-sheet-overlay.open { display: block; }
    #quick-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-radius: 16px 16px 0 0; border-top: 1px solid var(--border); z-index: 301; max-height: 60vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform .25s ease; }
    #quick-sheet.open { transform: translateY(0); }
    #quick-sheet-header { padding: 12px 16px 8px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    #quick-sheet-header span { font-size: 13px; font-weight: 600; color: var(--text); }
    #quick-sheet-header button { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px; }
    #quick-sheet-list { overflow-y: auto; padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .qs-btn { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 12px; color: var(--text); cursor: pointer; text-align: left; transition: background .15s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .qs-btn:hover, .qs-btn:active { background: var(--border); }

  </style>

  <!-- Kawaii Cyberpunk Theme Overrides -->
  <style>
    :root {
      --bg: #0b0e14;
      --surface: rgba(22, 27, 34, 0.8);
      --surface-opaque: #161b22;
      --border: rgba(98, 114, 164, 0.3);
      --text: #f8f8f2;
      --muted: #6272a4;
      --primary: #ff79c6;
      --secondary: #8be9fd;
      --accent: #50fa7b;
      --warning: #ffb86c;
      --error: #ff5555;
      --purple: #bd93f9;
      --glow: 0 0 10px var(--primary);
      --radius: 12px;
      --shadow: 0 8px 32px 0 rgba(0,0,0,0.5);
    }
    body {
      background-color: var(--bg);
      background-image: 
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
      background-size: 100% 4px, 3px 100%;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .card {
      background: var(--surface);
      backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
      overflow: hidden;
    }
    .card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px 0 rgba(255,121,198,0.15);
    }
    .card h2 {
      color: var(--secondary);
      border-bottom: 1px solid var(--border);
      background: rgba(139,233,253,0.05);
    }
    .tab-btn {
      color: var(--muted);
      border-radius: 8px 8px 0 0;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      color: var(--text);
      background: rgba(255,121,198,0.1);
    }
    .tab-btn.active {
      color: var(--primary);
      background: rgba(255,121,198,0.15);
      border-bottom: 2px solid var(--primary);
      box-shadow: 0 -4px 12px var(--glow);
    }
    .badge { background: var(--primary); color: var(--bg); }
    .chip.ok { background: var(--accent); color: var(--bg); }
    .chip.warn { background: var(--warning); color: var(--bg); }
    .chip.bad { background: var(--error); }
    .chip.info { background: var(--secondary); color: var(--bg); }
    .btn-primary {
      background: var(--primary);
      color: var(--bg);
      box-shadow: 2px 2px 0px var(--secondary);
    }
    .btn-primary:hover {
      box-shadow: 0 0 15px var(--glow);
      transform: scale(1.02);
    }
    .btn-primary:active {
      box-shadow: 0 0 0 transparent;
      transform: translate(1px,1px);
    }
    .tl-bar { background: var(--secondary); }
    tr:hover td { background: rgba(255,121,198,0.08); }
    .scanlines {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px);
      z-index: 9999;
    }
    @media (max-width: 640px) {
      :root { --radius: 16px; }
      .tab-btn { font-size: 11px; padding: 12px 6px; }
    }
  </style>

  <div class="scanlines"></div>
</head>
<body>

<header>
  <h1>ğŸ€ MewDash</h1>
  <div class="header-right">
    <span id="conn-dot" title="Connection status"></span>
    <span id="backend-status" class="bad">loading</span>
    <button id="push-btn" title="Enable push notifications" onclick="togglePush()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;font-size:16px;padding:4px 8px;line-height:1;">ğŸ”•</button>
    <button id="theme-btn" class="theme-toggle" title="Toggle theme">ğŸŒˆ</button>
    <span id="last-updated" class="muted">Loadingâ€¦</span>
  </div>
</header>

<div id="error-banner"></div>

<nav class="tabs">
  <button class="tab-btn active" data-tab="overview">ğŸ  Home</button>
  <button class="tab-btn" data-tab="heartbeat">ğŸ’— Pulse</button>
  <button class="tab-btn" data-tab="agents">ğŸ‘¥ Crew <span class="badge" id="badge-agents">â€¦</span></button>
  <button class="tab-btn" data-tab="chat">âœ‰ï¸ Messages <span class="badge" id="badge-chat">â€¦</span></button>
  <button class="tab-btn" data-tab="cron">â±ï¸ Schedule</button>
  <button class="tab-btn" data-tab="projects">ğŸ“‚ğŸ’¿ Projects <span class="badge" id="badge-projects">â€¦</span></button>
  <button class="tab-btn" data-tab="tokens">ğŸ’ Tokens</button>
  <button class="tab-btn" data-tab="downloads">ğŸ“¥ Downloads</button>
  <button class="tab-btn" onclick="load();toast('ğŸ”„ Refreshingâ€¦','ok',1500)" title="Refresh">ğŸ”„</button>
</nav>

<div id="tab-panels">

<!-- Overview -->
<div id="tab-overview" class="tab-panel active">
  <div class="grid">
    <div class="card"><h2>ğŸ–¥ï¸ System</h2><table id="sys-table"></table></div>
    <div class="card"><h2>ğŸ¤– Agent Status</h2><div id="agent-timeline" class="timeline" style="margin-bottom:10px"></div><table id="agent-table"></table></div>
    <div class="card"><h2>ğŸ“š Research Library</h2><table id="research-table"></table></div>
    <div class="card"><h2>ğŸ“ Recent Commits</h2><table id="commit-table"></table></div>
    <div class="card"><h2>â° Cron Jobs</h2><table id="cron-table"></table></div>
    <div class="card"><h2>ğŸ“° Content Stats</h2><table id="content-table"></table></div>
    <div class="card">
      <div class="card-title">ğŸ§² Downloads</div>
      <div id="torrent-card"><span style="color:var(--muted);font-size:12px">Loadingâ€¦</span></div>
    </div>
  </div>
</div>

<!-- Heartbeat -->
<div id="tab-heartbeat" class="tab-panel">
  <div class="grid">
    <div class="card" style="grid-column:1/-1">
      <h2>ğŸ’“ Last Heartbeat</h2>
      <div id="hb-grid" class="hb-grid"></div>
      <div id="hb-notes" style="display:none;background:#1a3a2a;border:1px solid var(--green);border-radius:6px;padding:9px 12px;font-size:12px;color:var(--green);margin-bottom:12px;"></div>
      <h2 style="margin-top:4px">ğŸ“‹ Supervisor Log</h2>
      <div id="supervisor-log" class="log-box"></div>
    </div>
  </div>
</div>

<!-- Agents -->
<div id="tab-agents" class="tab-panel">
  <div class="grid" style="margin-bottom:14px">
    <div class="card">
      <h2>ğŸ¤– Agent Details</h2>
      <table id="agent-detail-table"></table>
    </div>
    <div class="card">
      <h2>ğŸ“„ Recent Content</h2>
      <div id="output-list"></div>
    </div>
  </div>
  <div class="card">
    <h2>ğŸ§  Active Tasks</h2>
    <div id="active-tasks-list" class="muted" style="font-size:12px">Loadingâ€¦</div>
  </div>
</div>

<!-- Chat -->
<div id="tab-chat" class="tab-panel">
  <div id="push-banner" style="display:none;padding:8px 14px;align-items:center;justify-content:space-between;gap:10px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;">
    <span style="font-size:13px;color:var(--muted)">ğŸ”” Get notified when mewmew replies</span>
    <button onclick="setupPush().then(()=>document.getElementById('push-banner').style.display='none');" style="background:var(--blue);color:#fff;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:13px;font-weight:600;">Enable</button>
    <button onclick="document.getElementById('push-banner').style.display='none';localStorage.setItem('push-dismissed','1');" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;line-height:1;">âœ•</button>
  </div>
  <div class="chat-main">
    <div id="chat-messages"></div>
    <div class="chat-input-wrap">
      <textarea id="chat-input" rows="1" placeholder="Message mewmewâ€¦ (Cmd+K for commands)"></textarea>
      <span id="chat-char-count" style="font-size:10px;color:var(--muted);align-self:center;white-space:nowrap;"></span>
      <button id="quick-sheet-btn" title="Quick commands" onclick="openQuickSheet()">âš¡</button>
      <button id="send-btn">Send â†‘</button>
    </div>
  </div>
  <div class="chat-sidebar">
    <div class="sidebar-title">âš¡ Quick Commands</div>
    <div class="quick-list" id="quick-list"></div>
    <div class="quick-output">
      <div class="quick-output-header">
        <span id="quick-cmd-label" style="color:var(--muted)">output</span>
        <button onclick="clearQuickResult()">âœ•</button>
      </div>
      <div id="quick-result"></div>
    </div>
  </div>
</div>

<!-- Command Palette -->
<div id="palette-overlay">
  <div id="palette-box">
    <input id="palette-input" placeholder="âŒ˜K â€” Type a commandâ€¦" autocomplete="off" spellcheck="false">
    <div id="palette-list"></div>
  </div>
</div>

<!-- Cron tab -->
<div id="tab-cron" class="tab-panel" style="padding:0;overflow:hidden;flex-direction:column">
  <div style="padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
    <span style="font-weight:600;font-size:14px">â° Cron Jobs</span>
    <span id="cron-tab-summary" style="font-size:11px;color:var(--muted)"></span>
  </div>
  <div style="overflow-y:auto;flex:1;padding:10px 14px" id="cron-tab-list"></div>
</div>

<!-- Projects tab -->
<div id="tab-projects" class="tab-panel">
  <div class="grid" id="projects-grid"></div>
</div>

<!-- Tokens tab -->
<div id="tab-tokens" class="tab-panel">
  <div class="card" style="grid-column:1/-1">
    <h2>ğŸ’ Token Usage</h2>
    <div id="tokens-summary" style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap"></div>
    <div id="tokens-empty" style="display:none;font-size:12px;color:var(--muted);padding:20px;text-align:center">No token data available</div>
    <table style="width:100%">
      <thead>
        <tr>
          <th>Job</th>
          <th>In</th>
          <th>Out</th>
          <th>Total</th>
          <th>Cost</th>
          <th>Last Run</th>
        </tr>
      </thead>
      <tbody id="tokens-tbody"></tbody>
    </table>
  </div>
</div>

<!-- Downloads tab -->
<div id="tab-downloads" class="tab-panel">
  <div class="card" style="grid-column:1/-1">
    <h2>ğŸ“¦ Downloads</h2>
    <div id="dl-summary" style="font-size:11px;color:var(--muted);margin-bottom:10px"></div>
    <div id="dl-list"></div>
  </div>
</div>

</div><!-- #tab-panels -->

<!-- Kawaii Mascot Sidebar -->
<div id="mascot-sidebar" class="mascot-sidebar">
  <div class="mascot-container" title="Hi! I'm mewmew~">
    <svg viewBox="0 0 100 120" class="mascot-svg">
      <!-- Head -->
      <circle cx="50" cy="60" r="40" fill="#ff79c6" stroke="#ffb86c" stroke-width="3"/>
      <!-- Ears -->
      <polygon points="20,35 30,50 10,50" fill="#ff79c6" stroke="#ffb86c" stroke-width="2"/>
      <polygon points="80,35 70,50 90,50" fill="#ff79c6" stroke="#ffb86c" stroke-width="2"/>
      <!-- Inner ears -->
      <polygon points="22,42 28,50 15,50" fill="#ffb86c"/>
      <polygon points="78,42 72,50 85,50" fill="#ffb86c"/>
      <!-- Face -->
      <ellipse cx="38" cy="55" rx="5" ry="7" fill="#0b0e14"/>
      <ellipse cx="62" cy="55" rx="5" ry="7" fill="#0b0e14"/>
      <ellipse cx="50" cy="50" rx="6" ry="4" fill="#0b0e14"/>
      <!-- Blush -->
      <ellipse cx="30" cy="70" rx="8" ry="5" fill="#ff6b9d" opacity="0.6"/>
      <ellipse cx="70" cy="70" rx="8" ry="5" fill="#ff6b9d" opacity="0.6"/>
      <!-- Mouth :3 -->
      <path d="M 40 75 Q 50 82 60 75" stroke="#0b0e14" stroke-width="3" fill="none" stroke-linecap="round"/>
      <!-- Whiskers -->
      <line x1="15" y1="60" x2="30" y2="65" stroke="#0b0e14" stroke-width="2"/>
      <line x1="15" y1="70" x2="30" y2="70" stroke="#0b0e14" stroke-width="2"/>
      <line x1="85" y1="60" x2="70" y2="65" stroke="#0b0e14" stroke-width="2"/>
      <line x1="85" y1="70" x2="70" y2="70" stroke="#0b0e14" stroke-width="2"/>
      <!-- Paw wave (right) -->
      <g class="wave-hand">
        <circle cx="85" cy="85" r="8" fill="#ff79c6" stroke="#ffb86c" stroke-width="2"/>
      </g>
    </svg>
    <div class="speech-bubble" id="mascot-bubble">Nya~!</div>
  </div>
  <button class="mascot-toggle" id="mascot-toggle" title="Toggle mascot">ğŸ“¦</button>
</div>
<!-- Quick commands bottom sheet -->
<div id="quick-sheet-overlay" onclick="closeQuickSheet()"></div>
<div id="quick-sheet">
  <div style="width:40px;height:4px;background:var(--border);border-radius:2px;margin:10px auto 0;"></div>
  <div id="quick-sheet-header">
    <span>âš¡ Quick Commands</span>
    <button onclick="closeQuickSheet()">âœ•</button>
  </div>
  <div id="quick-sheet-list"></div>
  <div id="quick-sheet-result-wrap" style="display:none;border-top:1px solid var(--border);background:#0a0d11;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 12px;">
      <span id="qs-result-label" style="font-size:11px;color:var(--muted)">output</span>
      <button onclick="document.getElementById('quick-sheet-result-wrap').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;">âœ•</button>
    </div>
    <pre id="quick-sheet-result" style="margin:0;padding:0 12px 12px;font-size:11px;color:#8b949e;max-height:140px;overflow-y:auto;white-space:pre-wrap;font-family:monospace;"></pre>
  </div>
</div>


<!-- Toast container -->
<div id="toast-wrap"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ON_VERCEL = window.location.hostname.includes('vercel.app');
let backendAvailable = false;
let activeTab = localStorage.getItem('clawdash-tab') || 'overview';
let chatPollTimer = null;
let chatReplyWatcher = null;  // for sendMessage reply polling
let projectsAbortController = null;
let typingMsgId = null;

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('theme-btn').textContent = t === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('clawdash-theme', t);
}
const savedTheme = localStorage.getItem('clawdash-theme') || 'dark';
applyTheme(savedTheme);
document.getElementById('theme-btn').addEventListener('click', () => {
  applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
});

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, kind = 'ok', ms = 3000) {
  const wrap = document.getElementById('toast-wrap');
  const el = document.createElement('div');
  el.className = 'toast ' + kind;
  el.textContent = msg;
  wrap.appendChild(el);
  setTimeout(() => {
    el.classList.add('fade');
    el.addEventListener('animationend', () => el.remove());
  }, ms);
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + tab));
  activeTab = tab;
  localStorage.setItem('clawdash-tab', tab);
  if (tab === 'chat') {
    setTimeout(scrollChat, 50); startChatPoll();
    // Show push banner if not subscribed and not dismissed
    const banner = document.getElementById('push-banner');
    if (banner && !pushSubscribed && !ON_VERCEL && !localStorage.getItem('push-dismissed')) {
      banner.style.display = 'flex';
    }
  } else { stopChatPoll(); }
  if (tab === 'tokens') loadTokens();
  if (tab === 'downloads') loadDownloads();
  if (tab === 'projects') loadProjects();
}
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function chip(l, c) { return `<span class="chip ${c}">${l}</span>`; }

function fmtDuration(ms) {
  // returns plain duration like "7m", "2h", "3d"
  const s = Math.floor(Math.abs(ms) / 1000);
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  return Math.floor(s/86400) + 'd';
}
function timeAgoMs(ms) {
  return fmtDuration(ms) + ' ago';
}
function timeAgo(ts) {
  if (!ts) return '';
  const d = typeof ts === 'number' ? new Date(ts * 1000) : new Date(ts);
  if (isNaN(d)) return ts;
  const s = Math.floor((Date.now() - d) / 1000);
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}
function fmtTime(ts) {
  if (!ts) return '';
  try { return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; }
}

function diskColor(pct) {
  if (pct >= 90) return 'var(--red)';
  if (pct >= 80) return 'var(--yellow)';
  return 'var(--green)';
}

// â”€â”€ Renders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSystem(d) {
  const s = d.system || {};
  const gw = s.gateway==='up' ? chip('up','ok') : chip('down','bad');
  const diskPct = parseInt(s.disk_percent) || 0;
  const diskChip = diskPct>=90 ? chip(diskPct+'%','bad') : diskPct>=80 ? chip(diskPct+'%','warn') : chip(diskPct+'%','ok');
  const diskBar = `<div class="disk-bar-wrap">
    <div class="disk-bar-bg"><div class="disk-bar-fill" style="width:${diskPct}%;background:${diskColor(diskPct)}"></div></div>
  </div>`;
  const sparkHtml = renderSparkline(d.disk_history || []);
  const upd = s.updates>0 ? chip(s.updates+' pending','warn') : chip('0','ok');
  document.getElementById('sys-table').innerHTML = `
    <tr><th>Gateway</th><td>${gw}</td></tr>
    <tr><th>Disk</th><td>${diskChip} <span class="muted">${esc(s.disk_free)} free</span>${diskBar}</td></tr>
    ${sparkHtml ? `<tr><th>Disk Trend</th><td>${sparkHtml}</td></tr>` : ''}
    <tr><th>Updates</th><td>${upd}</td></tr>
    <tr><th>Git</th><td>${s.git_clean ? chip('clean','ok') : chip('dirty','warn')}</td></tr>
    <tr><th>Memory Index</th><td>${chip(s.memory_age_days+'d', s.memory_age_days<=7?'ok':'warn')}</td></tr>
    <tr><th>Downloads</th><td>${esc(s.downloads_count)} files <span class="muted">${esc(s.downloads_gb)}</span></td></tr>`;
}

function renderSparkline(history) {
  if (!history || history.length < 2) return '';
  const w = 120, h = 24, pad = 2;
  const vals = history.map(v => parseFloat(v) || 0);
  const min = Math.min(...vals), max = Math.max(...vals);
  const range = max - min || 1;
  const pts = vals.map((v, i) => {
    const x = pad + (i / (vals.length - 1)) * (w - pad*2);
    const y = h - pad - ((v - min) / range) * (h - pad*2);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  const last = vals[vals.length-1];
  const col = last >= 90 ? 'var(--red)' : last >= 80 ? 'var(--yellow)' : 'var(--green)';
  return `<svg class="sparkline" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <polyline points="${pts}" fill="none" stroke="${col}" stroke-width="1.5" stroke-linejoin="round"/>
  </svg>`;
}

function parseAgentTs(last_run) {
  // last_run is like "2026-02-28 10:06" (UTC)
  if (!last_run) return null;
  try { return new Date(last_run.replace(' ', 'T') + ':00Z').getTime(); } catch { return null; }
}
function renderAgentSummary(agents) {
  // Timeline
  const now = Date.now();
  const tl = document.getElementById('agent-timeline');
  tl.innerHTML = (agents||[]).map(a => {
    const ts = a.last_run_ts ? a.last_run_ts * 1000 : parseAgentTs(a.last_run);
    const age = ts ? Math.max(0, now - ts) : null;
    const maxAge = 24 * 3600 * 1000;
    const pct = age !== null ? Math.max(4, 100 - (age / maxAge * 100)) : 4;
    const dot = a.active ? 'var(--green)' : 'var(--muted)';
    const ageStr = age !== null ? timeAgoMs(age) : 'â€”';
    return `<div class="tl-item">
      <div class="tl-dot" style="background:${dot}"></div>
      <div class="tl-name muted">${esc(a.name)}</div>
      <div class="tl-bar-wrap"><div class="tl-bar" style="width:${pct.toFixed(0)}%"></div></div>
      <div class="tl-age">${ageStr}</div>
    </div>`;
  }).join('');

  document.getElementById('agent-table').innerHTML = (agents||[]).map(a=>{
    const ts = a.last_run_ts ? a.last_run_ts * 1000 : parseAgentTs(a.last_run);
    const age = ts ? timeAgoMs(Date.now() - ts) : esc(a.last_run||'â€”');
    return `<tr><td>${esc(a.name)}</td><td>${a.active?chip('active','ok'):chip('idle','muted')}</td><td class="muted">${age}</td></tr>`;
  }).join('');
  document.getElementById('badge-agents').textContent = (agents||[]).filter(a=>a.active).length+'/'+(agents||[]).length;
}

function renderResearch(r) {
  // Clean up latest â€” strip "INDEX\nnone" junk
  let latest = (r.latest || 'none').replace(/^INDEX\s*/,'').replace(/^none$/i,'â€”').trim();
  // no hard truncation â€” let CSS handle it
  const covPct = parseInt(r.tts_coverage) || 0;
  const covCol = covPct >= 95 ? 'ok' : covPct >= 80 ? 'warn' : 'bad';
  document.getElementById('research-table').innerHTML = `
    <tr><td>Reports</td><td><strong>${esc(r.total)}</strong></td></tr>
    <tr><td>TTS audio</td><td><span class="${covCol}">${esc(r.tts_coverage)}</span></td></tr>
    <tr><td>Latest</td><td class="muted" style="font-size:10px;word-break:break-word">${esc(latest)}</td></tr>
    <tr><td>Hub</td><td>${r.hub_deployed?chip('live','ok'):chip('offline','warn')}</td></tr>`;
}

function renderCommits(commits) {
  document.getElementById('commit-table').innerHTML = '<tr><th>Sha</th><th>Message</th><th>When</th></tr>' +
    (commits||[]).map(c=>{
      const prefix = (c.message||'').match(/^(\w[\w-]*(?:\(.+?\))?):/) ?
        c.message.split(':')[0] : (c.agent||'misc');
      const msg = (c.message||'').replace(/^[^:]+:\s*/,'');
      const chipCls = prefix.startsWith('feat') ? 'ok' : prefix.startsWith('fix') ? 'warn' : prefix.startsWith('build') ? 'ok' : 'muted';
      return `<tr>
        <td><code style="font-size:10px;color:var(--muted)">${esc((c.sha||'').slice(0,7))}</code></td>
        <td style="font-size:11px;white-space:normal;word-break:break-word" title="${esc(c.message||'')}">${chip(esc(prefix), chipCls)} ${esc(msg)}</td>
        <td class="muted" style="font-size:10px;white-space:nowrap">${esc(c.time||'')}</td>
      </tr>`;
    }).join('');
}
function renderContentStats(cs) {
  const el = document.getElementById('content-table');
  if (!el || !cs) return;
  el.innerHTML = `
    <tr><th>Total pieces</th><td><strong>${esc(cs.total||0)}</strong></td></tr>
    <tr><th>Today</th><td><span class="ok">${esc(cs.today||0)}</span></td></tr>
    <tr><th>This week</th><td>${esc(cs.week||0)}</td></tr>
    <tr><th>Latest</th><td class="muted" style="font-size:10px;word-break:break-word">${esc(cs.latest_title||'â€”')}</td></tr>
  `;
}
function renderCron(crons) {
  const el = document.getElementById('cron-table');
  if (!el) return;
  if (!crons || !crons.length) { el.innerHTML = '<tr><td class="muted">No cron data.</td></tr>'; return; }
  const enabled = crons.filter(c => c.enabled !== false);
  el.innerHTML = '<tr><th>Job</th><th>Schedule</th><th>Last run</th><th>Next</th><th>Status</th></tr>' +
    enabled.map(c => {
      const st = c.consecutive_errors > 0 ? chip('err Ã—'+c.consecutive_errors,'bad')
               : c.last_status === 'ok' ? chip('ok','ok')
               : c.last_status === 'error' ? chip('err','bad')
               : chip(c.last_status||'â€”','muted');
      const lastRun = c.last_run ? timeAgoMs(Date.now() - c.last_run) : 'â€”';
      const nextRun = c.next_run ? timeAgoMs(c.next_run - Date.now()).replace(' ago','') : 'â€”';
      const nextStr = c.next_run && c.next_run > Date.now() ? 'in ' + nextRun : nextRun;
      const dur = c.last_duration_ms ? (c.last_duration_ms > 60000 ? Math.round(c.last_duration_ms/60000)+'m' : Math.round(c.last_duration_ms/1000)+'s') : '';
      return `<tr>
        <td style="font-size:11px">${esc(c.name||c.id)}</td>
        <td class="muted cron-schedule" style="font-size:10px;font-family:monospace">${esc(c.schedule||'â€”')}</td>
        <td class="muted cron-last" style="font-size:10px;white-space:nowrap">${lastRun}${dur?' <span style="opacity:.5">('+dur+')</span>':''}</td>
        <td class="muted cron-next" style="font-size:10px;white-space:nowrap">${nextStr}</td>
        <td>${st}</td>
      </tr>`;
    }).join('');
  // Show disabled count
  const disabled = crons.filter(c => c.enabled === false).length;
  if (disabled) el.innerHTML += `<tr><td colspan="5" class="muted" style="font-size:10px;padding-top:6px">+ ${disabled} disabled jobs</td></tr>`;
}

function renderHeartbeat(hb, log) {
  const checks = hb?.lastChecks || {};
  const notes = checks.notes || null;
  const entries = Object.entries(checks).filter(([k]) => k !== 'notes');
  document.getElementById('hb-grid').innerHTML = entries.map(([k,v])=>{
    let display = String(v);
    if (typeof v === 'number' && v > 1000000000) display = timeAgoMs(Date.now() - v * 1000);
    // colour-code known status fields
    let valClass = '';
    const vl = display.toLowerCase();
    if (/^ok$|running|healthy|clean|active/.test(vl)) valClass = 'ok';
    else if (/error|fail|down|critical/.test(vl)) valClass = 'bad';
    else if (/warn|timeout|pending/.test(vl)) valClass = 'warn';
    return `<div class="hb-item"><div class="hb-key">${esc(k)}</div><div class="hb-val ${valClass}">${esc(display)}</div></div>`;
  }).join('') || '<span class="muted">No data.</span>';
  if (notes) {
    const notesEl = document.getElementById('hb-notes');
    if (notesEl) { notesEl.style.display = 'block'; notesEl.textContent = notes; }
  }
  const lb = document.getElementById('supervisor-log');
  lb.innerHTML = (log||[]).map(line => {
    const el = line.toLowerCase();
    if (/error|fail|critical/.test(el)) return `<span class="log-err">${esc(line)}</span>`;
    if (/warn|alert/.test(el)) return `<span class="log-warn">${esc(line)}</span>`;
    return esc(line);
  }).join('\n') || 'No supervisor log.';
  lb.scrollTop = lb.scrollHeight;
}

function renderAgentDetail(agents) {
  document.getElementById('agent-detail-table').innerHTML =
    '<colgroup><col style="width:22%"><col style="width:14%"><col style="width:18%"><col style="width:46%"></colgroup>' +
    '<tr><th>Agent</th><th>Status</th><th>Last Run</th><th>Last Log</th></tr>' +
    (agents||[]).map(a=>`<tr>
      <td title="${esc(a.name)}"><strong>${esc(a.name)}</strong></td>
      <td>${a.active?chip('active','ok'):chip('idle','muted')}</td>
      <td class="muted">${(()=>{const ts=a.last_run_ts?a.last_run_ts*1000:parseAgentTs(a.last_run);return ts?timeAgoMs(Date.now()-ts):esc(a.last_run||'â€”');})()}</td>
      <td class="muted" title="${esc(a.last_line)}">${esc(a.last_line||'â€”')}</td>
    </tr>`).join('');
}

function renderActiveTasks(tasks) {
  const el = document.getElementById('active-tasks-list');
  if (!el) return;
  if (!tasks || !tasks.length) {
    el.innerHTML = '<span class="muted">No active tasks.</span>';
    return;
  }
  el.innerHTML = tasks.map(t => {
    const st = t.status === 'running' ? chip('running','ok')
             : t.status === 'validated' ? chip('validated','ok')
             : t.status === 'failed' ? chip('failed','bad')
             : chip(t.status||'?','muted');
    return `<div style="margin-bottom:8px;padding:8px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px">
        ${st} <strong style="font-size:12px">${esc(t.agent||'?')}</strong>
        <span class="muted" style="font-size:10px">${esc(t.session_key||'')}</span>
      </div>
      <div style="font-size:11px;color:var(--muted)">${esc(t.goal||'')}</div>
      ${t.started ? `<div style="font-size:10px;color:var(--muted);margin-top:2px">Started ${esc(t.started)}</div>` : ''}
    </div>`;
  }).join('');
}
function parseOutputTs(ts) {
  // "2026-02-28-1000" â†’ Date
  if (!ts) return null;
  const m = ts.match(/^(\d{4})-(\d{2})-(\d{2})-(\d{2})(\d{2})$/);
  if (m) return new Date(`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:00Z`);
  return null;
}
function renderOutputs(outputs) {
  const el = document.getElementById('output-list');
  el.innerHTML = (outputs||[]).length === 0 ? '<span class="muted">No outputs.</span>' :
    (outputs||[]).map(o=>{
      const d = parseOutputTs(o.ts);
      const age = d ? timeAgoMs(Date.now() - d.getTime()) : (o.ts||'â€”');
      const kb = Math.round((o.size||0)/1024*10)/10;
      return `<div class="output-item">
        <div class="out-title">${esc(o.title||o.file)}</div>
        <div class="out-meta"><span>ğŸ“… ${age}</span><span class="muted">${kb}KB</span></div>
      </div>`;
    }).join('');
}

// â”€â”€ Tokens tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Projects tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProjects() {
  const el = document.getElementById('projects-grid');
  if (!el) return;
  el.innerHTML = '<div class="card" style="grid-column:1/-1"><span class="muted">Loading projects...</span></div>';
  
  if (projectsAbortController) projectsAbortController.abort();
  projectsAbortController = new AbortController();
  
  try {
    const res = await fetch('/api/projects', { signal: projectsAbortController.signal });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Failed to load projects');
    renderProjects(data.projects);
  } catch (e) {
    if (e.name === 'AbortError') return;
    el.innerHTML = `<div class="card" style="grid-column:1/-1"><span class="bad">Error: ${esc(e.message)}</span></div>`;
  } finally {
    projectsAbortController = null;
  }
}

function renderProjects(projects) {
  const el = document.getElementById('projects-grid');
  if (!el) return;
  
  el.innerHTML = (projects || []).map(p => {
    const statusChip = p.status === 'active' ? chip('active', 'ok') : chip('idle', 'muted');
    const commitInfo = p.lastCommit
      ? `<div style="font-size:10px;color:var(--muted);margin-top:4px;font-family:monospace">
           <span>${esc(p.lastCommit?.hash?.slice(0,7) || "??????")}</span> ${esc(p.lastCommit?.message || 'No message')}
         </div>`
      : '<div class="muted" style="font-size:10px;margin-top:4px">No commits yet</div>';
    
    return `<div class="card" style="grid-column:1/-1">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <div style="font-size:32px;flex-shrink:0">${p.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px">
            <strong style="font-size:14px">${esc(p.name)}</strong>
            ${statusChip}
          </div>
          <div style="font-size:11px;color:var(--muted);margin:4px 0">${esc(p.description)}</div>
          ${commitInfo}
          <div style="display:flex;gap:8px;margin-top:8px">
            <a href="https://github.com/defmarshal/defmarshal-workspace/tree/main/${encodeURIComponent(p.path)}" aria-label="View ${esc(p.name)} code on GitHub" 
               target="_blank" rel="noopener"
               style="background:var(--surface);color:var(--text);text-decoration:none;padding:4px 10px;border-radius:6px;font-size:11px;border:1px solid var(--border);transition:background .15s">View Code</a>
            ${p.status === 'active' ? `<span style="font-size:11px;color:var(--green)">â— Active work in progress</span>` : ''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('') || `<div class="card" style="grid-column:1/-1"><span class="muted">No projects found.</span></div>`;
  
  // Update badge
  const activeCount = (projects || []).filter(p => p.status === 'active').length;
  const badge = document.getElementById('badge-projects');
  if (badge) badge.textContent = activeCount > 0 ? `â—${activeCount}` : '';
}

// â”€â”€ Downloads tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let dlLoaded = false;
function fmtBytes(b) {
  if (b >= 1073741824) return (b/1073741824).toFixed(1) + ' GB';
  if (b >= 1048576)    return Math.round(b/1048576) + ' MB';
  return Math.round(b/1024) + ' KB';
}
async function loadDownloads() {
  if (dlLoaded) return;
  const list = document.getElementById('dl-list');
  const sumEl = document.getElementById('dl-summary');
  list.innerHTML = '<span class="muted">Loadingâ€¦</span>';
  try {
    const d = await fetch('/api/downloads-list').then(r => r.json());
    if (!d.ok || !d.files.length) {
      list.innerHTML = '<span class="muted">No downloads found.</span>';
      return;
    }
    dlLoaded = true;
    sumEl.textContent = `${d.files.length} file(s) Â· ${fmtBytes(d.total)} total`;
    list.innerHTML = d.files.map((f,i) => `
      <div id="dl-row-${i}" style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)">
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(f.path)}">${esc(f.name)}</div>
          <div style="font-size:10px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(f.path.includes('/') ? f.path.split('/').slice(0,-1).join('/') : '')}</div>
        </div>
        <span style="font-size:11px;color:var(--muted);flex-shrink:0;min-width:52px;text-align:right">${fmtBytes(f.size)}</span>
        <a href="/api/download/${encodeURIComponent(f.path)}" download="${esc(f.name)}"
           style="background:var(--blue);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;text-decoration:none;flex-shrink:0">â¬‡</a>
        <button onclick="deleteDl(this,${i},'${esc(f.path).replace(/'/g,"\\'")}')"
           style="background:none;border:1px solid var(--red);color:var(--red);border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;flex-shrink:0">ğŸ—‘</button>
      </div>`).join('');
  } catch(e) {
    list.innerHTML = `<span class="muted">Error: ${esc(e.message)}</span>`;
  }
}
async function deleteDl(btn, idx, filePath) {
  if (!confirm(`Delete: ${filePath}?`)) return;
  btn.disabled = true; btn.textContent = 'â€¦';
  try {
    const r = await fetch('/api/download/' + encodeURIComponent(filePath), { method: 'DELETE' });
    const d = await r.json();
    if (d.ok) {
      document.getElementById('dl-row-' + idx)?.remove();
      showToast('ğŸ—‘ Deleted ' + filePath.split('/').pop());
      const rows = document.querySelectorAll('#dl-list > div');
      if (rows.length === 0) {
        document.getElementById('dl-list').innerHTML = '<span class="muted">No downloads.</span>';
        document.getElementById('dl-summary').textContent = '';
      }
    } else {
      showToast('âŒ ' + (d.error||'delete failed'));
      btn.disabled = false; btn.textContent = 'ğŸ—‘';
    }
  } catch(e) {
    showToast('âŒ ' + e.message);
    btn.disabled = false; btn.textContent = 'ğŸ—‘';
  }
}

let tokensLoaded = false;
async function loadTokens() {
  if (tokensLoaded) return;
  try {
    const d = await fetch('/api/tokens').then(r => r.json());
    tokensLoaded = true;
    renderTokens(d);
  } catch (e) {
    const tbody = document.getElementById('tokens-tbody');
    if (tbody) tbody.innerHTML = `<tr><td colspan="6" style="color:var(--red);padding:8px">Error: ${esc(e.message)}</td></tr>`;
  }
}
function fmtK(n) {
  n = n || 0;
  if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(1) + 'k';
  return String(n);
}
function renderTokens(d) {
  const summary = document.getElementById('tokens-summary');
  const tbody   = document.getElementById('tokens-tbody');
  const empty   = document.getElementById('tokens-empty');
  if (!tbody) return;

  if (!d.ok || !d.rows || !d.rows.length) {
    if (empty) empty.style.display = 'block';
    return;
  }

  // Summary cards
  if (summary) {
    const weekTotal = d.week?.total || 0;
    const weekIn    = d.week?.total_in || 0;
    const weekOut   = d.week?.total_out || 0;
    summary.innerHTML = `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;min-width:120px">
        <div style="font-size:10px;color:var(--muted);margin-bottom:4px">ğŸ“… WEEK TOTAL</div>
        <div style="font-size:20px;font-weight:700;color:var(--blue)">${fmtK(weekTotal)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${fmtK(weekIn)} in Â· ${fmtK(weekOut)} out</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;min-width:120px">
        <div style="font-size:10px;color:var(--muted);margin-bottom:4px">ğŸ¤– JOBS TRACKED</div>
        <div style="font-size:20px;font-weight:700;color:var(--green)">${d.rows.length}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">last 7 days</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;min-width:120px">
        <div style="font-size:10px;color:var(--muted);margin-bottom:4px">ğŸ” TOP JOB</div>
        <div style="font-size:13px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(d.rows[0]?.name||'â€”')}">${esc(d.rows[0]?.name||'â€”')}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${fmtK(d.rows[0]?.total||0)} tokens</div>
      </div>`;
  }

  // Table
  const maxTotal = d.rows[0]?.total || 1;
  const now = Date.now();
  tbody.innerHTML = d.rows.map((row, i) => {
    const pct = Math.round((row.total / maxTotal) * 100);
    const lastAgo = row.last_run_ms ? fmtDuration(now - row.last_run_ms) + ' ago' : 'â€”';
    const barColor = i === 0 ? 'var(--blue)' : i < 3 ? 'var(--green)' : 'var(--muted)';
    return `<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:4px 6px;font-size:10px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(row.name)}">${esc(row.name)}</td>
      <td style="padding:4px 6px;font-size:10px;text-align:right;color:var(--muted)">${row.runs}</td>
      <td style="padding:4px 6px;font-size:10px;text-align:right">${fmtK(row.avg_tokens)}</td>
      <td style="padding:4px 6px;font-size:10px;text-align:right;font-weight:600">${fmtK(row.total)}</td>
      <td style="padding:4px 6px;font-size:10px;min-width:80px">
        <div style="background:var(--surface2);border-radius:3px;height:6px;position:relative;overflow:hidden">
          <div style="background:${barColor};height:100%;width:${pct}%;border-radius:3px;transition:width .3s"></div>
        </div>
        <span style="font-size:9px;color:var(--muted)">${pct}%</span>
      </td>
      <td style="padding:4px 6px;font-size:10px;text-align:right;color:var(--muted);white-space:nowrap">${lastAgo}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ Cron tab (full job list) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCronTab(crons) {
  const list = document.getElementById('cron-tab-list');
  const summary = document.getElementById('cron-tab-summary');
  if (!list) return;
  if (!crons || !crons.length) { list.innerHTML = '<p style="color:var(--muted);font-size:12px">No cron jobs</p>'; return; }
  const ok = crons.filter(c => (c.consecutive_errors||0) === 0).length;
  if (summary) summary.textContent = `${crons.length} jobs Â· ${ok} healthy`;
  const statusChip = (c) => {
    if (c.consecutive_errors > 0) return `<span style="background:#3d1a1a;color:var(--red);font-size:9px;padding:1px 5px;border-radius:10px">âœ— errÃ—${c.consecutive_errors}</span>`;
    if (c.last_status === 'ok') return `<span style="background:#0d2818;color:var(--green);font-size:9px;padding:1px 5px;border-radius:10px">âœ“ ok</span>`;
    return `<span style="background:var(--surface2);color:var(--muted);font-size:9px;padding:1px 5px;border-radius:10px">â€”</span>`;
  };
  list.innerHTML = crons.map(c => `
    <div style="padding:8px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <span style="font-size:12px;font-weight:500;flex:1">${esc(c.name||c.id||'?')}</span>
        ${statusChip(c)}
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:3px;display:flex;gap:10px;flex-wrap:wrap">
        <span>ğŸ• ${esc(c.schedule||'?')}</span>
        ${c.last_run ? `<span>${fmtDuration(Date.now() - c.last_run)} ago</span>` : ''}
        ${c.next_run ? (() => {
          const diff = c.next_run - Date.now();
          return diff > 0
            ? `<span style="color:var(--blue)">in ${fmtDuration(diff)}</span>`
            : `<span style="color:var(--red)">${fmtDuration(-diff)} overdue</span>`;
        })() : ''}
        ${c.last_duration ? `<span>âš¡ ${c.last_duration}</span>` : ''}
      </div>
    </div>`).join('');
}

// â”€â”€ Torrent card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAndRenderTorrents() {
  const card = document.getElementById('torrent-card');
  if (!card || ON_VERCEL) return;
  try {
    const res = await fetch('/api/torrents');
    const d = await res.json();
    const all = [...(d.active||[]), ...(d.waiting||[])];
    const stopped = d.stopped || [];
    if (!all.length && !stopped.length) { card.innerHTML = '<p style="color:var(--muted);font-size:12px;padding:4px 0">No active downloads nyaa~</p>'; return; }
    const statusColor = s => s === 'active' ? 'var(--green)' : s === 'waiting' ? 'var(--yellow)' : 'var(--muted)';
    const bar = pct => `<div style="background:var(--border);border-radius:3px;height:4px;width:100%;margin:3px 0"><div style="background:var(--blue);border-radius:3px;height:4px;width:${Math.min(100,pct)}%"></div></div>`;
    card.innerHTML = all.map(t => `
      <div style="padding:6px 0;border-bottom:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <span style="font-size:12px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1" title="${esc(t.name)}">${esc(t.name)}</span>
          <span style="font-size:10px;color:${statusColor(t.status)};flex-shrink:0;font-weight:600">${t.status}</span>
        </div>
        ${bar(t.pct)}
        <div style="font-size:10px;color:var(--muted);display:flex;gap:10px">
          <span>${t.pct}%</span><span>${t.size}</span>
          ${t.speed_dn && t.speed_dn !== '0 B/s' ? `<span>â¬‡ ${t.speed_dn}</span>` : ''}
          ${t.seeders ? `<span>ğŸŒ± ${t.seeders}</span>` : ''}
        </div>
      </div>`).join('') +
      (stopped.length ? `<div style="font-size:10px;color:var(--muted);padding:5px 0">${stopped.length} recently completed</div>` : '');
  } catch(e) { if(document.getElementById('torrent-card')) document.getElementById('torrent-card').innerHTML = '<p style="color:var(--muted);font-size:11px">aria2 unavailable</p>'; }
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatData = [];
let lastChatLen = 0;
let chatSending = false; // suppress poll re-renders while message in flight

function renderChat(messages, preserve_scroll = false) {
  chatData = messages || [];
  document.getElementById('badge-chat').textContent = chatData.length > 99 ? '99+' : chatData.length;
  const container = document.getElementById('chat-messages');
  const atBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 60;

  if (!chatData.length) { container.innerHTML = '<div style="padding:32px 16px;text-align:center;color:var(--muted);font-size:13px">ğŸ’¬ No messages yet.<br><span style="font-size:11px">Send something below to start chatting with mewmew~</span></div>'; return; }
  let lastDate = null;
  container.innerHTML = chatData.map(m => {
    const role = m.role === 'user' ? 'user' : 'assistant';
    const label = role === 'user' ? 'ğŸ‘¤ def' : 'ğŸ¾ mewmew';
    let text = esc(m.text || '');
    // code blocks first (multiline)
    text = text.replace(/```[\s\S]*?```/g, b => {
      const code = b.slice(3, -3).replace(/^[a-z]+\n/, '');
      return '<pre style="background:#0a0d11;padding:8px;border-radius:6px;font-size:10px;overflow-x:auto;margin:4px 0;white-space:pre-wrap;color:#8b949e">' + code + '</pre>';
    });
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/`([^`\n]+)`/g, '<code style="background:#0a0d11;padding:1px 4px;border-radius:3px;font-size:10px;font-family:monospace">$1</code>');
    text = text.replace(/\n/g, '<br>');
    let sep = '';
    if (m.ts) {
      const d = new Date(m.ts).toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
      if (d !== lastDate) { lastDate = d; sep = `<div style="text-align:center;font-size:10px;color:var(--muted);padding:8px 0;user-select:none">${d}</div>`; }
    }
    const avatar = role === 'assistant'
      ? `<div class="msg-avatar">ğŸ¾</div>`
      : `<div class="msg-avatar">ğŸ‘¤</div>`;
    return sep + `<div class="msg ${role}">
      <div class="msg-row">${avatar}<div class="msg-bubble">${text}</div></div>
      <div class="msg-meta">${label} Â· ${fmtTime(m.ts)}</div>
    </div>`;
  }).join('');

  if (atBottom || !preserve_scroll) scrollChat();
  const newTotal = chatData.length;
  if (lastChatLen > 0 && newTotal > lastChatLen) {
    // Only play sound if the newest message is from assistant
    const newest = chatData[chatData.length - 1];
    if (newest && newest.role !== 'user') {
      removeTypingIndicator();
      playPopSound();
    } else {
      removeTypingIndicator();
    }
  }
  lastChatLen = newTotal;
}

function scrollChat() { const c = document.getElementById('chat-messages'); c.scrollTop = c.scrollHeight; }

function showTypingIndicator() {
  removeTypingIndicator();
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg assistant typing';
  div.id = 'typing-indicator';
  div.innerHTML = `<div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div><div class="msg-meta">ğŸ¾ mewmew</div>`;
  container.appendChild(div);
  scrollChat();
}
let _audioCtx = null;
function getAudioCtx() {
  if (!_audioCtx || _audioCtx.state === 'closed') {
    _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (_audioCtx.state === 'suspended') _audioCtx.resume();
  return _audioCtx;
}
// Unlock audio on first user gesture (Chrome policy)
document.addEventListener('click', () => { try { getAudioCtx(); } catch {} }, { once: true });
document.addEventListener('keydown', () => { try { getAudioCtx(); } catch {} }, { once: true });

function playPopSound() {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(1200, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.06);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.12);
  } catch {}
}

function removeTypingIndicator() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

// â”€â”€ Chat SSE (real-time) + polling fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatSSE = null;
function startChatPoll() {
  if (ON_VERCEL) return;
  // Try SSE first for instant updates
  if (!chatSSE || chatSSE.readyState === EventSource.CLOSED) {
    try {
      chatSSE = new EventSource('/api/chat-stream');
      chatSSE.onmessage = (e) => {
        if (chatSending) return;
        try {
          const d = JSON.parse(e.data);
          if (d.chat) renderChat(d.chat, true);
        } catch {}
      };
      chatSSE.onerror = () => {
        // SSE failed, fall back to polling
        chatSSE.close();
        if (!chatPollTimer) chatPollTimer = setInterval(refreshChat, 5000);
      };
      chatSSE.onopen = () => {
        // SSE connected â€” stop polling if running
        if (chatPollTimer) { clearInterval(chatPollTimer); chatPollTimer = null; }
      };
    } catch {
      if (!chatPollTimer) chatPollTimer = setInterval(refreshChat, 5000);
    }
  }
}
function stopChatPoll() {
  if (chatPollTimer) { clearInterval(chatPollTimer); chatPollTimer = null; }
  if (chatSSE) { chatSSE.close(); chatSSE = null; }
}
async function refreshChat() {
  if (chatSending) return;
  try {
    const res = await fetch('/api/chat');
    if (!res.ok) return;
    const data = await res.json();
    renderChat(data.chat, true);
  } catch {}
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
  const len = chatInput.value.length;
  const counter = document.getElementById('chat-char-count');
  if (counter) {
    counter.textContent = len > 0 ? len + ' chars' : '';
    counter.style.opacity = len > 200 ? '1' : '0.5';
  }
});
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  if (e.key === 'Escape') { chatInput.value = ''; chatInput.style.height = 'auto'; }
});
sendBtn.addEventListener('click', sendMessage);

async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  if (ON_VERCEL) {
    showError('Chat send requires the local backend. Open http://100.108.208.45:3001 instead of the Vercel URL.');
    return;
  }

  chatInput.value = '';
  chatInput.style.height = 'auto';
  sendBtn.disabled = true;
  sendBtn.textContent = 'â³';
  chatSending = true;

  const container = document.getElementById('chat-messages');
  const tempId = 'msg-' + Date.now();
  const div = document.createElement('div');
  div.className = 'msg user sending';
  div.id = tempId;
  div.innerHTML = `<div class="msg-bubble">${esc(text)}</div><div class="msg-meta">ğŸ‘¤ def Â· sendingâ€¦</div>`;
  container.appendChild(div);
  scrollChat();

  try {
    const res = await fetch('/api/send', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({message: text}) });
    const data = await res.json();
    const el = document.getElementById(tempId);
    if (el) {
      el.classList.remove('sending');
      el.querySelector('.msg-meta').textContent = 'ğŸ‘¤ def Â· ' + new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    }
    sendBtn.textContent = 'Send â†‘';
    toast('âœ… Message sent', 'ok', 2000);
    showTypingIndicator();
    // Poll until a NEW assistant message appears after sentAt (max 3 min)
    const sentAt = Date.now();
    // Use timestamp of last known assistant msg as baseline (immune to sliding window)
    const asstMsgs = chatData.filter(m => m.role !== 'user');
    const lastAsstTs = asstMsgs.length ? new Date(asstMsgs[asstMsgs.length - 1].ts).getTime() : 0;
    
    // Clear any existing watcher to avoid leaks
    if (chatReplyWatcher) { clearInterval(chatReplyWatcher); chatReplyWatcher = null; }
    
    chatReplyWatcher = setInterval(async () => {
      try {
        const r = await fetch('/api/chat');
        if (!r.ok) return;
        const d = await r.json();
        const msgs = d.chat || [];
        // Look for any assistant msg newer than the last one we knew about
        const newAsst = msgs.filter(m => m.role !== 'user' && new Date(m.ts).getTime() > lastAsstTs);
        const timedOut = Date.now() - sentAt > 180000;
        if (newAsst.length > 0 || timedOut) {
          clearInterval(chatReplyWatcher);
          chatReplyWatcher = null;
          chatSending = false;
          removeTypingIndicator();
          renderChat(msgs, true);
        }
      } catch {}
    }, 3000);
  } catch (e) {
    chatSending = false;
    const el = document.getElementById(tempId);
    if (el) el.querySelector('.msg-bubble').style.borderColor = 'var(--red)';
    sendBtn.textContent = 'Send â†‘';
    toast('âŒ Send failed: ' + e.message, 'bad');
  }
  sendBtn.disabled = false;
  if (sendBtn.textContent === 'â³') sendBtn.textContent = 'Send â†‘';
}

// â”€â”€ Quick commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const QUICK_CMDS = [
  { label: 'ğŸ¥ health',         cmd: 'health' },
  { label: 'ğŸ“Š status',         cmd: 'status' },
  { label: 'ğŸ¤– agents',         cmd: 'agents-summary' },
  { label: 'ğŸ’¾ memory status',  cmd: 'memory-status' },
  { label: 'ğŸ“ git today',      cmd: 'git-today' },
  { label: 'ğŸ“ git last',       cmd: 'git-last' },
  { label: 'ğŸ• today',          cmd: 'today' },
  { label: 'ğŸ“‹ digest',         cmd: 'digest' },
  { label: 'ğŸ“¥ downloads',      cmd: 'downloads' },
  { label: 'ğŸ” cron status',    cmd: 'cron-status' },
  { label: 'âš ï¸ cron failures',  cmd: 'cron-failures' },
  { label: 'ğŸ›¡ï¸ hygiene',        cmd: 'hygiene' },
  { label: 'ğŸ“Œ checkpoints',    cmd: 'checkpoints' },
  { label: 'ğŸ” orphan check',   cmd: 'orphan-check' },
  { label: 'ğŸ“¡ gateway info',   cmd: 'gateway-info' },
  { label: 'ğŸŒŠ supervisor log', cmd: 'supervisor-logs' },
  { label: 'ğŸ“ˆ meta report',    cmd: 'meta-report' },
  { label: 'ğŸ”„ updates check',  cmd: 'updates-check' },
  { label: 'ğŸ’¡ meta logs',       cmd: 'meta-logs' },
  { label: 'ğŸ”¬ validate',        cmd: 'validate' },
];

function buildQuickList() {
  const el = document.getElementById('quick-list');
  el.innerHTML = QUICK_CMDS.map(q => `<button class="quick-btn" data-cmd="${esc(q.cmd)}">${esc(q.label)}</button>`).join('');
  el.querySelectorAll('.quick-btn').forEach(btn => btn.addEventListener('click', () => runQuick(btn.dataset.cmd)));
}

async function runQuick(cmd) {
  const resultEl = document.getElementById('quick-result');
  const labelEl  = document.getElementById('quick-cmd-label');
  if (ON_VERCEL) {
    labelEl.textContent = 'âš ï¸ ' + cmd;
    resultEl.textContent = 'Requires local backend.\nOpen http://100.108.208.45:3001';
    return;
  }
  labelEl.textContent = 'â³ ' + cmd;
  resultEl.textContent = 'Runningâ€¦';
  try {
    const res = await fetch('/api/quick', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cmd}) });
    const data = await res.json();
    labelEl.textContent = 'âœ… ' + cmd;
    resultEl.textContent = data.output || '(no output)';
    resultEl.scrollTop = 0;
    toast('âœ… ' + cmd, 'ok', 2000);
  } catch (e) {
    labelEl.textContent = 'âŒ ' + cmd;
    resultEl.textContent = 'Error: ' + e.message;
    toast('âŒ ' + cmd + ' failed', 'bad');
  }
}
function clearQuickResult() {
  document.getElementById('quick-result').textContent = '';
  document.getElementById('quick-cmd-label').textContent = 'output';
}

// â”€â”€ Command palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const overlay  = document.getElementById('palette-overlay');
const palInput = document.getElementById('palette-input');
const palList  = document.getElementById('palette-list');
let palSel = 0;

function openPalette() {
  overlay.classList.add('open');
  palInput.value = '';
  palSel = 0;
  renderPalette('');
  palInput.focus();
}
function closePalette() { overlay.classList.remove('open'); }

function renderPalette(q) {
  const items = QUICK_CMDS.filter(c => !q || c.label.toLowerCase().includes(q.toLowerCase()) || c.cmd.includes(q.toLowerCase()));
  palList.innerHTML = items.map((c, i) => `<div class="palette-item${i===palSel?' sel':''}" data-cmd="${esc(c.cmd)}">${esc(c.label)}<span class="palette-shortcut">â†µ run</span></div>`).join('');
  palList.querySelectorAll('.palette-item').forEach(el => el.addEventListener('click', () => { closePalette(); runQuickAndSwitch(el.dataset.cmd); }));
}

function runQuickAndSwitch(cmd) {
  switchTab('chat');
  runQuick(cmd);
}

palInput.addEventListener('input', () => { palSel = 0; renderPalette(palInput.value); });
palInput.addEventListener('keydown', e => {
  const items = palList.querySelectorAll('.palette-item');
  if (e.key === 'ArrowDown') { palSel = Math.min(palSel+1, items.length-1); renderPalette(palInput.value); }
  else if (e.key === 'ArrowUp') { palSel = Math.max(palSel-1, 0); renderPalette(palInput.value); }
  else if (e.key === 'Enter') { const sel = palList.querySelector('.sel'); if (sel) { closePalette(); runQuickAndSwitch(sel.dataset.cmd); } }
  else if (e.key === 'Escape') closePalette();
});
overlay.addEventListener('click', e => { if (e.target === overlay) closePalette(); });
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); overlay.classList.contains('open') ? closePalette() : openPalette(); }
  if (e.key === 'Escape' && overlay.classList.contains('open')) closePalette();
});

// â”€â”€ Push Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pushSubscribed = false;

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const raw = atob(base64);
  return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}

async function setupPush() {
  if (ON_VERCEL) { toast('Push requires local backend', 'bad'); return; }
  if (!('serviceWorker' in navigator)) { toast('âŒ Service worker not supported', 'bad'); return; }
  if (!('PushManager' in window)) { toast('âŒ Push not supported on this browser', 'bad'); return; }
  try {
    toast('â³ Setting up pushâ€¦', 'ok', 2000);

    const res = await fetch('/api/vapid-key');
    const { publicKey } = await res.json();
    if (!publicKey) { toast('âŒ No VAPID key from server', 'bad'); return; }

    // Unregister ALL service workers to clear any stale VAPID subscription
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) { try { await r.unregister(); } catch {} }

    // Re-register fresh SW
    const reg = await navigator.serviceWorker.register('/sw.js');
    // Wait for SW to fully activate
    await new Promise((resolve) => {
      const sw = reg.installing || reg.waiting || reg.active;
      if (reg.active) { resolve(); return; }
      const onchange = () => { if (reg.active) { resolve(); } };
      reg.addEventListener('updatefound', () => {
        reg.installing.addEventListener('statechange', onchange);
      });
      setTimeout(resolve, 3000); // fallback
    });
    await navigator.serviceWorker.ready;
    await new Promise(r => setTimeout(r, 800));

    const perm = await Notification.requestPermission();
    if (perm !== 'granted') { toast('âŒ Notification permission denied', 'bad'); return; }

    let sub = null;

    // pushManager.subscribe can fail with "Registration failed - push service error"
    // This is usually a temporary FCM/network issue. Retry up to 3x with backoff.
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey),
        });
        break;
      } catch (subErr) {
        if (attempt < 3) {
          toast(`â³ Push service busy, retrying (${attempt}/3)â€¦`, 'ok', 2000);
          await new Promise(r => setTimeout(r, 2000 * attempt));
          // Re-acquire SW registration on retry
          await navigator.serviceWorker.ready;
        } else {
          throw new Error('Push service unavailable after 3 tries. Try clearing browser cache or check Tailscale connection. (' + subErr.message + ')');
        }
      }
    }

    const saveRes = await fetch('/api/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sub.toJSON()),
    });
    if (!saveRes.ok) { toast('âŒ Failed to save subscription', 'bad'); return; }

    pushSubscribed = true;
    updatePushBtn(true);
    const banner = document.getElementById('push-banner');
    if (banner) banner.style.display = 'none';
    toast('ğŸ”” Push enabled! Sending testâ€¦', 'ok', 3000);

    // Send a test push so user confirms it works
    fetch('/api/notify-test', { method: 'POST' });
  } catch (e) {
    let msg = e.message || String(e);
    if (msg.includes('push service')) msg = 'âŒ Push service error â€” try again in 30s or clear site data';
    else if (msg.includes('permission')) msg = 'âŒ Notification permission denied';
    else if (msg.includes('network')) msg = 'âŒ Network error â€” check Tailscale connection';
    else msg = 'âŒ Push failed: ' + msg;
    toast(msg, 'bad', 10000);
    console.error('Push setup failed:', e);
  }
}

async function togglePush() {
  if (ON_VERCEL) { toast('Push requires local backend (HTTPS)', 'bad'); return; }
  if (pushSubscribed) {
    // Unsubscribe
    try {
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();
      if (sub) await sub.unsubscribe();
      pushSubscribed = false;
      updatePushBtn(false);
      toast('ğŸ”• Push notifications disabled', 'ok', 2000);
    } catch {}
  } else {
    await setupPush();
  }
}

function updatePushBtn(enabled) {
  const btn = document.getElementById('push-btn');
  if (!btn) return;
  btn.textContent = enabled ? 'ğŸ””' : 'ğŸ”•';
  btn.title = enabled ? 'Push notifications ON â€” click to disable' : 'Enable push notifications';
  btn.style.color = enabled ? 'var(--green)' : '';
}
let loadErrors = 0;
async function load() {
  document.getElementById('conn-dot').className = 'warn';
  document.getElementById('last-updated').textContent = 'â€¦';
  try {
    let data;
    if (!ON_VERCEL) {
      try {
        const res = await fetch('/api/data', { signal: AbortSignal.timeout(8000) });
        if (res.ok) {
          data = await res.json();
          backendAvailable = true;
          document.getElementById('backend-status').textContent = 'âš¡ live';
          document.getElementById('backend-status').className = 'ok';
        }
      } catch {}
    }
    if (!data) {
      const res = await fetch('/data.json?bust=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      data = await res.json();
      backendAvailable = false;
      document.getElementById('backend-status').textContent = ON_VERCEL ? 'ğŸ“¦ static (open :3001 for live)' : 'ğŸ“¦ static';
      document.getElementById('backend-status').className = 'bad';
    }

    renderSystem(data);
    renderAgentSummary(data.agents);
    renderResearch(data.research);
    renderCommits(data.recent_commits);
    renderCron(data.cron_jobs);
    renderCronTab(data.cron_jobs);
    renderContentStats(data.content_stats);
    renderHeartbeat(data.heartbeat, data.supervisor_log);
    renderAgentDetail(data.agents);
    renderOutputs(data.agent_outputs);
    renderActiveTasks(data.active_tasks);
    if (!chatSending) renderChat(data.chat || [], true);
    loadAndRenderTorrents();
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    document.getElementById('error-banner').style.display = 'none';
    document.getElementById('conn-dot').className = '';
    loadErrors = 0;
  } catch (e) {
    loadErrors++;
    document.getElementById('conn-dot').className = loadErrors > 1 ? 'bad' : 'warn';
    showError('Load failed: ' + e.message);
  }
}

function showError(msg) {
  const b = document.getElementById('error-banner');
  b.textContent = 'âš ï¸ ' + msg;
  b.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', () => {
  buildQuickList();
  // Handle ?tab= from manifest shortcuts
  const urlTab = new URLSearchParams(window.location.search).get('tab');
  switchTab(urlTab || activeTab);
  load();
  setInterval(load, 60000);
  setInterval(() => {
    const el = document.getElementById('last-updated');
    if (el) el.textContent = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  }, 60000);
  if (ON_VERCEL) {
    chatInput.placeholder = 'Chat requires local backend â€” open https://instance-20260207-2229.tail2dd22b.ts.net:8443';
    chatInput.disabled = true;
    sendBtn.disabled = true;
  }
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(async reg => {
      console.log('SW registered', reg.scope);
      // Check if already subscribed
      if (!ON_VERCEL) {
        const sub = await reg.pushManager.getSubscription().catch(() => null);
        if (sub) {
          pushSubscribed = true;
          updatePushBtn(true);
          const banner = document.getElementById('push-banner');
          if (banner) banner.style.display = 'none';
        }
      }
    }).catch(e => console.warn('SW failed', e));
  }
});

// â”€â”€ Quick sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildQuickSheet() {
  const list = document.getElementById('quick-sheet-list');
  if (!list || list.children.length) return;
  QUICK_CMDS.forEach(({label, cmd}) => {
    const btn = document.createElement('button');
    btn.className = 'qs-btn';
    btn.textContent = label;
    btn.onclick = () => runQuickSheet(cmd, label);
    list.appendChild(btn);
  });
}
function openQuickSheet() {
  buildQuickSheet();
  document.getElementById('quick-sheet-overlay').classList.add('open');
  const sheet = document.getElementById('quick-sheet');
  sheet.classList.add('open');
  // Swipe down to close
  let startY = 0;
  sheet.ontouchstart = e => { startY = e.touches[0].clientY; };
  sheet.ontouchmove = e => { if (e.touches[0].clientY - startY > 60) closeQuickSheet(); };
}
function closeQuickSheet() {
  document.getElementById('quick-sheet-overlay').classList.remove('open');
  document.getElementById('quick-sheet').classList.remove('open');
}
async function runQuickSheet(cmd, label) {
  const wrap = document.getElementById('quick-sheet-result-wrap');
  const result = document.getElementById('quick-sheet-result');
  const lbl = document.getElementById('qs-result-label');
  wrap.style.display = 'block';
  lbl.textContent = 'â³ ' + label;
  result.textContent = 'Runningâ€¦';
  try {
    const res = await fetch('/api/quick', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({cmd}) });
    const data = await res.json();
    lbl.textContent = 'âœ… ' + label;
    result.textContent = data.output || '(no output)';
    result.scrollTop = 0;
  } catch (e) {
    lbl.textContent = 'âŒ ' + label;
    result.textContent = 'âŒ ' + e.message;
  }
}


// ============ THEME TOGGLE ============
(function() {
  const btn = document.getElementById('theme-btn');
  if (!btn) return;

  function getCurrentTheme() {
    return localStorage.getItem('clawdash-theme') || 'kawaii';
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('clawdash-theme', theme);
    btn.textContent = theme === 'kawaii' ? 'ğŸŒˆ' : 'ğŸŒ™';
  }

  applyTheme(getCurrentTheme());

  btn.addEventListener('click', () => {
    const next = getCurrentTheme() === 'kawaii' ? 'pro' : 'kawaii';
    applyTheme(next);
    playSound('toggle');
})();
})();

// ============ SOUND SYSTEM ============
let soundCtx = null;
let audioInitialized = false;
const soundEnabled = localStorage.getItem('clawdash-sounds') !== 'false'; // default on

function getSoundCtx() {
  if (!soundCtx) {
    soundCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (soundCtx.state === 'suspended') {
    soundCtx.resume().catch(() => {});
  }
  return soundCtx;
}

function initAudioOnGesture() {
  if (audioInitialized) return;
  getSoundCtx();
  audioInitialized = true;
}

function playSound(type) {
  if (!soundEnabled) return;
  // Ensure audio context is created (may need user gesture)
  const ctx = getSoundCtx();
  
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  
  switch(type) {
    case 'click':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 0.05);
      break;
    case 'success':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(523, ctx.currentTime); // C5
      osc.frequency.linearRampToValueAtTime(659, ctx.currentTime + 0.1); // E5
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
      osc.start();
      osc.stop(ctx.currentTime + 0.3);
      break;
    case 'toggle':
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(440, ctx.currentTime);
      gain.gain.setValueAtTime(0.08, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 0.08);
      break;
  }
}

// Initialize audio on first user interaction (click, keypress)
function ensureAudioInit() {
  if (!audioInitialized) {
    initAudioOnGesture();
    document.removeEventListener('click', ensureAudioInit);
    document.removeEventListener('keydown', ensureAudioInit);
  }
}
document.addEventListener('click', ensureAudioInit, { once: true });
document.addEventListener('keydown', ensureAudioInit, { once: true });
// ============ ACHIEVEMENTS SYSTEM ============
const ACHIEVEMENTS = {
  first_commit: { icon: 'ğŸŒŸ', name: 'First Commit', desc: 'Made your first commit' },
  game_enhancer: { icon: 'ğŸ®', name: 'Game Enhancer', desc: 'Ran the game enhancer agent' },
  qwen_coder: { icon: 'ğŸ¤–', name: 'Qwen Coder', desc: 'Used Qwen Code for coding' },
  gemini_researcher: { icon: 'ğŸ”', name: 'Gemini Researcher', desc: 'Used Gemini for research' },
  projects_tab: { icon: 'ğŸ“‚', name: 'Project Manager', desc: 'Opened the Projects tab' },
  kawaii_mode: { icon: 'ğŸ€', name: 'Kawaii Fan', desc: 'Enabled kawaii theme' },
  thousand_messages: { icon: 'ğŸ’¬', name: 'Chatty', desc: 'Sent 1000 messages' },
  streak_7: { icon: 'ğŸ”¥', name: '7-Day Streak', desc: '7 consecutive days active' },
};

function loadAchievements() {
  const earned = JSON.parse(localStorage.getItem('clawdash-achievements') || '[]');
  const panel = document.getElementById('achievements-panel');
  if (!panel) return;
  
  const grid = panel.querySelector('.achievements-grid');
  grid.innerHTML = '';
  
  Object.entries(ACHIEVEMENTS).forEach(([key, ach]) => {
    const unlocked = earned.includes(key);
    const badge = document.createElement('div');
    badge.className = `achievement-badge ${unlocked ? 'unlocked' : ''}`;
    badge.innerHTML = `
      ${ach.icon}
      <div class="tooltip">${ach.name}: ${ach.desc}</div>
    `;
    badge.title = unlocked ? ach.name : '???';
    grid.appendChild(badge);
  });
}

function unlockAchievement(key) {
  const earned = JSON.parse(localStorage.getItem('clawdash-achievements') || '[]');
  if (!earned.includes(key)) {
    earned.push(key);
    localStorage.setItem('clawdash-achievements', JSON.stringify(earned));
    playSound('success');
    loadAchievements();
    // Could also trigger a toast notification
  }
}

// Track some achievements
if (!localStorage.getItem('clawdash-achievements-initialized')) {
  unlockAchievement('kawaii_mode'); // for enabling kawaii theme
  localStorage.setItem('clawdash-achievements-initialized', 'true');
}

// ============ MASCOT ============
(function() {
  const sidebar = document.getElementById('mascot-sidebar');
  const toggle = document.getElementById('mascot-toggle');
  const bubble = document.getElementById('mascot-bubble');
  if (!sidebar || !toggle || !bubble) return;
  
  // Random phrases
  const phrases = [
    'Nya~!', 'Hello!', 'Ready to help!', 'Kawaii desu!', 'Mew!',
    'You got this!', 'Anime power!', 'Let\'s go!', 'Yay!', 'Desu!'
  ];
  
  let bubbleTimeout;
  sidebar.addEventListener('mouseenter', () => {
    bubble.textContent = phrases[Math.floor(Math.random() * phrases.length)];
  });
  
  toggle.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    playSound('toggle');
  });
})();

// ============ INIT ============
// Load achievements on start
document.addEventListener('DOMContentLoaded', () => {
  // Add achievements panel to header (must create before loadAchievements)
  const header = document.querySelector('header .header-right');
  if (header) {
    const achBtn = document.createElement('button');
    achBtn.className = 'theme-toggle';
    achBtn.title = 'Achievements';
    achBtn.innerHTML = 'ğŸ†';
    achBtn.onclick = () => {
      const panel = document.getElementById('achievements-panel');
      if (panel) panel.classList.toggle('visible');
      playSound('toggle');
    };
    header.appendChild(achBtn);
    
    const achPanel = document.createElement('div');
    achPanel.id = 'achievements-panel';
    achPanel.className = 'achievements-panel';
    achPanel.innerHTML = `
      <div class="achievements-header">
        <h3>ğŸ† Achievements</h3>
        <button onclick="document.getElementById('achievements-panel').classList.remove('visible')" style="background:none;border:none;color:var(--text);cursor:pointer">âœ•</button>
      </div>
      <div class="achievements-grid"></div>
    `;
    document.body.appendChild(achPanel);
  }
  
  // Now load achievements (panel exists)
  loadAchievements();
});

</script>
</body>
</html>
